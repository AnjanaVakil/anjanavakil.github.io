<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Javaå¹¶å‘-JUC - Anjana</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Anjana" />
  <meta name="description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.93.0" />


<link rel="canonical" href="https://anjanavakil.github.io/post/juc/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css" integrity="sha256-&#43;ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Javaå¹¶å‘-JUC" />
<meta property="og:description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anjanavakil.github.io/post/juc/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-01T08:15:48+08:00" />
<meta property="article:modified_time" content="2022-08-01T08:15:48+08:00" />

<meta itemprop="name" content="Javaå¹¶å‘-JUC">
<meta itemprop="description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight"><meta itemprop="datePublished" content="2022-08-01T08:15:48+08:00" />
<meta itemprop="dateModified" content="2022-08-01T08:15:48+08:00" />
<meta itemprop="wordCount" content="45332">
<meta itemprop="keywords" content="Javaâ˜•ï¸,CSğŸ’»," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Javaå¹¶å‘-JUC"/>
<meta name="twitter:description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Anjana</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Anjana
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Javaå¹¶å‘-JUC</h1>
      
      <div class="post-meta">
        <time datetime="2022-08-01" class="post-time">
          2022-08-01
        </time>
        <div class="post-category">
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#package-javautilconcurrent-description">Package java.util.concurrent Description</a>
      <ul>
        <li><a href="#executors">Executors</a></li>
        <li><a href="#queues">Queues</a></li>
        <li><a href="#timing">Timing</a></li>
        <li><a href="#synchronizers">Synchronizers</a></li>
        <li><a href="#concurrent-collections">Concurrent Collections</a></li>
        <li><a href="#memory-consistency-properties">Memory Consistency Properties</a></li>
      </ul>
    </li>
    <li><a href="#çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a>
      <ul>
        <li><a href="#interface-executor">interface Executor</a></li>
        <li><a href="#interface-executorservice-extends-executor">interface ExecutorService extends Executor</a></li>
        <li><a href="#å…³é—­çº¿ç¨‹æ± ">å…³é—­çº¿ç¨‹æ± </a></li>
        <li><a href="#abstract-class-abstractexecutorservice-implements-executorservice">abstract class AbstractExecutorService implements ExecutorService</a></li>
        <li><a href="#class-threadpoolexecutor-extends-abstractexecutorservice">class ThreadPoolExecutor extends AbstractExecutorService</a></li>
        <li><a href="#rejectedexecutionhandlerrejectedexecution">RejectedExecutionHandler.rejectedExecution</a></li>
        <li><a href="#class-executors-å·¥å‚ç±»">class Executors å·¥å‚ç±»</a></li>
      </ul>
    </li>
    <li><a href="#futuretask">FutureTask</a></li>
    <li><a href="#completablefuture">CompletableFuture</a>
      <ul>
        <li><a href="#æ¡ˆä¾‹ç”µå•†ç½‘ç«™çš„æ¯”ä»·">æ¡ˆä¾‹â€”â€”ç”µå•†ç½‘ç«™çš„æ¯”ä»·</a></li>
        <li><a href="#completablefutureå¸¸ç”¨æ–¹æ³•">CompletableFutureå¸¸ç”¨æ–¹æ³•</a></li>
      </ul>
    </li>
    <li><a href="#é”">é”</a>
      <ul>
        <li><a href="#synchronized">synchronized</a></li>
        <li><a href="#lock">Lock</a></li>
        <li><a href="#synchronized-vs-lock">synchronized VS Lock</a></li>
        <li><a href="#reentrantlock">ReentrantLock</a></li>
        <li><a href="#reentrantlockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„">ReentrantLockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„</a></li>
        <li><a href="#synchronized-vs-reentrantlock">synchronized VS ReentrantLock</a></li>
        <li><a href="#æ‚²è§‚é”">æ‚²è§‚é”</a></li>
        <li><a href="#ä¹è§‚é”">ä¹è§‚é”</a></li>
        <li><a href="#å¯é‡å…¥é”åˆåé€’å½’é”">å¯é‡å…¥é”(åˆåé€’å½’é”)</a></li>
        <li><a href="#æ’æŸ¥æ­»é”">æ’æŸ¥æ­»é”</a></li>
      </ul>
    </li>
    <li><a href="#çº¿ç¨‹ä¸­æ–­">çº¿ç¨‹ä¸­æ–­</a>
      <ul>
        <li><a href="#1é€šè¿‡ä¸€ä¸ªvolatileå˜é‡">1ã€é€šè¿‡ä¸€ä¸ªvolatileå˜é‡</a></li>
        <li><a href="#2é€šè¿‡atomicboolean">2ã€é€šè¿‡AtomicBoolean</a></li>
        <li><a href="#3é€šè¿‡threadç±»è‡ªå¸¦çš„ä¸­æ–­apiæ–¹æ³•">3ã€é€šè¿‡Threadç±»è‡ªå¸¦çš„ä¸­æ–­apiæ–¹æ³•</a></li>
      </ul>
    </li>
    <li><a href="#locksupport">LockSupport</a>
      <ul>
        <li><a href="#03ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çš„æ–¹æ³•">0ã€3ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çš„æ–¹æ³•</a></li>
        <li><a href="#1objectç±»ä¸­çš„waitå’Œnotifyæ–¹æ³•">1ã€Objectç±»ä¸­çš„waitå’Œnotifyæ–¹æ³•</a></li>
        <li><a href="#2conditionæ¥å£ä¸­çš„awaitå’Œsignalæ–¹æ³•">2ã€Conditionæ¥å£ä¸­çš„awaitå’Œsignalæ–¹æ³•</a></li>
        <li><a href="#3locksupportç±»ä¸­çš„parkç­‰å¾…å’Œunparkå”¤é†’">3ã€LockSupportç±»ä¸­çš„parkç­‰å¾…å’Œunparkå”¤é†’</a></li>
        <li><a href="#4æ€»ç»“">4ã€æ€»ç»“ï¼š</a></li>
      </ul>
    </li>
    <li><a href="#jmm">JMM</a>
      <ul>
        <li><a href="#happens-beforeè§„åˆ™">happens-beforeè§„åˆ™</a></li>
      </ul>
    </li>
    <li><a href="#volatile">volatile</a>
      <ul>
        <li><a href="#å†…å­˜å±éšœ-memory-barriers--fences">å†…å­˜å±éšœ (Memory Barriers / Fences)</a></li>
        <li><a href="#happens-before-ä¹‹-volatile-å˜é‡è§„åˆ™">happens-before ä¹‹ volatile å˜é‡è§„åˆ™</a></li>
        <li><a href="#jmm-å°±å°†å†…å­˜å±éšœæ’ç­–ç•¥åˆ†ä¸º-4-ç§">JMM å°±å°†å†…å­˜å±éšœæ’â¼Šç­–ç•¥åˆ†ä¸º 4 ç§</a></li>
        <li><a href="#volatileç‰¹æ€§">volatileç‰¹æ€§</a></li>
        <li><a href="#1ä¿è¯å¯è§æ€§">1ã€ä¿è¯å¯è§æ€§</a></li>
        <li><a href="#2æ²¡æœ‰åŸå­æ€§">2ã€æ²¡æœ‰åŸå­æ€§</a></li>
        <li><a href="#3æŒ‡ä»¤ç¦é‡æ’">3ã€æŒ‡ä»¤ç¦é‡æ’</a></li>
        <li><a href="#volatileåº”ç”¨">volatileåº”ç”¨</a></li>
      </ul>
    </li>
    <li><a href="#dclåŒé‡æ£€æŸ¥é”ä¸å»¶è¿Ÿåˆå§‹åŒ–">DCLåŒé‡æ£€æŸ¥é”ä¸å»¶è¿Ÿåˆå§‹åŒ–</a>
      <ul>
        <li><a href="#é—®é¢˜ç”±æ¥">é—®é¢˜ç”±æ¥</a></li>
        <li><a href="#åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ">åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ</a></li>
        <li><a href="#åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ">åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ</a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#cas">CAS</a>
      <ul>
        <li><a href="#1å¤šçº¿ç¨‹ç¯å¢ƒä¸ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨åŸºæœ¬æ•°æ®ç±»å‹">1ã€å¤šçº¿ç¨‹ç¯å¢ƒä¸ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</a></li>
        <li><a href="#2å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨åŸºæœ¬æ•°æ®ç±»å‹">2ã€å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</a></li>
        <li><a href="#caså®šä¹‰">CASå®šä¹‰</a></li>
        <li><a href="#casåŸç†">CASåŸç†</a></li>
        <li><a href="#åº•å±‚æ±‡ç¼–">åº•å±‚æ±‡ç¼–</a></li>
        <li><a href="#è‡ªæ—‹é”spinlock">è‡ªæ—‹é”ï¼ˆspinlockï¼‰</a></li>
        <li><a href="#casç¼ºç‚¹">CASç¼ºç‚¹</a></li>
      </ul>
    </li>
    <li><a href="#åŸå­æ“ä½œç±»">åŸå­æ“ä½œç±»</a>
      <ul>
        <li><a href="#1åŸºæœ¬ç±»å‹åŸå­ç±»">1ã€åŸºæœ¬ç±»å‹åŸå­ç±»</a></li>
        <li><a href="#2æ•°ç»„ç±»å‹åŸå­ç±»">2ã€æ•°ç»„ç±»å‹åŸå­ç±»</a></li>
        <li><a href="#3å¼•ç”¨ç±»å‹åŸå­ç±»">3ã€å¼•ç”¨ç±»å‹åŸå­ç±»</a></li>
        <li><a href="#4å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»">4ã€å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»</a></li>
        <li><a href="#5åŸå­æ“ä½œå¢å¼ºç±»">5ã€åŸå­æ“ä½œå¢å¼ºç±»</a></li>
      </ul>
    </li>
    <li><a href="#threadlocal">ThreadLocal</a>
      <ul>
        <li><a href="#ç®€ä»‹">ç®€ä»‹</a></li>
        <li><a href="#threadthreadlocalthreadlocalmap">Threadï¼ŒThreadLocalï¼ŒThreadLocalMap</a></li>
        <li><a href="#threadlocalå†…å­˜æ³„æ¼">ThreadLocalå†…å­˜æ³„æ¼</a></li>
        <li><a href="#entryå¼±å¼•ç”¨">Entryå¼±å¼•ç”¨</a></li>
        <li><a href="#keyä¸ºnullçš„entry">keyä¸ºnullçš„Entry</a></li>
        <li><a href="#æ€»ç»“-2">æ€»ç»“</a></li>
        <li><a href="#æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</a></li>
      </ul>
    </li>
    <li><a href="#å¼•ç”¨">å¼•ç”¨</a>
      <ul>
        <li><a href="#1å¼ºå¼•ç”¨é»˜è®¤æ”¯æŒæ¨¡å¼">1ã€å¼ºå¼•ç”¨(é»˜è®¤æ”¯æŒæ¨¡å¼)</a></li>
        <li><a href="#2è½¯å¼•ç”¨">2ã€è½¯å¼•ç”¨</a></li>
        <li><a href="#3å¼±å¼•ç”¨">3ã€å¼±å¼•ç”¨</a></li>
        <li><a href="#4è™šå¼•ç”¨">4ã€è™šå¼•ç”¨</a></li>
      </ul>
    </li>
    <li><a href="#javaå¯¹è±¡å†…å­˜å¸ƒå±€å’Œå¯¹è±¡å¤´">Javaå¯¹è±¡å†…å­˜å¸ƒå±€å’Œå¯¹è±¡å¤´</a>
      <ul>
        <li><a href="#å¯¹è±¡åœ¨å †å†…å­˜ä¸­å¸ƒå±€">å¯¹è±¡åœ¨å †å†…å­˜ä¸­å¸ƒå±€</a></li>
        <li><a href="#å¯¹è±¡å¤´">å¯¹è±¡å¤´</a></li>
        <li><a href="#å®ä¾‹æ•°æ®">å®ä¾‹æ•°æ®</a></li>
        <li><a href="#å¯¹é½å¡«å……">å¯¹é½å¡«å……</a></li>
      </ul>
    </li>
    <li><a href="#synchronizedä¸é”å‡çº§">Synchronizedä¸é”å‡çº§</a>
      <ul>
        <li><a href="#1synchronized-é”ä¼˜åŒ–çš„èƒŒæ™¯">1ã€Synchronized é”ä¼˜åŒ–çš„èƒŒæ™¯</a></li>
        <li><a href="#2synchronizedçš„æ€§èƒ½å˜åŒ–">2ã€Synchronizedçš„æ€§èƒ½å˜åŒ–</a></li>
        <li><a href="#3synchronizedé”ç§ç±»åŠå‡çº§æ­¥éª¤">3ã€Synchronizedé”ç§ç±»åŠå‡çº§æ­¥éª¤</a></li>
        <li><a href="#4jitç¼–è¯‘å™¨å¯¹é”çš„ä¼˜åŒ–">4ã€JITç¼–è¯‘å™¨å¯¹é”çš„ä¼˜åŒ–</a></li>
      </ul>
    </li>
    <li><a href="#abstractqueuedsynchronizeraqs">AbstractQueuedSynchronizer(AQS)</a>
      <ul>
        <li><a href="#aqsæ¦‚å¿µ">AQSæ¦‚å¿µ</a></li>
        <li><a href="#é”å’ŒåŒæ­¥å™¨">é”å’ŒåŒæ­¥å™¨</a></li>
        <li><a href="#aqsæºç ">AQSæºç </a></li>
        <li><a href="#è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶twinslock">è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock</a></li>
      </ul>
    </li>
    <li><a href="#reentrantreadwritelockstampedlock">ReentrantReadWriteLockã€StampedLock</a>
      <ul>
        <li><a href="#reentrantreadwritelock">ReentrantReadWriteLock</a></li>
        <li><a href="#å†™é”çš„è·å–ä¸é‡Šæ”¾">å†™é”çš„è·å–ä¸é‡Šæ”¾</a></li>
        <li><a href="#é”é™çº§">é”é™çº§</a></li>
        <li><a href="#å¦‚ä½•ç¼“è§£é”é¥¥é¥¿é—®é¢˜">å¦‚ä½•ç¼“è§£é”é¥¥é¥¿é—®é¢˜ï¼Ÿ</a></li>
        <li><a href="#é‚®æˆ³é”stampedlock">é‚®æˆ³é”StampedLock</a></li>
      </ul>
    </li>
    <li><a href="#å€’è®¡æ—¶é—¨æ “countdownlatch">å€’è®¡æ—¶é—¨æ “CountDownLatch</a>
      <ul>
        <li><a href="#mylatch">MyLatch</a></li>
        <li><a href="#countdownlatch">CountDownLatch</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="package-javautilconcurrent-description">Package java.util.concurrent Description</h2>
<p>Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the <code>java.util.concurrent.locks</code> and <code>java.util.concurrent.atomic</code> packages.</p>
<h3 id="executors">Executors</h3>
<p><strong>Interfaces.</strong></p>
<p><code>Executor</code>is a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight task frameworks. Depending on which concrete Executor class is being used, tasks may execute in a newly created thread, an existing task-execution thread, or the thread calling <code>execute</code>, and may execute sequentially or concurrently.</p>
<p><code>ExecutorService</code> provides a more complete <code>asynchronous</code> task execution framework. An ExecutorService manages queuing and scheduling of tasks, and allows controlled shutdown.</p>
<p>The <code>ScheduledExecutorService</code> subinterface and associated interfaces add support for delayed and periodic task execution. ExecutorServices provide methods arranging asynchronous execution of any function expressed as <code>Callable</code>, the result-bearing analog of <code>Runnable</code>.</p>
<p>A <code>Future</code> returns the results of a function, allows determination of whether execution has completed, and provides a means to cancel execution.</p>
<p>A <code>RunnableFuture</code> is a <code>Future</code> that possesses a <code>run</code> method that upon execution, sets its results.</p>
<p><strong>Implementations.</strong></p>
<p>Classes <code>ThreadPoolExecutor</code>and <code>ScheduledThreadPoolExecutor</code>provide tunable, flexible thread pools.</p>
<p>The <code>Executors</code> class provides <code>factory methods</code> for the most common kinds and configurations of Executors, as well as a few utility methods for using them. Other utilities based on <code>Executors</code> include the concrete class <code>FutureTask</code> providing a common extensible implementation of Futures, and<code>ExecutorCompletionService</code>, that assists in coordinating the processing of groups of asynchronous tasks.</p>
<p>Class <code>ForkJoinPool</code> provides an Executor primarily designed for processing instances of <code>ForkJoinTask</code> and its subclasses. These classes employ a work-stealing scheduler that attains high throughput for tasks conforming to restrictions that often hold in <code>computation-intensive parallel</code> processing.</p>
<h3 id="queues">Queues</h3>
<p>The <code>ConcurrentLinkedQueue</code> class supplies an efficient scalable <code>thread-safe non-blocking FIFO</code> queue. The <code>ConcurrentLinkedDeque</code> class is similar, but additionally supports the <code>Deque</code> interface.</p>
<p>Five implementations in <code>java.util.concurrent</code> support the extended <code>BlockingQueue</code> interface, that defines blocking versions of put and take:<code>LinkedBlockingQueue</code>, <code>ArrayBlockingQueue</code>, <code>SynchronousQueue</code>, <code>PriorityBlockingQueue</code>, and <code>DelayQueue</code>. The different classes cover the most common usage contexts for producer-consumer, messaging, parallel tasking, and related concurrent designs.</p>
<p>Extended interface <code>TransferQueue</code>, and implementation <code>LinkedTransferQueue</code>introduce a synchronous <code>transfer</code> method (along with related features) in which a producer may optionally block awaiting its consumer.</p>
<p>The <code>BlockingDeque</code> interface extends <code>BlockingQueue</code> to support both FIFO and LIFO (stack-based) operations. Class <code>LinkedBlockingDeque</code> provides an implementation.</p>
<h3 id="timing">Timing</h3>
<p>The <code>TimeUnit</code> class provides multiple granularities (including nanoseconds) for specifying and controlling <code>time-out</code> based operations. Most classes in the package contain operations based on time-outs in addition to indefinite waits. In all cases that time-outs are used, the time-out specifies the minimum time that the method should wait before indicating that it timed-out. Implementations make a &ldquo;best effort&rdquo; to detect time-outs as soon as possible after they occur. However, an indefinite amount of time may elapse between a time-out being detected and a thread actually executing again after that time-out. All methods that accept timeout parameters treat values less than or equal to zero to mean not to wait at all. To wait &ldquo;forever&rdquo;, you can use a value of <code>Long.MAX_VALUE</code>.</p>
<h3 id="synchronizers">Synchronizers</h3>
<p>Five classes aid common special-purpose synchronization idioms.</p>
<ul>
<li><code>Semaphore</code> is a classic concurrency tool.</li>
<li><code>CountDownLatch</code> is a very simple yet very common utility for blocking until a given number of signals, events, or conditions hold.</li>
<li>A <code>CyclicBarrier</code> is a resettable multiway synchronization point useful in some styles of parallel programming.</li>
<li>A <code>Phaser</code> provides a more flexible form of barrier that may be used to control phased computation among multiple threads.</li>
<li>An <code>Exchanger</code> allows two threads to exchange objects at a rendezvous point, and is useful in several pipeline designs.</li>
</ul>
<h3 id="concurrent-collections">Concurrent Collections</h3>
<p>Besides Queues, this package supplies Collection implementations designed for use in multithreaded contexts: <code>ConcurrentHashMap</code>,<code>ConcurrentSkipListMap</code>, <code>ConcurrentSkipListSet</code>, <code>CopyOnWriteArrayList</code> and <code>CopyOnWriteArraySet</code>. When many threads are expected to access a given collection, a <code>ConcurrentHashMap</code> is normally preferable to a synchronized <code>HashMap</code>, and a <code>ConcurrentSkipListMap</code> is normally preferable to a synchronized <code>TreeMap</code>. A <code>CopyOnWriteArrayList</code> is preferable to a synchronized <code>ArrayList</code> when the expected number of reads and traversals greatly outnumber the number of updates to a list.</p>
<p>The &ldquo;Concurrent&rdquo; prefix used with some classes in this package is a shorthand indicating several differences from similar &ldquo;synchronized&rdquo; classes. For example <code>java.util.Hashtable</code> and <code>Collections.synchronizedMap(new HashMap())</code> are synchronized. But <code>ConcurrentHashMap</code>is &ldquo;concurrent&rdquo;. A concurrent collection is thread-safe, but not governed by a single exclusion lock. In the particular case of ConcurrentHashMap, it safely permits any number of concurrent reads as well as a tunable number of concurrent writes. &ldquo;Synchronized&rdquo; classes can be useful when you need to prevent all access to a collection via a single lock, at the expense of poorer scalability. In other cases in which multiple threads are expected to access a common collection, &ldquo;concurrent&rdquo; versions are normally preferable. And unsynchronized collections are preferable when either collections are unshared, or are accessible only when holding other locks.</p>
<p>Most concurrent Collection implementations (including most Queues) also differ from the usual <code>java.util</code> conventions in that their Iterators and Spliterators provide <em>weakly consistent</em> rather than fast-fail traversal:</p>
<ul>
<li>they may proceed concurrently with other operations</li>
<li>they will never throw <code>ConcurrentModificationException</code></li>
<li>they are guaranteed to traverse elements as they existed upon construction exactly once, and may (but are not guaranteed to) reflect any modifications subsequent to construction.</li>
</ul>
<h3 id="memory-consistency-properties">Memory Consistency Properties</h3>
<p><a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html#jls-17.4.5">Chapter 17 of the Java Language Specification</a> defines the <em>happens-before</em> relation on memory operations such as reads and writes of shared variables. The results of a write by one thread are guaranteed to be visible to a read by another thread only if the write operation <em>happens-before</em> the read operation. The <code>synchronized</code> and <code>volatile</code> constructs, as well as the <code>Thread.start()</code> and <code>Thread.join()</code> methods, can form <em>happens-before</em>relationships. In particular:</p>
<ul>
<li>Each action in a thread <em>happens-before</em> every action in that thread that comes later in the program&rsquo;s order.</li>
<li>An unlock (<code>synchronized</code> block or method exit) of a monitor <em>happens-before</em> every subsequent lock (<code>synchronized</code> block or method entry) of that same monitor. And because the <em>happens-before</em> relation is transitive, all actions of a thread prior to unlocking <em>happen-before</em> all actions subsequent to any thread locking that monitor.</li>
<li>A write to a <code>volatile</code> field <em>happens-before</em> every subsequent read of that same field. Writes and reads of <code>volatile</code> fields have similar memory consistency effects as entering and exiting monitors, but do <em>not</em> entail mutual exclusion locking.</li>
<li>A call to <code>start</code> on a thread <em>happens-before</em> any action in the started thread.</li>
<li>All actions in a thread <em>happen-before</em> any other thread successfully returns from a <code>join</code> on that thread.</li>
</ul>
<p>The methods of all classes in <code>java.util.concurrent</code> and its subpackages extend these guarantees to higher-level synchronization. In particular:</p>
<ul>
<li>
<p>Actions in a thread prior to placing an object into any concurrent collection <em>happen-before</em> actions subsequent to the access or removal of that element from the collection in another thread.</p>
</li>
<li>
<p>Actions in a thread prior to the submission of a <code>Runnable</code> to an <code>Executor</code> <em>happen-before</em> its execution begins. Similarly for <code>Callables</code> submitted to an <code>ExecutorService</code>.</p>
</li>
<li>
<p>Actions taken by the asynchronous computation represented by a <code>Future</code> <em>happen-before</em> actions subsequent to the retrieval of the result via <code>Future.get()</code> in another thread.</p>
</li>
<li>
<p>Actions prior to &ldquo;releasing&rdquo; synchronizer methods such as <code>Lock.unlock</code>, <code>Semaphore.release</code>, and <code>CountDownLatch.countDown</code> <em>happen-before</em>actions subsequent to a successful &ldquo;acquiring&rdquo; method such as <code>Lock.lock</code>, <code>Semaphore.acquire</code>, <code>Condition.await</code>, and <code>CountDownLatch.await</code>on the same synchronizer object in another thread.</p>
</li>
<li>
<p>For each pair of threads that successfully exchange objects via an <code>Exchanger</code>, actions prior to the <code>exchange()</code> in each thread <em>happen-before</em> those subsequent to the corresponding <code>exchange()</code> in another thread.</p>
</li>
<li>
<p>Actions prior to calling <code>CyclicBarrier.await</code> and <code>Phaser.awaitAdvance</code> (as well as its variants) <em>happen-before</em> actions performed by the barrier action, and actions performed by the barrier action <em>happen-before</em> actions subsequent to a successful return from the corresponding <code>await</code> in other threads.</p>
</li>
<li>
<p><strong>Since:</strong></p>
<p>1.5</p>
</li>
</ul>
<h2 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h2>
<ul>
<li>å·¥ä½œè€…çº¿ç¨‹ï¼šå·¥ä½œè€…çº¿ç¨‹ä¸»ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯ä»é˜Ÿåˆ—ä¸­æ¥å—ä»»åŠ¡å¹¶æ‰§è¡Œ</li>
<li>ä»»åŠ¡é˜Ÿåˆ—ï¼šä»»åŠ¡é˜Ÿåˆ—ä¿å­˜å¾…æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<h3 id="interface-executor">interface Executor</h3>
<p>Executorè¡¨ç¤ºæœ€ç®€å•çš„æ‰§è¡ŒæœåŠ¡ï¼Œå…¶å®šä¹‰ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Executes the given command at some time in the future.  The command
</span></span></span><span class="line"><span class="cl"><span class="cm">     * may execute in a new thread, in a pooled thread, or in the calling
</span></span></span><span class="line"><span class="cl"><span class="cm">     * thread, at the discretion of the {@code Executor} implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param command the runnable task
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws RejectedExecutionException if this task cannot be
</span></span></span><span class="line"><span class="cl"><span class="cm">     * accepted for execution
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException if command is null
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>void execute(Runnable command);</code>å¯ä»¥æ‰§è¡Œä¸€ä¸ªRunnableï¼Œæ²¡æœ‰è¿”å›ç»“æœã€‚</p>
<p>æ¥å£æ²¡æœ‰é™å®šä»»åŠ¡å¦‚ä½•æ‰§è¡Œï¼Œå¯èƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯åœ¨è°ƒç”¨è€…çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯å¤ç”¨çº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹ã€‚</p>
<p>Executor:</p>
<p>An object that executes submitted <code>Runnable</code> tasks. This interface provides a way of decoupling task submission from the mechanics of how each task will be run, including details of thread use, scheduling, etc.</p>
<p>æ–°çº¿ç¨‹ï¼š</p>
<p>An <code>Executor</code> is normally used instead of explicitly creating threads. For example, rather than invoking <code>new Thread(new(RunnableTask())).start()</code> for each of a set of tasks, you might use:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">anExecutor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableTask1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"> <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableTask2</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"> <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨è€…çº¿ç¨‹ï¼š</p>
<p>However, the <code>Executor</code> interface does not strictly require that execution be <code>asynchronous</code>. In the simplest case, an executor can run the submitted task immediately in the <code>caller's thread</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">class</span> <span class="nc">DirectExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çº¿ç¨‹æ± ï¼š</p>
<p>More typically, tasks are executed in <code>some thread</code> other than the caller&rsquo;s thread. The executor below spawns a new thread for each task.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">class</span> <span class="nc">ThreadPerTaskExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Many <code>Executor</code> implementations impose some sort of limitation on how and when tasks are scheduled. The executor below serializes the submission of tasks to a second executor, illustrating a <code>composite executor</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> class SerialExecutor implements Executor {
</span></span><span class="line"><span class="cl">   final Queue&lt;Runnable&gt; tasks = new ArrayDeque&lt;Runnable&gt;();
</span></span><span class="line"><span class="cl">   final Executor executor;
</span></span><span class="line"><span class="cl">   Runnable active;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   SerialExecutor(Executor executor) {
</span></span><span class="line"><span class="cl">     this.executor = executor;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public synchronized void execute(final Runnable r) {
</span></span><span class="line"><span class="cl">     tasks.offer(new Runnable() {
</span></span><span class="line"><span class="cl">       public void run() {
</span></span><span class="line"><span class="cl">         try {
</span></span><span class="line"><span class="cl">           r.run();
</span></span><span class="line"><span class="cl">         } finally {
</span></span><span class="line"><span class="cl">           scheduleNext();
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl">       }
</span></span><span class="line"><span class="cl">     });
</span></span><span class="line"><span class="cl">     if (active == null) {
</span></span><span class="line"><span class="cl">       scheduleNext();
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   protected synchronized void scheduleNext() {
</span></span><span class="line"><span class="cl">     if ((active = tasks.poll()) != null) {
</span></span><span class="line"><span class="cl">       executor.execute(active);
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Executor</code> implementations provided in this package implement <code>ExecutorService</code>, which is a more extensive interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExecutorService</span> <span class="kd">extends</span> <span class="n">Executor</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>ThreadPoolExecutor</code> class provides an extensible thread pool implementation.</p>
<p>The <code>Executors</code> class provides convenient factory methods for these Executors.</p>
<p>Memory consistency effects: Actions in a thread prior to submitting a <code>Runnable</code> object to an <code>Executor</code> <em>happen-before</em> its execution begins, perhaps in another thread.</p>
<h3 id="interface-executorservice-extends-executor">interface ExecutorService extends Executor</h3>
<p>ExecutorServiceæ‰©å±•äº†Executorï¼Œå®šä¹‰äº†æ›´å¤šæœåŠ¡ï¼ŒåŸºæœ¬æ–¹æ³•æœ‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExecutorService</span> <span class="kd">extends</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="n">T</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Future</span><span class="o">&lt;?&gt;</span> <span class="n">submit</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸‰ä¸ªsubmitéƒ½è¡¨ç¤ºæäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œè¿”å›å€¼ç±»å‹éƒ½æ˜¯Futureã€‚</p>
<p>è¿”å›åï¼Œåªæ˜¯è¡¨ç¤ºä»»åŠ¡å·²æäº¤ï¼Œä¸ä»£è¡¨å·²æ‰§è¡Œã€‚</p>
<p>é€šè¿‡Futureå¯ä»¥æŸ¥è¯¢å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€ã€è·å–æœ€ç»ˆç»“æœã€å–æ¶ˆä»»åŠ¡ç­‰ã€‚</p>
<p><code>&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</code></p>
<p>Submits a value-returning task for execution and returns a Future representing the pending results of the task. The Future&rsquo;s <code>get</code> method will return the task&rsquo;s result upon successful completion.</p>
<p>å¯¹äºCallableï¼Œä»»åŠ¡æœ€ç»ˆæœ‰ä¸ªè¿”å›å€¼</p>
<p>If you would like to immediately block waiting for a task, you can use constructions of the form <code>result = exec.submit(aCallable).get();</code></p>
<p>Note: The <code>Executors</code>class includes a set of methods that can convert some other common closure-like objects, for example, <code>PrivilegedAction</code>to <code>Callable</code> form so they can be submitted.</p>
<p><code>&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</code></p>
<p>Submits a Runnable task for execution and returns a Future representing that task. The Future&rsquo;s <code>get</code> method will return the given result upon successful completion.</p>
<p>æäº¤Runnableçš„æ–¹æ³•å¯ä»¥åŒæ—¶æä¾›ä¸€ä¸ªç»“æœï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶è¿”å›</p>
<p><code>Future&lt;?&gt; submit(Runnable task);</code></p>
<p>Submits a Runnable task for execution and returns a Future representing that task. The Future&rsquo;s <code>get</code> method will return <code>null</code> upon <em>successful</em> completion.</p>
<p>å¼‚æ­¥ä»»åŠ¡çš„æœ€ç»ˆè¿”å›å€¼ä¸ºnull</p>
<h3 id="å…³é—­çº¿ç¨‹æ± ">å…³é—­çº¿ç¨‹æ± </h3>
<ul>
<li>shutdownï¼šå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆ<code>SHUTDOWN</code>çŠ¶æ€ï¼Œç„¶åä¸­æ–­æ‰€æœ‰<code>æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹</code>ã€‚</li>
<li>shutdownNowï¼šé¦–å…ˆå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆ<code>STOP</code>ï¼Œç„¶åå°è¯•åœæ­¢æ‰€æœ‰çš„<code>æ­£åœ¨æ‰§è¡Œæˆ–æš‚åœä»»åŠ¡</code>çš„çº¿ç¨‹ï¼Œå¹¶è¿”å›<code>ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„åˆ—è¡¨</code>ã€‚</li>
</ul>
<p>å®ƒä»¬çš„åŸç†æ˜¯éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åé€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ï¼Œæ‰€ä»¥æ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ã€‚</p>
<p><code>void shutdown();</code>æ³¨é‡Šï¼š</p>
<p>Initiates an orderly shutdown in which previously submitted tasks are executed, but no new tasks will be accepted. Invocation has no additional effect if already shut down.</p>
<p>This method does not wait for previously submitted tasks to complete execution. Use <code>awaitTermination</code> to do that.</p>
<p><code>List&lt;Runnable&gt; shutdownNow();</code>æ³¨é‡Šï¼š</p>
<p>Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and returns a list of the tasks that were awaiting execution.</p>
<p>This method does not wait for actively executing tasks to terminate. Use <code>awaitTermination</code>to do that.</p>
<p>There are no guarantees beyond best-effort attempts to stop processing actively executing tasks. For example, typical implementations will cancel via <code>Thread.interrupt()</code>, so any task that fails to respond to interrupts may never terminate.</p>
<p><strong>Returns:</strong></p>
<p>list of tasks that never commenced execution</p>
<p>shutdownå’ŒshutdownNowä¸ä¼šé˜»å¡ç­‰å¾…ï¼Œå®ƒä»¬è¿”å›åä¸ä»£è¡¨æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»“æŸï¼Œä¸è¿‡isShutdownæ–¹æ³•ä¼šè¿”å›trueã€‚</p>
<p>è°ƒç”¨è€…å¯ä»¥é€šè¿‡awaitTerminationç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸï¼Œå®ƒå¯ä»¥é™å®šç­‰å¾…çš„æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶å‰æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œå³isTerminatedæ–¹æ³•è¿”å›trueï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>ExecutorServiceæœ‰ä¸¤ç»„æ‰¹é‡æäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼šinvokeAllå’ŒinvokeAnyï¼Œå®ƒä»¬éƒ½æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªé™å®šç­‰å¾…æ—¶é—´ã€‚</p>
<p>invokeAllç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œè¿”å›çš„Futureåˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªFutureçš„isDoneæ–¹æ³•éƒ½è¿”å›trueï¼Œä¸è¿‡isDoneä¸ºtrueä¸ä»£è¡¨ä»»åŠ¡å°±æ‰§è¡ŒæˆåŠŸäº†ï¼Œå¯èƒ½æ˜¯è¢«å–æ¶ˆäº†ã€‚invokeAllå¯ä»¥æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶åæœ‰çš„ä»»åŠ¡æ²¡å®Œæˆï¼Œå°±ä¼šè¢«å–æ¶ˆã€‚</p>
<p>è€Œå¯¹äºinvokeAnyï¼Œåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨é™æ—¶å†…æˆåŠŸè¿”å›äº†ï¼Œå®ƒå°±ä¼šè¿”å›è¯¥ä»»åŠ¡çš„ç»“æœï¼Œå…¶ä»–ä»»åŠ¡ä¼šè¢«å–æ¶ˆï¼›å¦‚æœæ²¡æœ‰ä»»åŠ¡èƒ½åœ¨é™æ—¶å†…æˆåŠŸè¿”å›ï¼ŒæŠ›å‡ºTimeoutExceptionï¼›å¦‚æœé™æ—¶å†…æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œä½†éƒ½å‘ç”Ÿäº†å¼‚å¸¸ï¼ŒæŠ›å‡ºExecutionExceptionã€‚</p>
<h3 id="abstract-class-abstractexecutorservice-implements-executorservice">abstract class AbstractExecutorService implements ExecutorService</h3>
<h3 id="class-threadpoolexecutor-extends-abstractexecutorservice">class ThreadPoolExecutor extends AbstractExecutorService</h3>
<p>JUCä¸­çº¿ç¨‹æ± çš„å®ç°ç±»æ˜¯ThreadPoolExecutorï¼Œå®ƒç»§æ‰¿è‡ªAbstractExecutorServiceï¼Œå®ç°äº†ExecutorServiceã€‚</p>
<p>Creates a new ThreadPoolExecutor with the given initial parameters and default thread factory and rejected execution handler. It may be more convenient to use one of the Executors factory methods instead of this general purpose constructor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">defaultHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a new ThreadPoolExecutor with the given initial parameters and default rejected execution handler.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">threadFactory</span><span class="o">,</span> <span class="n">defaultHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a new ThreadPoolExecutor with the given initial parameters and default thread factory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a new ThreadPoolExecutor with the given initial parameters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">    <span class="kc">null</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>corePoolSize</code> - the number of threads to keep in the pool, even if they are idle, unless <code>allowCoreThreadTimeOut</code> is set</p>
<p>corePoolSizeï¼ˆçº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼‰ï¼šå½“æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå³ä½¿å…¶ä»–ç©ºé—²çš„åŸºæœ¬çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ–°ä»»åŠ¡ä¹Ÿä¼šåˆ›å»ºçº¿ç¨‹ï¼Œç­‰åˆ°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°å¤§äºçº¿ç¨‹æ± åŸºæœ¬å¤§å°æ—¶å°±ä¸å†åˆ›å»ºã€‚å¦‚æœè°ƒç”¨äº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰åŸºæœ¬çº¿ç¨‹ã€‚</p>
<p><code>maximumPoolSize</code> - the maximum number of threads to allow in the pool</p>
<p>maximumPoolSizeï¼ˆçº¿ç¨‹æ± æœ€å¤§æ•°é‡ï¼‰ï¼šçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·²åˆ›å»ºçš„çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™çº¿ç¨‹æ± ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†æ— ç•Œçš„ä»»åŠ¡é˜Ÿåˆ—è¿™ä¸ªå‚æ•°å°±æ²¡ä»€ä¹ˆæ•ˆæœã€‚</p>
<p><code>keepAliveTime</code> - when the number of threads is greater than the core, this is the maximum time that excess idle threads will wait for new tasks before terminating.</p>
<p><code>unit</code> - the time unit for the <code>keepAliveTime</code> argument</p>
<p><code>workQueue</code> - the queue to use for holding tasks before they are executed. This queue will hold only the <code>Runnable</code> tasks submitted by the <code>execute</code> method.</p>
<ul>
<li>
<p>ArrayBlockingQueueï¼šåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</p>
</li>
<li>
<p>LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOæ’åºå…ƒç´ ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueã€‚</p>
<p>é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚</p>
</li>
<li>
<p>SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinked-BlockingQueueã€‚</p>
<p>é™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚</p>
</li>
<li>
<p>PriorityBlockingQueueï¼šä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—ã€‚</p>
</li>
</ul>
<p><code>threadFactory</code> - the factory to use when the executor creates a new thread</p>
<p><code>handler</code> - the handler to use when execution is blocked because the thread bounds and queue capacities are reached</p>
<p>ThreadPoolExecutoræ‰§è¡Œexecuteæ–¹æ³•åˆ†ä¸‹é¢4ç§æƒ…å†µã€‚</p>
<p>1ï¼‰å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚</p>
<p>2ï¼‰å¦‚æœè¿è¡Œçš„çº¿ç¨‹ç­‰äºæˆ–å¤šäºcorePoolSizeï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥BlockingQueueã€‚</p>
<p>3ï¼‰å¦‚æœæ— æ³•å°†ä»»åŠ¡åŠ å…¥BlockingQueueï¼ˆé˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚</p>
<p>4ï¼‰å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºmaximumPoolSizeï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ï¼Œå¹¶è°ƒç”¨RejectedExecutionHandler.rejectedExecution()æ–¹æ³•ã€‚</p>
<h3 id="rejectedexecutionhandlerrejectedexecution">RejectedExecutionHandler.rejectedExecution</h3>
<p>ä»»åŠ¡æ‹’ç»ç­–ç•¥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The default rejected execution handler
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">RejectedExecutionHandler</span> <span class="n">defaultHandler</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">AbortPolicy</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼ˆå¦‚execute/submit/invokeAllç­‰ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç±»å‹ä¸ºRejectedExecutionExceptionã€‚</p>
<p>ä¸è¿‡ï¼Œæ‹’ç»ç­–ç•¥æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼ŒThreadPoolExecutorå®ç°äº†4ç§å¤„ç†æ–¹å¼ã€‚</p>
<p>1ï¼‰ThreadPoolExecutor.AbortPolicyï¼šè¿™å°±æ˜¯é»˜è®¤çš„æ–¹å¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that throws a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@code RejectedExecutionException}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbortPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates an {@code AbortPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AbortPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Always throws RejectedExecutionException.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws RejectedExecutionException always
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">(</span><span class="s">&#34;Task &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                             <span class="s">&#34; rejected from &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ï¼‰ThreadPoolExecutor.DiscardPolicyï¼šé™é»˜å¤„ç†ï¼Œå¿½ç•¥æ–°ä»»åŠ¡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿä¸æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that silently discards the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * rejected task.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code DiscardPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DiscardPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Does nothing, which has the effect of discarding task r.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ï¼‰ThreadPoolExecutor.DiscardOldestPolicyï¼šå°†ç­‰å¾…æ—¶é—´æœ€é•¿çš„ä»»åŠ¡æ‰”æ‰ï¼Œç„¶åè‡ªå·±æ’é˜Ÿã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that discards the oldest unhandled
</span></span></span><span class="line"><span class="cl"><span class="cm"> * request and then retries {@code execute}, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is shut down, in which case the task is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardOldestPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code DiscardOldestPolicy} for the given executor.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DiscardOldestPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Obtains and ignores the next task that the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * would otherwise execute, if one is immediately available,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and then retries execution of task r, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is shut down, in which case task r is instead discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">getQueue</span><span class="o">().</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4ï¼‰ThreadPoolExecutor.CallerRunsPolicyï¼šåœ¨ä»»åŠ¡æäº¤è€…çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯äº¤ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that runs the rejected task
</span></span></span><span class="line"><span class="cl"><span class="cm"> * directly in the calling thread of the {@code execute} method,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * unless the executor has been shut down, in which case the task
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallerRunsPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code CallerRunsPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CallerRunsPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Executes task r in the caller&#39;s thread, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * has been shut down, in which case the task is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä»¬éƒ½æ˜¯ThreadPoolExecutorçš„<code>publicé™æ€å†…éƒ¨ç±»</code>ï¼Œéƒ½å®ç°äº†RejectedExecutionHandleræ¥å£ã€‚</p>
<p>æ‹’ç»ç­–ç•¥åªæœ‰åœ¨é˜Ÿåˆ—æœ‰ç•Œï¼Œä¸”maximumPoolSizeæœ‰é™çš„æƒ…å†µä¸‹æ‰ä¼šè§¦å‘ã€‚</p>
<p>å¦‚æœ</p>
<ul>
<li>é˜Ÿåˆ—æ— ç•Œï¼šæœåŠ¡ä¸äº†çš„ä»»åŠ¡æ€»æ˜¯ä¼šæ’é˜Ÿï¼Œè¯·æ±‚å¤„ç†é˜Ÿåˆ—å¯èƒ½ä¼šæ¶ˆè€—éå¸¸å¤§çš„å†…å­˜ï¼Œç”šè‡³å¼•å‘å†…å­˜ä¸å¤Ÿçš„å¼‚å¸¸ã€‚</li>
<li>é˜Ÿåˆ—æœ‰ç•Œä½†maximumPoolSizeæ— é™ï¼šå¯èƒ½ä¼šåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œå æ»¡CPUå’Œå†…å­˜ï¼Œä½¿å¾—ä»»ä½•ä»»åŠ¡éƒ½éš¾ä»¥å®Œæˆã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œåœ¨ä»»åŠ¡é‡éå¸¸å¤§çš„åœºæ™¯ä¸­ï¼Œè®©æ‹’ç»ç­–ç•¥æœ‰æœºä¼šæ‰§è¡Œæ˜¯ä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œå¾ˆé‡è¦çš„æ–¹é¢ã€‚</p>
<p><strong>æ ¸å¿ƒçº¿ç¨‹</strong></p>
<p>çº¿ç¨‹ä¸ªæ•°å°äºç­‰äºcorePoolSizeæ—¶ï¼Œæˆ‘ä»¬ç§°è¿™äº›çº¿ç¨‹ä¸ºæ ¸å¿ƒçº¿ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ã€‚</p>
<ul>
<li>
<p>æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé¢„å…ˆåˆ›å»ºï¼Œåªæœ‰å½“æœ‰ä»»åŠ¡æ—¶æ‰ä¼šåˆ›å»ºã€‚</p>
</li>
<li>
<p>æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šå› ä¸ºç©ºé—²è€Œè¢«ç»ˆæ­¢ï¼ŒkeepAliveTimeå‚æ•°ä¸é€‚ç”¨äºå®ƒã€‚</p>
</li>
</ul>
<h3 id="class-executors-å·¥å‚ç±»">class Executors å·¥å‚ç±»</h3>
<p>ThreadPoolExecutoré€šå¸¸ä½¿ç”¨å·¥å‚ç±»Executorsæ¥åˆ›å»ºã€‚Executorså¯ä»¥åˆ›å»º3ç§ç±»å‹çš„ThreadPoolExecutorï¼šFixedThreadPoolã€SingleThreadExecutorå’ŒCachedThreadPoolã€‚</p>
<p>ç±»Executorsæä¾›äº†ä¸€äº›é™æ€å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºä¸€äº›é¢„é…ç½®çš„çº¿ç¨‹æ± ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a thread pool that reuses a fixed number of threads operating off a <code>shared unbounded</code> queue. At any point, at most <code>nThreads</code> threads will be active processing tasks. If additional tasks are submitted when all threads are active, they will wait in the queue until a thread is available. If any thread terminates due to a failure during execution prior to shutdown, a new one will take its place if needed to execute subsequent tasks. The threads in the pool will exist until it is explicitly <code>shutdown</code>.</p>
<p>ä½¿ç”¨å›ºå®šæ•°ç›®çš„nä¸ªçº¿ç¨‹ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œçº¿ç¨‹åˆ›å»ºåä¸ä¼šè¶…æ—¶ç»ˆæ­¢ã€‚å’ŒnewSingleThreadExecutorä¸€æ ·ï¼Œç”±äºæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¦‚æœæ’é˜Ÿä»»åŠ¡è¿‡å¤šï¼Œå¯èƒ½ä¼šæ¶ˆè€—è¿‡å¤šçš„å†…å­˜ã€‚</p>
<p>FixedThreadPoolé€‚ç”¨äºä¸ºäº†æ»¡è¶³èµ„æºç®¡ç†çš„éœ€æ±‚ï¼Œè€Œéœ€è¦é™åˆ¶å½“å‰çº¿ç¨‹æ•°é‡çš„åº”ç”¨åœºæ™¯ï¼Œå®ƒé€‚ç”¨äºè´Ÿè½½æ¯”è¾ƒé‡çš„æœåŠ¡å™¨ã€‚</p>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FinalizableDelegatedExecutorService</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates an Executor that uses <code>a single worker thread</code> operating off an <code>unbounded</code> queue. (Note however that if this single thread terminates due to a failure during execution prior to shutdown, a new one will take its place if needed to execute subsequent tasks.) Tasks are guaranteed to execute sequentially, and no more than one task will be active at any given time. Unlike the otherwise equivalent <code>newFixedThreadPool(1)</code> the returned executor is guaranteed not to be reconfigurable to use additional threads.</p>
<p>åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œçº¿ç¨‹åˆ›å»ºåä¸ä¼šè¶…æ—¶ç»ˆæ­¢ï¼Œè¯¥çº¿ç¨‹é¡ºåºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚è¯¥çº¿ç¨‹æ± é€‚ç”¨äºéœ€è¦ç¡®ä¿æ‰€æœ‰ä»»åŠ¡è¢«é¡ºåºæ‰§è¡Œçš„åœºåˆã€‚</p>
<p>SingleThreadExecutoré€‚ç”¨äºéœ€è¦ä¿è¯é¡ºåºåœ°æ‰§è¡Œå„ä¸ªä»»åŠ¡ï¼›å¹¶ä¸”åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œä¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹æ˜¯æ´»åŠ¨çš„åº”ç”¨åœºæ™¯ã€‚</p>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">60L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a thread pool that creates new threads as needed, but will reuse previously constructed threads when they are available. These pools will typically improve the performance of programs that execute <code>many short-lived asynchronous tasks</code>. Calls to <code>execute</code> will reuse previously constructed threads if available. If no existing thread is available, a new thread will be created and added to the pool. Threads that have not been used for sixty seconds are terminated and removed from the cache. Thus, a pool that remains idle for long enough will not consume any resources. Note that pools with similar properties but different details (for example, timeout parameters) may be created using <code>ThreadPoolExecutor</code> constructors.</p>
<p>å®ƒçš„corePoolSizeä¸º0, maximumPoolSizeä¸ºInteger.MAâ…©_VALUE, keepAliveTimeæ˜¯60ç§’ï¼Œé˜Ÿåˆ—ä¸ºSynchronousQueueã€‚å®ƒçš„å«ä¹‰æ˜¯ï¼šå½“æ–°ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œå¦‚æœæ­£å¥½æœ‰ç©ºé—²çº¿ç¨‹åœ¨ç­‰å¾…ä»»åŠ¡ï¼Œåˆ™å…¶ä¸­ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ¥å—è¯¥ä»»åŠ¡ï¼Œå¦åˆ™å°±æ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåˆ›å»ºçš„æ€»çº¿ç¨‹ä¸ªæ•°ä¸å—é™åˆ¶ï¼Œå¯¹ä»»ä¸€ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœ60ç§’å†…æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œå°±ç»ˆæ­¢ã€‚</p>
<p>CachedThreadPoolæ˜¯å¤§å°æ— ç•Œçš„çº¿ç¨‹æ± ï¼Œé€‚ç”¨äºæ‰§è¡Œå¾ˆå¤šçš„çŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„å°ç¨‹åºï¼Œæˆ–è€…æ˜¯è´Ÿè½½è¾ƒè½»çš„æœåŠ¡å™¨ã€‚</p>
<h2 id="futuretask">FutureTask</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RunnableFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets this Future to the result of its computation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * unless it has been cancelled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="completablefuture">CompletableFuture</h2>
<p>ä»Java8å¼€å§‹å¼•å…¥äº†CompletableFutureï¼Œå®ƒæ˜¯Futureçš„åŠŸèƒ½å¢å¼ºç‰ˆï¼Œå¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo3</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;-----come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">6</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">10</span> <span class="o">/</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----result: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----exception: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="n">44</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:æš‚åœ3ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>whenComplete:</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;&ndash;come in</p>
<p>&mdash;&ndash;è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š 4</p>
<p>&mdash;&ndash;result: 4</p>
</blockquote>
<p>exceptionally:</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;&ndash;come in</p>
<p>&mdash;&ndash;è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š 9</p>
<p>&mdash;&ndash;exception: java.lang.ArithmeticException: / by zero	java.lang.ArithmeticException: / by zero</p>
</blockquote>
<p><strong>CompletableFutureçš„ä¼˜ç‚¹ï¼š</strong></p>
<p>å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›</p>
<p>å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›</p>
<p>ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¼‚æ­¥ä»»åŠ¡ä¹‹é—´å¯ä»¥é¡ºåºæ‰§è¡Œã€‚</p>
<h3 id="æ¡ˆä¾‹ç”µå•†ç½‘ç«™çš„æ¯”ä»·">æ¡ˆä¾‹â€”â€”ç”µå•†ç½‘ç«™çš„æ¯”ä»·</h3>
<p>åˆ‡è®°ï¼ŒåŠŸèƒ½â†’æ€§èƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;jd&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;tmall&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;pdd&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;mi&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPriceSync</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">mall</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">productName</span> <span class="o">+</span> <span class="s">&#34; %s price is %.2f&#34;</span><span class="o">,</span> <span class="n">mall</span><span class="o">.</span><span class="na">getNetMallName</span><span class="o">(),</span> <span class="n">mall</span><span class="o">.</span><span class="na">getPriceByName</span><span class="o">(</span><span class="n">productName</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPriceASync</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">mall</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">productName</span> <span class="o">+</span> <span class="s">&#34; %s price is %.2f&#34;</span><span class="o">,</span> <span class="n">mall</span><span class="o">.</span><span class="na">getNetMallName</span><span class="o">(),</span> <span class="n">mall</span><span class="o">.</span><span class="na">getPriceByName</span><span class="o">(</span><span class="n">productName</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">findPriceSync</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="s">&#34;thinking in java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span> <span class="o">:</span> <span class="n">list1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">findPriceASync</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="s">&#34;thinking in java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span> <span class="o">:</span> <span class="n">list2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime2</span> <span class="o">-</span> <span class="n">startTime2</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">NetMall</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNetMallName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NetMall</span><span class="o">(</span><span class="n">String</span> <span class="n">netMallName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">netMallName</span> <span class="o">=</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getPriceByName</span><span class="o">(</span><span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">calcPrice</span><span class="o">(</span><span class="n">productName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">calcPrice</span><span class="o">(</span><span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">()</span> <span class="o">+</span> <span class="n">productName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>thinking in java jd price is 116.41</p>
<p>thinking in java tmall price is 116.65</p>
<p>thinking in java pdd price is 116.76</p>
<p>thinking in java mi price is 116.53</p>
<p>&mdash;-costTime: 4082 æ¯«ç§’</p>
<p>thinking in java jd price is 116.42</p>
<p>thinking in java tmall price is 116.28</p>
<p>thinking in java pdd price is 116.06</p>
<p>thinking in java mi price is 116.68</p>
<p>&mdash;-costTime: 1008 æ¯«ç§’</p>
</blockquote>
<h3 id="completablefutureå¸¸ç”¨æ–¹æ³•">CompletableFutureå¸¸ç”¨æ–¹æ³•</h3>
<h4 id="è·å¾—ç»“æœå’Œè§¦å‘è®¡ç®—">è·å¾—ç»“æœå’Œè§¦å‘è®¡ç®—</h4>
<p>è·å¾—ç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">reportGet</span><span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">waitingGet</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">:</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Waits</span> <span class="k">if</span> <span class="n">necessary</span> <span class="k">for</span> <span class="k">this</span> <span class="n">future</span> <span class="n">to</span> <span class="n">complete</span><span class="o">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">returns</span> <span class="n">its</span> <span class="n">result</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">reportGet</span><span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">timedGet</span><span class="o">(</span><span class="n">nanos</span><span class="o">)</span> <span class="o">:</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Waits</span> <span class="k">if</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">at</span> <span class="n">most</span> <span class="n">the</span> <span class="n">given</span> <span class="n">time</span> <span class="k">for</span> <span class="k">this</span> <span class="n">future</span> <span class="n">to</span> <span class="n">complete</span><span class="o">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">returns</span> <span class="n">its</span> <span class="n">result</span><span class="o">,</span> <span class="k">if</span> <span class="n">available</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">533</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//å»æ‰ç­‰å¾…æ—¶é—´ä¸Šé¢è®¡ç®—æ²¡æœ‰å®Œæˆï¼Œè¿”å›valueIfAbsentï¼š444
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//å¼€å¯ç­‰å¾…æ—¶é—´ä¸Šé¢è®¡ç®—å®Œæˆï¼Œè¿”å›è®¡ç®—ç»“æœ533
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">completableFuture</span><span class="o">.</span><span class="na">getNow</span><span class="o">(</span><span class="n">444</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»åŠ¨è§¦å‘è®¡ç®—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">complete</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">triggered</span> <span class="o">=</span> <span class="n">completeValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">postComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">triggered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">If</span> <span class="n">not</span> <span class="n">already</span> <span class="n">completed</span><span class="o">,</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">value</span> <span class="n">returned</span> <span class="n">by</span> <span class="nf">get</span><span class="o">()</span> <span class="n">and</span> <span class="n">related</span> <span class="n">methods</span> <span class="n">to</span> <span class="n">the</span> <span class="n">given</span> <span class="n">value</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">533</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æ³¨é‡Šæ‰æš‚åœæ—¶é—´ï¼Œgetè¿˜æ²¡æœ‰ç®—å®Œåªèƒ½è¿”å›completeæ–¹æ³•è®¾ç½®çš„444ï¼›æš‚åœ2ç§’é’Ÿï¼Œå¼‚æ­¥çº¿ç¨‹èƒ½å¤Ÿè®¡ç®—å®Œæˆè¿”å›get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“è°ƒç”¨CompletableFuture.get()è¢«é˜»å¡çš„æ—¶å€™,completeæ–¹æ³•å°±æ˜¯ç»“æŸé˜»å¡å¹¶get()è·å–è®¾ç½®çš„completeé‡Œé¢çš„å€¼.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">completableFuture</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">444</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">completableFuture</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æš‚åœ2ç§’é’Ÿï¼Œå¼‚æ­¥çº¿ç¨‹èƒ½å¤Ÿè®¡ç®—å®Œæˆè¿”å›getï¼š</p>
<blockquote>
<p>false	533</p>
</blockquote>
<p>æ³¨é‡Šæ‰æš‚åœæ—¶é—´ï¼Œgetè¿˜æ²¡æœ‰ç®—å®Œåªèƒ½è¿”å›completeæ–¹æ³•è®¾ç½®çš„444ï¼š</p>
<blockquote>
<p>true	444</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†">å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†</h4>
<h5 id="thenapply">thenApply</h5>
<p>å­˜åœ¨ä¾èµ–å…³ç³»(å½“å‰æ­¥é”™ï¼Œä¸èµ°ä¸‹ä¸€æ­¥)ï¼Œå½“å‰æ­¥éª¤æœ‰å¼‚å¸¸çš„è¯å°±å«åœã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// è®¡ç®—ç»“æœå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo4</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ç”¨ thenApply æ–¹æ³•æ¥æŠŠè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//int age = 10/0; // å¼‚å¸¸æƒ…å†µï¼šå“ªæ­¥å‡ºé”™å°±åœåœ¨å“ªæ­¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenCompleteAsync</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*****v: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æ— å¼‚å¸¸æƒ…å†µï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>222</p>
<p>333</p>
<p>*****v: 1026</p>
</blockquote>
<p>æœ‰å¼‚å¸¸æƒ…å†µï¼ˆint age = 10/0;ï¼‰ï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>222</p>
<p>*****v: null</p>
<p>java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero
at</p>
<p>&hellip;</p>
</blockquote>
<h5 id="handle">handle</h5>
<p>æœ‰å¼‚å¸¸ä¹Ÿå¯ä»¥å¾€ä¸‹ä¸€æ­¥èµ°ï¼Œæ ¹æ®å¸¦çš„å¼‚å¸¸å‚æ•°å¯ä»¥è¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo4</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ç”¨ handle æ–¹æ³•æ¥æŠŠè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//å¼‚å¸¸æƒ…å†µï¼šæœ‰å¼‚å¸¸ä¹Ÿå¯ä»¥å¾€ä¸‹ä¸€æ­¥èµ°ï¼Œæ ¹æ®å¸¦çš„å¼‚å¸¸å‚æ•°å¯ä»¥è¿›ä¸€æ­¥å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">handle</span><span class="o">((</span><span class="n">f</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">10</span> <span class="o">/</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">handle</span><span class="o">((</span><span class="n">f</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenCompleteAsync</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*****v: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æ— å¼‚å¸¸æƒ…å†µï¼šåŒä¸ŠthenApply</p>
<p>æœ‰å¼‚å¸¸æƒ…å†µï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>333</p>
<p>*****v: null</p>
<p>java.util.concurrent.CompletionException: java.lang.NullPointerException</p>
<p>&hellip;</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ¶ˆè´¹">å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ¶ˆè´¹</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">4</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">r</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š10</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">thenRun
</span></span><span class="line"><span class="cl">thenRun(Runnable runnable)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼Œå¹¶ä¸” B ä¸éœ€è¦ A çš„ç»“æœ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">thenAccept
</span></span><span class="line"><span class="cl">thenAccept(Consumer action)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼ŒB éœ€è¦ A çš„ç»“æœï¼Œä½†æ˜¯ä»»åŠ¡ B æ— è¿”å›å€¼
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">thenApply
</span></span><span class="line"><span class="cl">thenApply(Function fn)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼ŒB éœ€è¦ A çš„ç»“æœï¼ŒåŒæ—¶ä»»åŠ¡ B æœ‰è¿”å›å€¼
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenRun</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{}).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">resultA</span> <span class="o">-&gt;</span> <span class="o">{}).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">resultA</span> <span class="o">-&gt;</span> <span class="n">resultA</span> <span class="o">+</span> <span class="s">&#34; resultB&#34;</span><span class="o">).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>null</p>
<p>null</p>
<p>resultA resultB</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨">å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨</h4>
<p>applyToEither: è°å¿«ç”¨è°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo5</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture1</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture2</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">completableFuture1</span><span class="o">.</span><span class="na">applyToEither</span><span class="o">(</span><span class="n">completableFuture2</span><span class="o">,</span> <span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in</p>
<p>main	21</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶">å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶</h4>
<p>thenCombine:</p>
<p>ä¸¤ä¸ªCompletionStageä»»åŠ¡éƒ½å®Œæˆåï¼Œæœ€ç»ˆèƒ½æŠŠä¸¤ä¸ªä»»åŠ¡çš„ç»“æœä¸€èµ·äº¤ç»™thenCombineæ¥å¤„ç†</p>
<p>å…ˆå®Œæˆçš„å…ˆç­‰ç€ï¼Œç­‰å¾…å…¶å®ƒåˆ†æ”¯ä»»åŠ¡</p>
<p>codeæ ‡å‡†ç‰ˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture1</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture2</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">completableFuture1</span><span class="o">.</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">completableFuture2</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>main	&mdash;come in</p>
<p>30</p>
</blockquote>
<p>codeè¡¨è¾¾å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo5</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}),</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">30</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}),</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in 1</p>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in 2</p>
<p>main	&mdash;come in 3</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in 4</p>
<p>main	&mdash;come in 5</p>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>60</p>
</blockquote>
<h2 id="é”">é”</h2>
<h3 id="synchronized">synchronized</h3>
<ol>
<li>
<p>ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰å®ä¾‹ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰éœ€è¦å…ˆè·å–å®ä¾‹çš„é”</p>
<p>synchronizedå®ä¾‹æ–¹æ³•å®é™…ä¿æŠ¤çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œç¡®ä¿åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚å†å…·ä½“æ¥è¯´ï¼Œsynchronizedå®ä¾‹æ–¹æ³•ä¿æŠ¤çš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ï¼Œå³thisã€‚thiså¯¹è±¡æœ‰ä¸€ä¸ªé”å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œå…¶ä»–è¯•å›¾è·å¾—åŒæ ·é”çš„çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚</p>
<p>ä¸€èˆ¬åœ¨ä¿æŠ¤å˜é‡æ—¶ï¼Œéœ€è¦åœ¨æ‰€æœ‰è®¿é—®è¯¥å˜é‡çš„æ–¹æ³•ä¸ŠåŠ ä¸Šsynchronizedã€‚</p>
</li>
<li>
<p>ä¿®é¥°é™æ€æ–¹æ³•ï¼Œä½œç”¨äºç±»çš„Classå¯¹è±¡ï¼Œè¿›å…¥ä¿®é¥°çš„é™æ€æ–¹æ³•å‰éœ€è¦å…ˆè·å–ç±»çš„Classå¯¹è±¡çš„é”</p>
</li>
<li>
<p>ä¿®é¥°ä»£ç å—ï¼Œéœ€è¦æŒ‡å®šåŠ é”å¯¹è±¡(è®°åšlockobj)ï¼Œåœ¨è¿›å…¥åŒæ­¥ä»£ç å—å‰éœ€è¦å…ˆè·å–lockobjçš„é”</p>
</li>
</ol>
<h4 id="å¯é‡å…¥æ€§">å¯é‡å…¥æ€§</h4>
<p>æ¯ä¸ªé”å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ª<code>é”è®¡æ•°å™¨</code>å’Œä¸€ä¸ª<code>æŒ‡å‘æŒæœ‰è¯¥é”çš„çº¿ç¨‹çš„æŒ‡é’ˆ</code>ã€‚</p>
<p>å½“æ‰§è¡Œmonitorenteræ—¶ï¼Œå¦‚æœç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ºé›¶ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒæ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ‰€æŒæœ‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†è¯¥é”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶è®¡æ•°å™¨åŠ 1ã€‚</p>
<p>åœ¨ç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ä¸ºé›¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºå¯ä»¥å°†å…¶è®¡æ•°å™¨åŠ 1ï¼Œå¦åˆ™éœ€è¦ç­‰å¾…ï¼Œç›´è‡³æŒæœ‰çº¿ç¨‹é‡Šæ”¾è¯¥é”ã€‚</p>
<p>å½“æ‰§è¡Œmonitorexitæ—¶ï¼ŒJavaè™šæ‹Ÿæœºåˆ™éœ€å°†é”å¯¹è±¡çš„è®¡æ•°å™¨å‡1ã€‚è®¡æ•°å™¨ä¸ºé›¶ä»£è¡¨é”å·²è¢«é‡Šæ”¾ã€‚</p>
<h4 id="å†…å­˜å¯è§æ€§">å†…å­˜å¯è§æ€§</h4>
<p>synchronizedé™¤äº†ä¿è¯åŸå­æ“ä½œå¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨ï¼Œå°±æ˜¯ä¿è¯å†…å­˜å¯è§æ€§ï¼Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œæ‰€æœ‰å†™å…¥éƒ½ä¼šå†™å›å†…å­˜ï¼Œè€Œè·å¾—é”åï¼Œéƒ½ä¼šä»å†…å­˜ä¸­è¯»æœ€æ–°æ•°æ®ã€‚</p>
<p>ä¸è¿‡ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†ä¿è¯å†…å­˜å¯è§æ€§ï¼Œä½¿ç”¨synchronizedçš„æˆæœ¬æœ‰ç‚¹é«˜ï¼Œæœ‰ä¸€ä¸ªæ›´è½»é‡çº§çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯ç»™å˜é‡åŠ ä¿®é¥°ç¬¦volatileã€‚</p>
<p>åŠ äº†volatileä¹‹åï¼ŒJavaä¼šåœ¨æ“ä½œå¯¹åº”å˜é‡æ—¶æ’å…¥ç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œä¿è¯è¯»å†™åˆ°å†…å­˜æœ€æ–°å€¼ï¼Œè€Œéç¼“å­˜çš„å€¼ã€‚</p>
<h3 id="lock">Lock</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨finallyå—ä¸­é‡Šæ”¾é”ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨è·å–åˆ°é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚</p>
<p>ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨tryå—ä¸­ï¼Œå› ä¸ºå¦‚æœåœ¨è·å–é”ï¼ˆè‡ªå®šä¹‰é”çš„å®ç°ï¼‰æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸æŠ›å‡ºçš„åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´é”æ— æ•…é‡Šæ”¾ã€‚</p>
<p><img src="/image/lock.png" alt="lock"></p>
<p>1ï¼‰lock()/unlock()ï¼šå°±æ˜¯æ™®é€šçš„è·å–é”å’Œé‡Šæ”¾é”æ–¹æ³•ï¼Œlock()ä¼šé˜»å¡ç›´åˆ°æˆåŠŸã€‚</p>
<p>2ï¼‰lockInterruptibly()ï¼šä¸lock()çš„ä¸åŒæ˜¯ï¼Œå®ƒå¯ä»¥å“åº”ä¸­æ–­ï¼Œå¦‚æœè¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­äº†ï¼Œåˆ™æŠ›å‡ºInterruptedExceptionã€‚</p>
<p>3ï¼‰tryLock()ï¼šåªæ˜¯å°è¯•è·å–é”ï¼Œç«‹å³è¿”å›ï¼Œä¸é˜»å¡ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>4ï¼‰tryLock(long time, TimeUnit unit)ï¼šå…ˆå°è¯•è·å–é”ï¼Œå¦‚æœèƒ½æˆåŠŸåˆ™ç«‹å³è¿”å›trueï¼Œå¦åˆ™é˜»å¡ç­‰å¾…ï¼Œä½†ç­‰å¾…çš„æœ€é•¿æ—¶é—´ç”±æŒ‡å®šçš„å‚æ•°è®¾ç½®ï¼Œåœ¨ç­‰å¾…çš„åŒæ—¶å“åº”ä¸­æ–­ã€‚å¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœåœ¨ç­‰å¾…çš„æ—¶é—´å†…è·å¾—äº†é”ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>5ï¼‰newConditionï¼šæ–°å»ºä¸€ä¸ªæ¡ä»¶ï¼Œä¸€ä¸ªLockå¯ä»¥å…³è”å¤šä¸ªæ¡ä»¶ã€‚</p>
<h3 id="synchronized-vs-lock">synchronized VS Lock</h3>
<ol>
<li>synchronizedæ˜¯Javaå†…ç½®å…³é”®å­—ï¼Œåœ¨JVMå±‚é¢ï¼ŒLockæ˜¯ä¸ªJavaç±»ï¼›</li>
<li>synchronizedæ— æ³•åˆ¤æ–­æ˜¯å¦è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼›</li>
<li>synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”(a çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ä¼šé‡Šæ”¾é” ï¼›b çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¼šé‡Šæ”¾é”)ï¼ŒLockéœ€åœ¨finallyä¸­æ‰‹å·¥é‡Šæ”¾é”ï¼ˆunlock()æ–¹æ³•é‡Šæ”¾é”ï¼‰ï¼Œå¦åˆ™å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”ï¼›</li>
<li>ç”¨synchronizedå…³é”®å­—çš„ä¸¤ä¸ªçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œå¦‚æœå½“å‰çº¿ç¨‹1è·å¾—é”ï¼Œçº¿ç¨‹2çº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœçº¿ç¨‹1é˜»å¡ï¼Œçº¿ç¨‹2åˆ™ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œè€ŒLocké”å°±ä¸ä¸€å®šä¼šç­‰å¾…ä¸‹å»ï¼Œå¦‚æœå°è¯•è·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾…å°±ç»“æŸäº†ï¼›</li>
<li>synchronizedçš„é”å¯é‡å…¥ã€ä¸å¯ä¸­æ–­ã€éå…¬å¹³ï¼Œè€ŒLocké”å¯é‡å…¥ã€å¯åˆ¤æ–­ã€å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰</li>
<li>synchronizedé”é€‚åˆä»£ç å°‘é‡çš„åŒæ­¥é—®é¢˜ï¼ŒLocké”é€‚åˆå¤§é‡åŒæ­¥ä»£ç çš„åŒæ­¥é—®é¢˜ï¼Œã€‚</li>
</ol>
<h3 id="reentrantlock">ReentrantLock</h3>
<p>ReentrantLockæ˜¯Lockçš„é»˜è®¤å®ç°ï¼š</p>
<ol>
<li>
<p>å¯é‡å…¥é”ï¼šå¯é‡å…¥é”æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å¾—åŒä¸€æŠŠé”ï¼›ReentrantLockå’Œå…³é”®å­—Synchronizedéƒ½æ˜¯å¯é‡å…¥é”</p>
</li>
<li>
<p>å¯ä¸­æ–­é”ï¼šå¯ä¸­æ–­é”æ—¶å­çº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å¯ä»¥ç›¸åº”çº¿ç¨‹ä¸­æ–­æ“ä½œã€‚synchronizedæ˜¯ä¸å¯ä¸­æ–­çš„ï¼ŒReentrantLockæ˜¯å¯ä¸­æ–­çš„</p>
</li>
<li>
<p>å…¬å¹³é”å’Œéå…¬å¹³é”ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹å°è¯•è·å–åŒä¸€æŠŠé”çš„æ—¶å€™ï¼Œè·å–é”çš„é¡ºåºæŒ‰ç…§çº¿ç¨‹åˆ°è¾¾çš„å…ˆåé¡ºåºè·å–ï¼Œè€Œä¸æ˜¯éšæœºæ’é˜Ÿçš„æ–¹å¼è·å–ã€‚synchronizedæ˜¯éå…¬å¹³é”ï¼Œè€ŒReentrantLockæ˜¯ä¸¤ç§éƒ½å¯ä»¥å®ç°ï¼Œä¸è¿‡é»˜è®¤æ˜¯éå…¬å¹³é”</p>
<p>åœ¨æµ‹è¯•ä¸­å…¬å¹³æ€§é”ä¸éå…¬å¹³æ€§é”ç›¸æ¯”ï¼Œæ€»è€—æ—¶æ˜¯å…¶94.3å€ï¼Œæ€»åˆ‡æ¢æ¬¡æ•°æ˜¯å…¶133å€ã€‚å¯ä»¥çœ‹å‡ºï¼Œå…¬å¹³æ€§é”ä¿è¯äº†é”çš„è·å–æŒ‰ç…§FIFOåŸåˆ™ï¼Œè€Œä»£ä»·æ˜¯è¿›è¡Œå¤§é‡çš„çº¿ç¨‹åˆ‡æ¢ã€‚éå…¬å¹³æ€§é”è™½ç„¶å¯èƒ½é€ æˆçº¿ç¨‹â€œé¥¥é¥¿â€ï¼Œä½†æå°‘çš„çº¿ç¨‹åˆ‡æ¢ï¼Œä¿è¯äº†å…¶æ›´å¤§çš„ååé‡ã€‚</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Creates an instance of {@code ReentrantLock}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This is equivalent to using {@code ReentrantLock(false)}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Creates an instance of {@code ReentrantLock} with the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * given fairness policy.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param fair {@code true} if this lock should use a fair ordering policy
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fair</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="n">fair</span> <span class="o">?</span> <span class="k">new</span> <span class="n">FairSync</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="reentrantlockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„">ReentrantLockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„</h3>
<p>å¯¹äºsynchronizedå…³é”®å­—ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…è·å–é”ï¼Œæœ€ç»ˆåªæœ‰2ç§ç»“æœï¼š</p>
<ol>
<li>è¦ä¹ˆè·å–åˆ°é”ç„¶åç»§ç»­åé¢çš„æ“ä½œ</li>
<li>è¦ä¹ˆä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”ä¸ºæ­¢</li>
</ol>
<p>è€ŒReentrantLockæä¾›äº†å¦å¤–ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼ˆ<strong>å‘èµ·è·å–é”è¯·æ±‚åˆ°è¿˜æœªè·å–åˆ°é”è¿™æ®µæ—¶é—´å†…</strong>ï¼‰æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦å–æ¶ˆè·å–é”çš„è¯·æ±‚ã€‚æœ‰äº›ä½¿ç”¨è¿™ä¸ªæ“ä½œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>å…³äºè·å–é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œæ³¨æ„å‡ ç‚¹:</p>
<ol>
<li><strong>ReentrankLockä¸­å¿…é¡»ä½¿ç”¨å®ä¾‹æ–¹æ³•<code>lockInterruptibly()</code>è·å–é”æ—¶ï¼Œåœ¨çº¿ç¨‹è°ƒç”¨interrupt()æ–¹æ³•ä¹‹åï¼Œæ‰ä¼šå¼•å‘<code>InterruptedException</code>å¼‚å¸¸</strong></li>
<li><strong>çº¿ç¨‹è°ƒç”¨interrupt()ä¹‹åï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¼šè¢«ç½®ä¸ºtrue</strong></li>
<li><strong>è§¦å‘InterruptedExceptionå¼‚å¸¸ä¹‹åï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¼šè¢«æ¸…ç©ºï¼Œå³ç½®ä¸ºfalse</strong></li>
<li><strong>æ‰€ä»¥å½“çº¿ç¨‹è°ƒç”¨interrupt()å¼•å‘InterruptedExceptionå¼‚å¸¸ï¼Œä¸­æ–­æ ‡å¿—çš„å˜åŒ–æ˜¯:false-&gt;true-&gt;false</strong></li>
</ol>
<h3 id="synchronized-vs-reentrantlock">synchronized VS ReentrantLock</h3>
<p>ç›¸æ¯”synchronized, ReentrantLockå¯ä»¥å®ç°ä¸synchronizedç›¸åŒçš„è¯­ä¹‰ï¼Œè€Œä¸”æ”¯æŒä»¥éé˜»å¡æ–¹å¼è·å–é”ï¼Œå¯ä»¥å“åº”ä¸­æ–­ï¼Œå¯ä»¥é™æ—¶ï¼Œæ›´ä¸ºçµæ´»ã€‚ä¸è¿‡ï¼Œsynchronizedçš„ä½¿ç”¨æ›´ä¸ºç®€å•ï¼Œå†™çš„ä»£ç æ›´å°‘ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™ã€‚</p>
<ul>
<li>synchronizedä»£è¡¨ä¸€ç§å£°æ˜å¼ç¼–ç¨‹æ€ç»´ï¼Œç¨‹åºå‘˜æ›´å¤šçš„æ˜¯è¡¨è¾¾ä¸€ç§åŒæ­¥å£°æ˜ï¼Œç”±Javaç³»ç»Ÿè´Ÿè´£å…·ä½“å®ç°ï¼Œç¨‹åºå‘˜ä¸çŸ¥é“å…¶å®ç°ç»†èŠ‚ï¼›</li>
<li>æ˜¾å¼é”ä»£è¡¨ä¸€ç§å‘½ä»¤å¼ç¼–ç¨‹æ€ç»´ï¼Œç¨‹åºå‘˜å®ç°æ‰€æœ‰ç»†èŠ‚ã€‚</li>
</ul>
<p>å£°æ˜å¼ç¼–ç¨‹çš„å¥½å¤„é™¤äº†ç®€å•ï¼Œè¿˜åœ¨äºæ€§èƒ½ï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„JVMä¸Šï¼ŒReentrantLockå’Œsynchronizedçš„æ€§èƒ½æ˜¯æ¥è¿‘çš„ï¼Œä½†Javaç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå¯ä»¥ä¸æ–­ä¼˜åŒ–synchronizedçš„å®ç°ï¼Œæ¯”å¦‚è‡ªåŠ¨åˆ†æsynchronizedçš„ä½¿ç”¨ï¼Œå¯¹äºæ²¡æœ‰é”ç«äº‰çš„åœºæ™¯ï¼Œè‡ªåŠ¨çœç•¥å¯¹é”è·å–/é‡Šæ”¾çš„è°ƒç”¨ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸‹ï¼Œèƒ½ç”¨synchronizedå°±ç”¨synchronizedï¼Œä¸æ»¡è¶³è¦æ±‚æ—¶å†è€ƒè™‘ReentrantLockã€‚</p>
<h3 id="æ‚²è§‚é”">æ‚²è§‚é”</h3>
<p>è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚</p>
<p>synchronizedå…³é”®å­—å’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”</p>
<p>é€‚åˆå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œå…ˆåŠ é”å¯ä»¥ä¿è¯å†™æ“ä½œæ—¶æ•°æ®æ­£ç¡®ã€‚</p>
<p>æ˜¾å¼çš„é”å®šä¹‹åå†æ“ä½œåŒæ­¥èµ„æº</p>
<h3 id="ä¹è§‚é”">ä¹è§‚é”</h3>
<p>ä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šæ·»åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ›´æ–°äº†è¿™ä¸ªæ•°æ®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹å°†è‡ªå·±ä¿®æ”¹çš„æ•°æ®æˆåŠŸå†™å…¥ã€‚å¦‚æœæ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼Œåˆ™æ ¹æ®ä¸åŒçš„å®ç°æ–¹å¼æ‰§è¡Œä¸åŒçš„æ“ä½œ</p>
<p>ä¹è§‚é”åœ¨Javaä¸­æ˜¯é€šè¿‡ä½¿ç”¨æ— é”ç¼–ç¨‹æ¥å®ç°ï¼Œæœ€å¸¸é‡‡ç”¨çš„æ˜¯CASç®—æ³•ï¼ŒJavaåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±é€šè¿‡CASè‡ªæ—‹å®ç°çš„ã€‚</p>
<p>é€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¸åŠ é”çš„ç‰¹ç‚¹èƒ½å¤Ÿä½¿å…¶è¯»æ“ä½œçš„æ€§èƒ½å¤§å¹…æå‡ã€‚</p>
<p>ä¹è§‚é”åˆ™ç›´æ¥å»æ“ä½œåŒæ­¥èµ„æºï¼Œæ˜¯ä¸€ç§æ— é”ç®—æ³•ã€‚</p>
<p>ä¹è§‚é”ä¸€èˆ¬æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>é‡‡ç”¨ç‰ˆæœ¬å·æœºåˆ¶</li>
<li>CASï¼ˆCompare-and-Swapï¼Œå³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼‰ç®—æ³•å®ç°</li>
</ol>
<h3 id="å¯é‡å…¥é”åˆåé€’å½’é”">å¯é‡å…¥é”(åˆåé€’å½’é”)</h3>
<p>æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”(å‰æï¼Œé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡)ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚</p>
<p>å¦‚æœæ˜¯1ä¸ªæœ‰ synchronized ä¿®é¥°çš„é€’å½’è°ƒç”¨æ–¹æ³•ï¼Œç¨‹åºç¬¬2æ¬¡è¿›å…¥è¢«è‡ªå·±é˜»å¡äº†å²‚ä¸æ˜¯å¤©å¤§çš„ç¬‘è¯ï¼Œå‡ºç°äº†ä½œèŒ§è‡ªç¼šã€‚æ‰€ä»¥Javaä¸­ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚</p>
<h3 id="æ’æŸ¥æ­»é”">æ’æŸ¥æ­»é”</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jps -l
</span></span><span class="line"><span class="cl">jstack è¿›ç¨‹ç¼–å·
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="çº¿ç¨‹ä¸­æ–­">çº¿ç¨‹ä¸­æ–­</h2>
<p>é¦–å…ˆ ä¸€ä¸ªçº¿ç¨‹ä¸åº”è¯¥ç”±å…¶ä»–çº¿ç¨‹æ¥å¼ºåˆ¶ä¸­æ–­æˆ–åœæ­¢ï¼Œè€Œæ˜¯åº”è¯¥ç”±çº¿ç¨‹è‡ªå·±è‡ªè¡Œåœæ­¢ã€‚æ‰€ä»¥ï¼ŒThread.stop, Thread.suspend, Thread.resume éƒ½å·²ç»è¢«åºŸå¼ƒäº†ã€‚</p>
<p>å…¶æ¬¡ åœ¨Javaä¸­æ²¡æœ‰åŠæ³•ç«‹å³åœæ­¢ä¸€æ¡çº¿ç¨‹ï¼Œç„¶è€Œåœæ­¢çº¿ç¨‹å´æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œå¦‚å–æ¶ˆä¸€ä¸ªè€—æ—¶æ“ä½œã€‚å› æ­¤ï¼ŒJavaæä¾›äº†ä¸€ç§ç”¨äºåœæ­¢çº¿ç¨‹çš„æœºåˆ¶â€”â€”ä¸­æ–­ã€‚</p>
<p>ä¸­æ–­åªæ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼ŒJavaæ²¡æœ‰ç»™ä¸­æ–­å¢åŠ ä»»ä½•è¯­æ³•ï¼Œä¸­æ–­çš„è¿‡ç¨‹å®Œå…¨éœ€è¦ç¨‹åºå‘˜è‡ªå·±å®ç°ã€‚è‹¥è¦ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œä½ éœ€è¦æ‰‹åŠ¨è°ƒç”¨è¯¥çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¹Ÿä»…ä»…æ˜¯å°†çº¿ç¨‹å¯¹è±¡çš„ä¸­æ–­æ ‡è¯†è®¾æˆtrueï¼›æ¥ç€ä½ éœ€è¦è‡ªå·±å†™ä»£ç ä¸æ–­åœ°æ£€æµ‹å½“å‰çº¿ç¨‹çš„æ ‡è¯†ä½ï¼Œå¦‚æœä¸ºtrueï¼Œè¡¨ç¤ºåˆ«çš„çº¿ç¨‹è¦æ±‚è¿™æ¡çº¿ç¨‹ä¸­æ–­ï¼Œ æ­¤æ—¶ç©¶ç«Ÿè¯¥åšä»€ä¹ˆéœ€è¦ä½ è‡ªå·±å†™ä»£ç å®ç°ã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªæ ‡è¯†ï¼Œç”¨äºè¡¨ç¤ºçº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼›è¯¥æ ‡è¯†ä½ä¸ºtrueè¡¨ç¤ºä¸­æ–­ï¼Œä¸ºfalseè¡¨ç¤ºæœªä¸­æ–­ï¼›é€šè¿‡è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„interruptæ–¹æ³•å°†è¯¥çº¿ç¨‹çš„æ ‡è¯†ä½è®¾ä¸ºtrueï¼›å¯ä»¥åœ¨åˆ«çš„çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</p>
<p>å¦‚ä½•ä½¿ç”¨ä¸­æ–­æ ‡è¯†åœæ­¢çº¿ç¨‹ï¼Ÿ</p>
<p>åœ¨éœ€è¦ä¸­æ–­çš„çº¿ç¨‹ä¸­ä¸æ–­ç›‘å¬ä¸­æ–­çŠ¶æ€ï¼Œä¸€æ—¦å‘ç”Ÿä¸­æ–­ï¼Œå°±æ‰§è¡Œç›¸åº”çš„ä¸­æ–­å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚</p>
<h3 id="1é€šè¿‡ä¸€ä¸ªvolatileå˜é‡">1ã€é€šè¿‡ä¸€ä¸ªvolatileå˜é‡</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InterruptDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isStop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">isStop</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;çº¿ç¨‹------isStop = true,è‡ªå·±é€€å‡ºäº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-------hello interrupt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&hellip;</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>&mdash;&mdash;-hello interrupt</p>
<p>t1çº¿ç¨‹&mdash;&mdash;isStop = true,è‡ªå·±é€€å‡ºäº†</p>
</blockquote>
<h3 id="2é€šè¿‡atomicboolean">2ã€é€šè¿‡AtomicBoolean</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThreadDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">AtomicBoolean</span> <span class="n">atomicBoolean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">atomicBoolean</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----hello&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">atomicBoolean</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>&mdash;&ndash;hello</p>
<p>&mdash;&ndash;hello</p>
<p>&mdash;&ndash;hello</p>
<p>&mdash;&ndash;hello</p>
<p>&mdash;&ndash;hello</p>
<p>&mdash;&ndash;hello</p>
</blockquote>
<h3 id="3é€šè¿‡threadç±»è‡ªå¸¦çš„ä¸­æ–­apiæ–¹æ³•">3ã€é€šè¿‡Threadç±»è‡ªå¸¦çš„ä¸­æ–­apiæ–¹æ³•</h3>
<h4 id="1å®ä¾‹æ–¹æ³•interruptæ²¡æœ‰è¿”å›å€¼">(1)ã€å®ä¾‹æ–¹æ³•interrupt()ï¼Œæ²¡æœ‰è¿”å›å€¼</h4>
<p>è°ƒç”¨interrupt()æ–¹æ³•ä»…ä»…æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰“äº†ä¸€ä¸ªåœæ­¢çš„æ ‡è®°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£ç«‹åˆ»åœæ­¢çº¿ç¨‹ã€‚</p>
<p><img src="/image/interrupt-annotation.png" alt="interrupt-annotation"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public void interrupt() {
</span></span><span class="line"><span class="cl">    if (this != Thread.currentThread())
</span></span><span class="line"><span class="cl">        checkAccess();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    synchronized (blockerLock) {
</span></span><span class="line"><span class="cl">        Interruptible b = blocker;
</span></span><span class="line"><span class="cl">        if (b != null) {
</span></span><span class="line"><span class="cl">            interrupt0();           // Just to set the interrupt flag
</span></span><span class="line"><span class="cl">            b.interrupt(this);
</span></span><span class="line"><span class="cl">            return;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    interrupt0();
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2å®ä¾‹æ–¹æ³•isinterruptedè¿”å›å¸ƒå°”å€¼">(2)ã€å®ä¾‹æ–¹æ³•isInterruptedï¼Œè¿”å›å¸ƒå°”å€¼</h4>
<p>è·å–ä¸­æ–­æ ‡å¿—ä½çš„å½“å‰å€¼æ˜¯ä»€ä¹ˆ
åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼ˆé€šè¿‡æ£€æŸ¥ä¸­æ–­æ ‡å¿—ä½ï¼‰ï¼Œé»˜è®¤æ˜¯false</p>
<h4 id="3é™æ€æ–¹æ³•threadinterrupted">(3)ã€é™æ€æ–¹æ³•Thread.interrupted()</h4>
<p>åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤å½“å‰ä¸­æ–­çŠ¶æ€ï¼Œç±»ä¼¼i++</p>
<p>è¿™ä¸ªæ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>è¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</li>
<li>å°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è®¾ä¸ºfalse</li>
</ul>
<p><img src="/image/interrupted.png" alt="interrupted"></p>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æµ‹è¯•å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼ˆæ£€æŸ¥ä¸­æ–­æ ‡å¿—ï¼‰ï¼Œè¿”å›ä¸€ä¸ªbooleanå¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ç¬¬äºŒæ¬¡å†è°ƒç”¨æ—¶ä¸­æ–­çŠ¶æ€å·²ç»è¢«æ¸…é™¤ï¼Œå°†è¿”å›ä¸€ä¸ªfalseã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InterruptDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;111111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;222222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>main&mdash;false</p>
<p>main&mdash;false</p>
<p>111111</p>
<p>222222</p>
<p>main&mdash;true</p>
<p>main&mdash;false</p>
</blockquote>
<p>å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä¸ºtrueï¼Œæ˜¯ä¸æ˜¯å°±ç«‹åˆ»åœæ­¢ï¼Ÿ</p>
<p>å…·ä½“æ¥è¯´ï¼Œå½“å¯¹ä¸€ä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨ interrupt() æ—¶ï¼š</p>
<p>â‘  å¦‚æœçº¿ç¨‹å¤„äºæ­£å¸¸æ´»åŠ¨çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šå°†è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—è®¾ç½®ä¸º trueï¼Œä»…æ­¤è€Œå·²ã€‚ è¢«è®¾ç½®ä¸­æ–­æ ‡å¿—çš„çº¿ç¨‹å°†ç»§ç»­æ­£å¸¸è¿è¡Œï¼Œä¸å—å½±å“ã€‚æ‰€ä»¥ï¼Œ interrupt() å¹¶ä¸èƒ½çœŸæ­£çš„ä¸­æ–­çº¿ç¨‹ï¼Œéœ€è¦è¢«è°ƒç”¨çš„çº¿ç¨‹è‡ªå·±è¿›è¡Œé…åˆæ‰è¡Œã€‚</p>
<p>â‘¡ å¦‚æœçº¿ç¨‹å¤„äºè¢«é˜»å¡çŠ¶æ€ï¼ˆä¾‹å¦‚å¤„äºsleep, wait, join ç­‰çŠ¶æ€ï¼‰ï¼Œåœ¨åˆ«çš„çº¿ç¨‹ä¸­è°ƒç”¨å½“å‰çº¿ç¨‹å¯¹è±¡çš„interruptæ–¹æ³•ï¼Œ é‚£ä¹ˆçº¿ç¨‹å°†ç«‹å³é€€å‡ºè¢«é˜»å¡çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªInterruptedExceptionå¼‚å¸¸ã€‚</p>
<h2 id="locksupport">LockSupport</h2>
<h3 id="03ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çš„æ–¹æ³•">0ã€3ç§è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’çš„æ–¹æ³•</h3>
<ol>
<li>Objectä¸­çš„wait()æ–¹æ³•è®©çº¿ç¨‹ç­‰å¾…ï¼Œnotify()æ–¹æ³•å”¤é†’çº¿ç¨‹</li>
<li>JUCåŒ…ä¸­Conditionçš„await()æ–¹æ³•è®©çº¿ç¨‹ç­‰å¾…ï¼Œsignal()æ–¹æ³•å”¤é†’çº¿ç¨‹</li>
<li>LockSupportç±»ä¸­çš„park()é˜»å¡çº¿ç¨‹ï¼Œunpark()è§£é™¤é˜»å¡çº¿ç¨‹</li>
</ol>
<h3 id="1objectç±»ä¸­çš„waitå’Œnotifyæ–¹æ³•">1ã€Objectç±»ä¸­çš„waitå’Œnotifyæ–¹æ³•</h3>
<ul>
<li>æ­£å¸¸ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">objectLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">objectLock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span><span class="c1">//----------------------è¿™é‡Œå…ˆè®©ä»–ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---è¢«å”¤é†’äº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">objectLock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span><span class="c1">//-------------------------å†å”¤é†’å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---å‘å‡ºé€šçŸ¥&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t1	 &mdash;come in</p>
<p>t2	 &mdash;å‘å‡ºé€šçŸ¥</p>
<p>t1	 &mdash;è¢«å”¤é†’äº†</p>
</blockquote>
<ul>
<li>å¼‚å¸¸1ï¼šå»æ‰synchronized</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">objectLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            synchronized (objectLock) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">objectLock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span><span class="c1">//----------------------è¿™é‡Œå…ˆè®©ä»–ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---è¢«å”¤é†’äº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            synchronized (objectLock) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">objectLock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span><span class="c1">//-------------------------å†å”¤é†’å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---å‘å‡ºé€šçŸ¥&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t1	 &mdash;come in</p>
<p>Exception in thread &ldquo;t1&rdquo; java.lang.IllegalMonitorStateException</p>
<p>â€‹	at java.lang.Object.wait(Native Method)</p>
<p>â€‹	&hellip;
Exception in thread &ldquo;t2&rdquo; java.lang.IllegalMonitorStateException</p>
<p>â€‹	at java.lang.Object.notify(Native Method)</p>
<p>â€‹	&hellip;</p>
</blockquote>
<ul>
<li>å¼‚å¸¸2ï¼šæŠŠnotifyå’Œwaitçš„æ‰§è¡Œé¡ºåºå¯¹æ¢</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">objectLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">objectLock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span><span class="c1">//----------------------è¿™é‡Œå…ˆè®©ä»–ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---è¢«å”¤é†’äº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">objectLock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span><span class="c1">//-------------------------å†å”¤é†’å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t ---å‘å‡ºé€šçŸ¥&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€ç›´å¤„äºè¿è¡Œä¸­ï¼Œæ— æ³•åœæ­¢ï¼š</p>
<blockquote>
<p>t2	 &mdash;å‘å‡ºé€šçŸ¥</p>
<p>t1	 &mdash;come in</p>
</blockquote>
<p>æ€»ç»“ï¼š</p>
<p>Objectä¸­çš„waitå’Œnotifyæ–¹æ³•å¿…é¡»</p>
<ul>
<li>è¦åœ¨åŒæ­¥å—æˆ–è€…æ–¹æ³•é‡Œé¢</li>
<li>å…ˆwaitånotifyçš„é¡ºåºæˆå¯¹ä½¿ç”¨</li>
</ul>
<h3 id="2conditionæ¥å£ä¸­çš„awaitå’Œsignalæ–¹æ³•">2ã€Conditionæ¥å£ä¸­çš„awaitå’Œsignalæ–¹æ³•</h3>
<ul>
<li>æ­£å¸¸ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t -----come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t -----è¢«å”¤é†’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">condition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;æˆ‘è¦è¿›è¡Œå”¤é†’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t1	 &mdash;&ndash;come in</p>
<p>t2	æˆ‘è¦è¿›è¡Œå”¤é†’</p>
<p>t1	 &mdash;&ndash;è¢«å”¤é†’</p>
</blockquote>
<ul>
<li>å¼‚å¸¸1åŸç†åŒä¸Š
<ul>
<li>ä»ç„¶è¿”å›<code>IllegalMonitorStateException</code></li>
</ul>
</li>
<li>å¼‚å¸¸2åŸç†åŒä¸Š
<ul>
<li>ä»ç„¶åœ¨ä¸åœåœ°å¾ªç¯</li>
</ul>
</li>
</ul>
<p>æ€»ç»“ï¼š</p>
<p>Condtionä¸­çš„awaitå’Œnotifyæ–¹æ³•å¿…é¡»</p>
<ul>
<li>å…ˆè·å–é”</li>
<li>å…ˆawaitåsignal</li>
</ul>
<p>Objectå’ŒConditionä½¿ç”¨çš„é™åˆ¶æ¡ä»¶ï¼š</p>
<ul>
<li>çº¿ç¨‹å…ˆè¦è·å¾—å¹¶æŒæœ‰é”ï¼Œå¿…é¡»åœ¨é”å—(synchronizedæˆ–lock)ä¸­</li>
<li>å¿…é¡»è¦å…ˆç­‰å¾…åå”¤é†’ï¼Œçº¿ç¨‹æ‰èƒ½å¤Ÿè¢«å”¤é†’</li>
</ul>
<h3 id="3locksupportç±»ä¸­çš„parkç­‰å¾…å’Œunparkå”¤é†’">3ã€LockSupportç±»ä¸­çš„parkç­‰å¾…å’Œunparkå”¤é†’</h3>
<p>é€šè¿‡park()å’Œunpark(thread)æ–¹æ³•æ¥å®ç°é˜»å¡å’Œå”¤é†’çº¿ç¨‹</p>
<ul>
<li>æ­£å¸¸+æ— é”å—è¦æ±‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------è¢«å”¤é†’äº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t-----å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t1	&mdash;&mdash;&mdash;-come in</p>
<p>t2	&mdash;&ndash;å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1</p>
<p>t1	&mdash;&mdash;&mdash;-è¢«å”¤é†’äº†</p>
</blockquote>
<ul>
<li>ä¹‹å‰é”™è¯¯çš„å…ˆå”¤é†’åç­‰å¾…ï¼ŒLockSupportç…§æ ·æ”¯æŒ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------come in&#34;</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------è¢«å”¤é†’äº†&#34;</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t-----å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t2	&mdash;&ndash;å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1</p>
<p>t1	&mdash;&mdash;&mdash;-come in	1660201673319</p>
<p>t1	&mdash;&mdash;&mdash;-è¢«å”¤é†’äº†	1660201673319</p>
</blockquote>
<ul>
<li>æˆåŒæˆå¯¹è¦ç‰¢è®°</li>
<li>è®¸å¯è¯åªæœ‰ä¸€ä¸ª</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------come in&#34;</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t----------è¢«å”¤é†’äº†&#34;</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t-----å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t2  &mdash;&ndash;å‘å‡ºé€šçŸ¥ï¼Œå»å”¤é†’t1</p>
<p>t1  &mdash;&mdash;&mdash;-come in  1654750970677&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;å¡åœ¨è¿™é‡Œäº†</p>
</blockquote>
<p>Lock Supportå’Œæ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯(permit) å…³è”ã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„permitï¼Œ permitæœ€å¤šåªæœ‰ä¸€ä¸ªï¼Œ é‡å¤è°ƒç”¨unparkä¹Ÿä¸ä¼šç§¯ç´¯å‡­è¯ã€‚</p>
<h3 id="4æ€»ç»“">4ã€æ€»ç»“ï¼š</h3>
<p>LockSupportæ˜¯ç”¨æ¥åˆ›å»º<code>é”å’Œå…¶ä»–åŒæ­¥ç±»</code>çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚</p>
<p>LockSupportç±»ä½¿ç”¨äº†ä¸€ç§åä¸ºPermitï¼ˆè®¸å¯ï¼‰ çš„æ¦‚å¿µæ¥åšåˆ°é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯(permit)ã€‚</p>
<p>permitï¼ˆè®¸å¯ï¼‰åªæœ‰ä¸¤ä¸ªå€¼1å’Œ0ï¼Œé»˜è®¤æ˜¯0ï¼Œ0 æ˜¯é˜»å¡ï¼Œ1æ˜¯å”¤é†’ã€‚</p>
<p>å¯ä»¥æŠŠè®¸å¯çœ‹æˆæ˜¯ä¸€ç§(0,1)ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œä½†ä¸ Semaphore ä¸åŒçš„æ˜¯ï¼Œè®¸å¯çš„ç´¯åŠ ä¸Šé™æ˜¯1ã€‚</p>
<h2 id="jmm">JMM</h2>
<p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆjava Memory Modelï¼Œç®€ç§°JMM) æ¥å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚</p>
<p>Javaä¸­æ™®é€šçš„å…±äº«å˜é‡ä¸ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ•°æ®ä¿®æ”¹è¢«å†™å…¥å†…å­˜çš„æ—¶æœºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¤šçº¿ç¨‹å¹¶å‘ä¸‹å¾ˆå¯èƒ½å‡ºç°&quot;è„è¯»&quot;ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œï¼ˆè¯»å–ï¼Œèµ‹å€¼ç­‰ ï¼‰éƒ½å¿…éœ€åœ¨çº¿ç¨‹è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½å¤Ÿç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚ä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p>
<h3 id="happens-beforeè§„åˆ™">happens-beforeè§„åˆ™</h3>
<p>JMMè§„èŒƒä¸‹ï¼Œå¤šçº¿ç¨‹å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹happens-beforeï¼š</p>
<p>åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§æ€§æˆ–è€…ä»£ç é‡æ’åºï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»å­˜åœ¨happens-beforeå…³ç³»ã€‚</p>
<p>JSR-133ä½¿ç”¨happens-beforeçš„æ¦‚å¿µæ¥æŒ‡å®šä¸¤ä¸ªæ“ä½œä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ç”±äºè¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ã€‚å› æ­¤ï¼ŒJMMå¯ä»¥é€šè¿‡happens-beforeå…³ç³»å‘ç¨‹åºå‘˜æä¾›è·¨çº¿ç¨‹çš„å†…å­˜å¯è§æ€§ä¿è¯ï¼ˆå¦‚æœAçº¿ç¨‹çš„å†™æ“ä½œaä¸Bçº¿ç¨‹çš„è¯»æ“ä½œbä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå°½ç®¡aæ“ä½œå’Œbæ“ä½œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†JMMå‘ç¨‹åºå‘˜ä¿è¯aæ“ä½œå°†å¯¹bæ“ä½œå¯è§ï¼‰</p>
<p>ã€ŠJSR-133:Java Memory Model and Thread Specificationã€‹å®šä¹‰äº†å¦‚ä¸‹happens-beforeè§„åˆ™ã€‚</p>
<p>1ï¼‰ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</p>
<p>2ï¼‰ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</p>
<p>3ï¼‰volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚</p>
<p>4ï¼‰ä¼ é€’æ€§ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</p>
<p>5ï¼‰start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚</p>
<p>6ï¼‰join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œhappens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚</p>
<h2 id="volatile">volatile</h2>
<p>è¢«volatileä¿®æ”¹çš„å˜é‡æœ‰2å¤§ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å¯è§æ€§</li>
<li>æœ‰åºæ€§</li>
</ul>
<p>volatileçš„å†…å­˜è¯­ä¹‰ï¼š</p>
<ul>
<li>å½“å†™ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡å€¼ç«‹å³åˆ·æ–°å›ä¸»å†…å­˜ä¸­ã€‚</li>
<li>å½“è¯»ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜è®¾ç½®ä¸ºæ— æ•ˆï¼Œç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡</li>
<li>æ‰€ä»¥volatileçš„å†™å†…å­˜è¯­ä¹‰æ˜¯ç›´æ¥åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œè¯»å†…å­˜è¯­ä¹‰æ˜¯ç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–ã€‚</li>
</ul>
<h3 id="å†…å­˜å±éšœ-memory-barriers--fences">å†…å­˜å±éšœ (Memory Barriers / Fences)</h3>
<p>å†…å­˜å±éšœï¼ˆä¹Ÿç§°å†…å­˜æ …æ ï¼Œå†…å­˜æ …éšœï¼Œå±éšœæŒ‡ä»¤ç­‰ï¼Œæ˜¯ä¸€ç±»åŒæ­¥å±éšœæŒ‡ä»¤ï¼Œæ˜¯CPUæˆ–ç¼–è¯‘å™¨åœ¨å¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œï¼‰ï¼Œé¿å…ä»£ç é‡æ’åºã€‚</p>
<p>å†…å­˜å±éšœå…¶å®å°±æ˜¯ä¸€ç§JVMæŒ‡ä»¤ï¼ŒJavaå†…å­˜æ¨¡å‹çš„é‡æ’è§„åˆ™ä¼šè¦æ±‚Javaç¼–è¯‘å™¨åœ¨ç”ŸæˆJVMæŒ‡ä»¤æ—¶æ’å…¥ç‰¹å®šçš„å†…å­˜å±éšœæŒ‡ä»¤ï¼Œé€šè¿‡è¿™äº›å†…å­˜å±éšœæŒ‡ä»¤ï¼Œvolatileå®ç°äº†Javaå†…å­˜æ¨¡å‹ä¸­çš„å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä½†volatileæ— æ³•ä¿è¯åŸå­æ€§ã€‚</p>
<p>å†…å­˜å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œéƒ½è¦å›å†™åˆ°ä¸»å†…å­˜ï¼Œå†…å­˜å±éšœä¹‹åçš„æ‰€æœ‰è¯»æ“ä½œéƒ½èƒ½è·å¾—å†…å­˜å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œçš„æœ€æ–°ç»“æœ(å®ç°äº†å¯è§æ€§)ã€‚</p>
<p>å› æ­¤é‡æ’åºæ—¶ï¼Œä¸å…è®¸æŠŠå†…å­˜å±éšœä¹‹åçš„æŒ‡ä»¤é‡æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰ã€‚ ä¸€å¥è¯ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™, happens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ï¼Œä¹Ÿå«å†™åè¯»ã€‚</p>
<h3 id="happens-before-ä¹‹-volatile-å˜é‡è§„åˆ™">happens-before ä¹‹ volatile å˜é‡è§„åˆ™</h3>
<p><img src="/image/volatile.png" alt="volatile"></p>
<p>å½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºvolatileè¯»æ—¶ï¼Œä¸è®ºç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªæ“ä½œä¿è¯äº†volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°volatileè¯»ä¹‹å‰ã€‚</p>
<p>å½“ç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileå†™æ—¶ï¼Œä¸è®ºç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªæ“ä½œä¿è¯äº†volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°volatileå†™ä¹‹åã€‚</p>
<p>å½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºvolatileå†™æ—¶ï¼Œç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’ã€‚</p>
<h3 id="jmm-å°±å°†å†…å­˜å±éšœæ’ç­–ç•¥åˆ†ä¸º-4-ç§">JMM å°±å°†å†…å­˜å±éšœæ’â¼Šç­–ç•¥åˆ†ä¸º 4 ç§</h3>
<ul>
<li>è¯»
<ul>
<li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åâ¾¯æ’â¼Šâ¼€ä¸ª LoadLoad å±éšœ</li>
<li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åâ¾¯æ’â¼Šâ¼€ä¸ª LoadStore å±éšœ</li>
</ul>
</li>
<li>å†™
<ul>
<li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰â¾¯æ’â¼Šâ¼€ä¸ª StoreStore å±éšœ</li>
<li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„åâ¾¯æ’â¼Šâ¼€ä¸ª StoreLoad å±éšœ</li>
</ul>
</li>
</ul>
<h3 id="volatileç‰¹æ€§">volatileç‰¹æ€§</h3>
<h3 id="1ä¿è¯å¯è§æ€§">1ã€ä¿è¯å¯è§æ€§</h3>
<p>ä¿è¯ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³å˜é‡ä¸€æ—¦æ”¹å˜æ‰€æœ‰çº¿ç¨‹ç«‹å³å¯è§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileSeeDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>       <span class="c1">//ä¸åŠ volatileï¼Œæ²¡æœ‰å¯è§æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//static volatile boolean flag = true;       //åŠ äº†volatileï¼Œä¿è¯å¯è§æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t flagè¢«ä¿®æ”¹ä¸ºfalse,é€€å‡º.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœ2ç§’é’Ÿåè®©mainçº¿ç¨‹ä¿®æ”¹flagå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;mainçº¿ç¨‹ä¿®æ”¹å®Œæˆ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¸åŠ volatileï¼Œæ²¡æœ‰å¯è§æ€§ï¼Œç¨‹åºæ— æ³•åœæ­¢</li>
</ul>
<blockquote>
<p>t1	 come in</p>
<p>mainçº¿ç¨‹ä¿®æ”¹å®Œæˆ</p>
<p>//å¡ä½äº†</p>
</blockquote>
<ul>
<li>åŠ äº†volatileï¼Œä¿è¯å¯è§æ€§ï¼Œç¨‹åºå¯ä»¥åœæ­¢</li>
</ul>
<blockquote>
<p>t1	 come in</p>
<p>mainçº¿ç¨‹ä¿®æ”¹å®Œæˆ</p>
<p>t1	 flagè¢«ä¿®æ”¹ä¸ºfalse,é€€å‡º&hellip;..</p>
</blockquote>
<p>çº¿ç¨‹t1ä¸­ä¸ºä½•çœ‹ä¸åˆ°è¢«ä¸»çº¿ç¨‹mainä¿®æ”¹ä¸ºfalseçš„flagçš„å€¼ï¼Ÿ</p>
<p>é—®é¢˜å¯èƒ½:</p>
<ol>
<li>ä¸»çº¿ç¨‹ä¿®æ”¹äº†flagä¹‹åæ²¡æœ‰å°†å…¶åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œæ‰€ä»¥t1çº¿ç¨‹çœ‹ä¸åˆ°ã€‚</li>
<li>ä¸»çº¿ç¨‹å°†flagåˆ·æ–°åˆ°äº†ä¸»å†…å­˜ï¼Œä½†æ˜¯t1ä¸€ç›´è¯»å–çš„æ˜¯è‡ªå·±å·¥ä½œå†…å­˜ä¸­flagçš„å€¼ï¼Œæ²¡æœ‰å»ä¸»å†…å­˜ä¸­æ›´æ–°è·å–flagæœ€æ–°çš„å€¼ã€‚</li>
</ol>
<p>è¯‰æ±‚ï¼š</p>
<p>1.çº¿ç¨‹ä¸­ä¿®æ”¹äº†å·¥ä½œå†…å­˜ä¸­çš„å‰¯æœ¬ä¹‹åï¼Œç«‹å³å°†å…¶åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼›</p>
<p>2.å·¥ä½œå†…å­˜ä¸­æ¯æ¬¡è¯»å–å…±äº«å˜é‡æ—¶ï¼Œéƒ½å»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–ï¼Œç„¶åæ‹·è´åˆ°å·¥ä½œå†…å­˜ã€‚</p>
<p>è§£å†³ï¼š</p>
<p>ä½¿ç”¨volatileä¿®é¥°å…±äº«å˜é‡ï¼Œå°±å¯ä»¥è¾¾åˆ°ä¸Šé¢çš„æ•ˆæœï¼Œè¢«volatileä¿®æ”¹çš„å˜é‡æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>çº¿ç¨‹ä¸­è¯»å–çš„æ—¶å€™ï¼Œæ¯æ¬¡è¯»å–éƒ½ä¼šå»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡æœ€æ–°çš„å€¼ï¼Œç„¶åå°†å…¶å¤åˆ¶åˆ°å·¥ä½œå†…å­˜</li>
<li>çº¿ç¨‹ä¸­ä¿®æ”¹äº†å·¥ä½œå†…å­˜ä¸­å˜é‡çš„å‰¯æœ¬ï¼Œä¿®æ”¹ä¹‹åä¼šç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜</li>
</ol>
<h4 id="volatileå˜é‡çš„è¯»å†™è¿‡ç¨‹">volatileå˜é‡çš„è¯»å†™è¿‡ç¨‹</h4>
<p>Javaå†…å­˜æ¨¡å‹ä¸­å®šä¹‰çš„8ç§å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜ä¹‹é—´çš„åŸå­æ“ä½œ</p>
<p>read(è¯»å–)â†’load(åŠ è½½)â†’use(ä½¿ç”¨)â†’assign(èµ‹å€¼)â†’store(å­˜å‚¨)â†’write(å†™å…¥)â†’lock(é”å®š)â†’unlock(è§£é”)</p>
<h3 id="2æ²¡æœ‰åŸå­æ€§">2ã€æ²¡æœ‰åŸå­æ€§</h3>
<h4 id="volatileå˜é‡çš„å¤åˆæ“ä½œå¦‚iä¸å…·æœ‰åŸå­æ€§">volatileå˜é‡çš„å¤åˆæ“ä½œ(å¦‚i++)ä¸å…·æœ‰åŸå­æ€§</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileNoAtomicDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyNumber</span> <span class="n">myNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyNumber</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">1000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">myNumber</span><span class="o">.</span><span class="na">addPlusPlus</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">myNumber</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœä¸€èˆ¬éƒ½ä¸æ˜¯10000ï¼š</p>
<blockquote>
<p>main	9733</p>
</blockquote>
<p>åŸå­æ€§æŒ‡çš„æ˜¯ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œå³ä½¿æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹å°±ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“ã€‚</p>
<blockquote>
<p>public void add()
{
i++;</p>
<p>//ä¸å…·å¤‡åŸå­æ€§ï¼Œè¯¥æ“ä½œæ˜¯å…ˆè¯»å–å€¼ï¼Œç„¶åå†™å›ä¸€ä¸ªæ–°å€¼ï¼Œç›¸å½“äºåŸæ¥çš„å€¼åŠ ä¸Š1ï¼Œåˆ†3æ­¥å®Œæˆ
}</p>
</blockquote>
<p>å¦‚æœç¬¬äºŒä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹è¯»å–æ—§å€¼å’Œå†™å›æ–°å€¼æœŸé—´è¯»å–içš„åŸŸå€¼ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªçº¿ç¨‹å°±ä¼šä¸ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸€èµ·çœ‹åˆ°åŒä¸€ä¸ªå€¼ï¼Œå¹¶æ‰§è¡Œç›¸åŒå€¼çš„åŠ 1æ“ä½œï¼Œè¿™ä¹Ÿå°±é€ æˆäº†çº¿ç¨‹å®‰å…¨å¤±è´¥ï¼Œå› æ­¤å¯¹äºaddæ–¹æ³•å¿…é¡»ä½¿ç”¨synchronizedä¿®é¥°ï¼Œä»¥ä¾¿ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="3æŒ‡ä»¤ç¦é‡æ’">3ã€æŒ‡ä»¤ç¦é‡æ’</h3>
<p>é‡æ’åºï¼šé‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†ä¼˜åŒ–ç¨‹åºæ€§èƒ½è€Œå¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ–°æ’åºçš„ä¸€ç§æ‰‹æ®µï¼Œæœ‰æ—¶å€™ä¼šæ”¹å˜ç¨‹åºè¯­å¥çš„å…ˆåé¡ºåº</p>
<p>ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œå¯ä»¥é‡æ’åºï¼›å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¦æ­¢é‡æ’åºã€‚</p>
<p>ä½†é‡æ’åçš„æŒ‡ä»¤ç»å¯¹ä¸èƒ½æ”¹å˜åŸæœ‰çš„ä¸²è¡Œè¯­ä¹‰ï¼è¿™ç‚¹åœ¨å¹¶å‘è®¾è®¡ä¸­å¿…é¡»è¦é‡ç‚¹è€ƒè™‘ï¼</p>
<h4 id="volatileçš„åº•å±‚å®ç°æ˜¯é€šè¿‡å†…å­˜å±éšœ">volatileçš„åº•å±‚å®ç°æ˜¯é€šè¿‡å†…å­˜å±éšœ</h4>
<p>å½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºvolatileè¯»æ—¶ï¼Œä¸è®ºç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªæ“ä½œä¿è¯äº†volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°volatileè¯»ä¹‹å‰ã€‚</p>
<p>å½“ç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileå†™æ—¶ï¼Œä¸è®ºç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªæ“ä½œä¿è¯äº†volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°volatileå†™ä¹‹åã€‚</p>
<p>å½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºvolatileå†™æ—¶ï¼Œç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆJavaå†™äº†ä¸€ä¸ªvolatileå…³é”®å­—ç³»ç»Ÿåº•å±‚åŠ å…¥å†…å­˜å±éšœï¼Ÿ</strong></p>
<p><img src="/image/acc-volatile.png" alt="acc-volatile"></p>
<h3 id="volatileåº”ç”¨">volatileåº”ç”¨</h3>
<h4 id="1å•ä¸€èµ‹å€¼å¯ä»¥ä½†æ˜¯å«å¤åˆè¿ç®—èµ‹å€¼ä¸å¯ä»¥iä¹‹ç±»">1ã€å•ä¸€èµ‹å€¼å¯ä»¥ï¼Œä½†æ˜¯å«å¤åˆè¿ç®—èµ‹å€¼ä¸å¯ä»¥(i++ä¹‹ç±»)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">10</span>
</span></span><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2çŠ¶æ€æ ‡å¿—åˆ¤æ–­ä¸šåŠ¡æ˜¯å¦ç»“æŸ">2ã€çŠ¶æ€æ ‡å¿—ï¼Œåˆ¤æ–­ä¸šåŠ¡æ˜¯å¦ç»“æŸ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä½¿ç”¨ï¼šä½œä¸ºä¸€ä¸ªå¸ƒå°”çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†ä¸€ä¸ªé‡è¦çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¾‹å¦‚å®Œæˆåˆå§‹åŒ–æˆ–ä»»åŠ¡ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ç†ç”±ï¼šçŠ¶æ€æ ‡å¿—å¹¶ä¸ä¾èµ–äºç¨‹åºå†…ä»»ä½•å…¶ä»–çŠ¶æ€ï¼Œä¸”é€šå¸¸åªæœ‰ä¸€ç§çŠ¶æ€è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä¾‹å­ï¼šåˆ¤æ–­ä¸šåŠ¡æ˜¯å¦ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseVolatileDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//do something......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3å¼€é”€è¾ƒä½çš„è¯»å†™é”ç­–ç•¥">3ã€å¼€é”€è¾ƒä½çš„è¯»ï¼Œå†™é”ç­–ç•¥</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseVolatileDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä½¿ç”¨ï¼šå½“è¯»è¿œå¤šäºå†™ï¼Œç»“åˆä½¿ç”¨ å†…éƒ¨é” å’Œ volatile å˜é‡æ¥å‡å°‘åŒæ­¥çš„å¼€é”€
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç†ç”±ï¼šåˆ©ç”¨volatileä¿è¯è¯»å–æ“ä½œçš„å¯è§æ€§ï¼›åˆ©ç”¨synchronizedä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>   <span class="c1">//åˆ©ç”¨volatileä¿è¯è¯»å–æ“ä½œçš„å¯è§æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">value</span><span class="o">++;</span> <span class="c1">//åˆ©ç”¨synchronizedä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dclåŒé‡æ£€æŸ¥é”ä¸å»¶è¿Ÿåˆå§‹åŒ–">DCLåŒé‡æ£€æŸ¥é”ä¸å»¶è¿Ÿåˆå§‹åŒ–</h2>
<h3 id="é—®é¢˜ç”±æ¥">é—®é¢˜ç”±æ¥</h3>
<p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ‰æ—¶å€™å¯èƒ½éœ€è¦æ¨è¿Ÿä¸€äº›é«˜å¼€é”€çš„å¯¹è±¡åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¸”åªæœ‰åœ¨ä½¿ç”¨è¿™äº›å¯¹è±¡æ—¶æ‰è¿›è¡Œåˆå§‹åŒ–ã€‚æ­¤æ—¶ï¼Œç¨‹åºå‘˜å¯èƒ½ä¼šé‡‡ç”¨å»¶è¿Ÿåˆå§‹åŒ–ã€‚ä½†è¦æ­£ç¡®å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–éœ€è¦ä¸€äº›æŠ€å·§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜ã€‚</p>
<p>synchronizedï¼ˆç”šè‡³æ˜¯æ— ç«äº‰çš„synchronizedï¼‰å­˜åœ¨å·¨å¤§çš„æ€§èƒ½å¼€é”€ã€‚å› æ­¤ï¼Œäººä»¬æƒ³å‡ºäº†ä¸€ä¸ªâ€œèªæ˜â€çš„æŠ€å·§ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDouble-Checked Lockingï¼‰ã€‚äººä»¬æƒ³é€šè¿‡åŒé‡æ£€æŸ¥é”å®šæ¥é™ä½åŒæ­¥çš„å¼€é”€ã€‚</p>
<p>é—®é¢˜ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeDoubleCheckSingleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SafeDoubleCheckSingleton</span> <span class="n">singleton</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ç§æœ‰åŒ–æ„é€ æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="nf">SafeDoubleCheckSingleton</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//åŒé‡é”è®¾è®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SafeDoubleCheckSingleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//1.å¤šçº¿ç¨‹å¹¶å‘åˆ›å»ºå¯¹è±¡æ—¶ï¼Œä¼šé€šè¿‡åŠ é”ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½åˆ›å»ºå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">SafeDoubleCheckSingleton</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">singleton</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//éšæ‚£ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œç”±äºé‡æ’åºï¼Œè¯¥å¯¹è±¡å¯èƒ½è¿˜æœªå®Œæˆåˆå§‹åŒ–å°±è¢«å…¶ä»–çº¿ç¨‹è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeDoubleCheckSingleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.å¯¹è±¡åˆ›å»ºå®Œæ¯•ï¼Œæ‰§è¡ŒgetInstance()å°†ä¸éœ€è¦è·å–é”ï¼Œç›´æ¥è¿”å›åˆ›å»ºå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å•çº¿ç¨‹çœ‹é—®é¢˜ä»£ç </strong></p>
<p>å•çº¿ç¨‹ç¯å¢ƒä¸‹(æˆ–è€…è¯´æ­£å¸¸æƒ…å†µä¸‹)ï¼Œåœ¨&quot;é—®é¢˜ä»£ç å¤„&quot;ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œä¿è¯èƒ½è·å–åˆ°å·²å®Œæˆåˆå§‹åŒ–çš„å®ä¾‹</p>
<blockquote>
<p>right</p>
<p>memory=allocate(); //1.åˆ†é…å¯¹è±¡çš„å†…å­˜ç©ºé—´</p>
<p>Instance(memory); //2.åˆå§‹åŒ–å¯¹è±¡</p>
<p>instance=memory; //3.è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€</p>
</blockquote>
<p>ç”±äºå­˜åœ¨æŒ‡ä»¤é‡æ’åº&hellip;&hellip;</p>
<p>æ ¹æ®ã€ŠThe Java Language Specification,Java SE 7 Editionã€‹ï¼ˆJavaè¯­è¨€è§„èŒƒï¼‰ï¼Œæ‰€æœ‰çº¿ç¨‹åœ¨æ‰§è¡ŒJavaç¨‹åºæ—¶å¿…é¡»è¦éµå®ˆ<code>intra-thread semantics</code>ã€‚intra-thread semanticsä¿è¯é‡æ’åºä¸ä¼šæ”¹å˜å•çº¿ç¨‹å†…çš„ç¨‹åºæ‰§è¡Œç»“æœã€‚æ¢å¥è¯è¯´ï¼Œintra-thread semanticså…è®¸é‚£äº›åœ¨å•çº¿ç¨‹å†…ï¼Œä¸ä¼šæ”¹å˜å•çº¿ç¨‹ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºã€‚ä¸Šé¢3è¡Œä¼ªä»£ç çš„2å’Œ3ä¹‹é—´è™½ç„¶è¢«é‡æ’åºäº†ï¼Œä½†è¿™ä¸ªé‡æ’åºå¹¶ä¸ä¼šè¿åintra-thread semanticsã€‚è¿™ä¸ªé‡æ’åºåœ¨æ²¡æœ‰æ”¹å˜å•çº¿ç¨‹ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå¯ä»¥æé«˜ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
<p><strong>å¤šçº¿ç¨‹çœ‹é—®é¢˜ä»£ç </strong></p>
<p>éšæ‚£ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨&quot;é—®é¢˜ä»£ç å¤„&quot;ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œç”±äºé‡æ’åºå¯¼è‡´2,3ä¹±åºï¼Œåæœå°±æ˜¯å…¶ä»–çº¿ç¨‹å¾—åˆ°çš„æ˜¯nullè€Œä¸æ˜¯å®Œæˆåˆå§‹åŒ–çš„å¯¹è±¡</p>
<blockquote>
<p>problem</p>
<p>memory=allocate(); //1.åˆ†é…å¯¹è±¡çš„å†…å­˜ç©ºé—´</p>
<p>instance=memory; //3.è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€</p>
<p>//æ³¨æ„ï¼Œæ­¤æ—¶å¯¹è±¡è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼</p>
<p>Instance(memory); //2.åˆå§‹åŒ–å¯¹è±¡</p>
</blockquote>
<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
<p>æœ‰ä¸¤ä¸ªåŠæ³•æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<p>1ï¼‰ä¸å…è®¸2å’Œ3é‡æ’åºã€‚</p>
<p>2ï¼‰å…è®¸2å’Œ3é‡æ’åºï¼Œä½†ä¸å…è®¸å…¶ä»–çº¿ç¨‹â€œçœ‹åˆ°â€è¿™ä¸ªé‡æ’åºã€‚</p>
<h3 id="åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ">åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ</h3>
<p>æŠŠinstanceå£°æ˜ä¸ºvolatileå‹</p>
<p>è¿™ä¸ªæ–¹æ¡ˆæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ç¦æ­¢2å’Œ3ä¹‹é—´çš„é‡æ’åºï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<h3 id="åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ">åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ</h3>
<p>å®ç°å¦ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–æ–¹æ¡ˆï¼ˆè¢«ç§°ä¹‹ä¸ºInitialization On Demand Holder idiomï¼‰</p>
<p>é‡‡ç”¨é™æ€å†…éƒ¨ç±»çš„æ–¹å¼å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ç°åœ¨æ¯”è¾ƒå¥½çš„åšæ³•å°±æ˜¯é‡‡ç”¨é™æ€å†…éƒ¨ç±»çš„æ–¹å¼å®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">SingletonDemo</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SingletonDemoHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="n">SingletonDemo</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonDemo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonDemo</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SingletonDemoHandler</span><span class="o">.</span><span class="na">instance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ–¹æ¡ˆçš„å®è´¨æ˜¯ï¼šå…è®¸ä¸Šè¿°3è¡Œä¼ªä»£ç ä¸­çš„2å’Œ3é‡æ’åºï¼Œä½†ä¸å…è®¸<code>éæ„é€ çº¿ç¨‹</code>ï¼ˆè¿™é‡ŒæŒ‡çº¿ç¨‹Bï¼‰â€œçœ‹åˆ°â€è¿™ä¸ªé‡æ’åºã€‚</p>
<p>åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼ŒåŒ…æ‹¬æ‰§è¡Œè¿™ä¸ªç±»çš„é™æ€åˆå§‹åŒ–å’Œåˆå§‹åŒ–åœ¨è¿™ä¸ªç±»ä¸­å£°æ˜çš„é™æ€å­—æ®µã€‚</p>
<p>æ ¹æ®Javaè¯­è¨€è§„èŒƒï¼Œåœ¨é¦–æ¬¡å‘ç”Ÿä¸‹åˆ—ä»»æ„ä¸€ç§æƒ…å†µæ—¶ï¼Œä¸€ä¸ªç±»æˆ–æ¥å£ç±»å‹Tå°†è¢«ç«‹å³åˆå§‹åŒ–ã€‚</p>
<p>1ï¼‰Tæ˜¯ä¸€ä¸ªç±»ï¼Œè€Œä¸”ä¸€ä¸ªTç±»å‹çš„å®ä¾‹è¢«åˆ›å»ºã€‚</p>
<p>2ï¼‰Tæ˜¯ä¸€ä¸ªç±»ï¼Œä¸”Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€æ–¹æ³•è¢«è°ƒç”¨ã€‚</p>
<p>3ï¼‰Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€å­—æ®µè¢«èµ‹å€¼ã€‚</p>
<p>4ï¼‰Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€å­—æ®µè¢«ä½¿ç”¨ï¼Œè€Œä¸”è¿™ä¸ªå­—æ®µä¸æ˜¯ä¸€ä¸ªå¸¸é‡å­—æ®µã€‚</p>
<p>5ï¼‰Tæ˜¯ä¸€ä¸ªé¡¶çº§ç±»ï¼ˆTop Level Classï¼Œè§Javaè¯­è¨€è§„èŒƒçš„Â§7.6ï¼‰ï¼Œè€Œä¸”ä¸€ä¸ªæ–­è¨€è¯­å¥åµŒå¥—åœ¨Tå†…éƒ¨è¢«æ‰§è¡Œã€‚</p>
<p>åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œé¦–æ¬¡æ‰§è¡ŒgetInstance()æ–¹æ³•çš„çº¿ç¨‹å°†å¯¼è‡´SingletonDemoHandlerç±»è¢«åˆå§‹åŒ–ï¼ˆç¬¦åˆæƒ…å†µ4ï¼‰ã€‚</p>
<p>æ ¹æ®Javaå†…å­˜æ¨¡å‹è§„èŒƒçš„é”è§„åˆ™ï¼Œè¿™é‡Œå°†å­˜åœ¨å¦‚ä¸‹çš„happens-beforeå…³ç³»ã€‚</p>
<p>è¿™ä¸ªhappens-beforeå…³ç³»å°†ä¿è¯ï¼šçº¿ç¨‹Aæ‰§è¡Œç±»çš„åˆå§‹åŒ–æ—¶çš„å†™å…¥æ“ä½œï¼ˆæ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–å’Œåˆå§‹åŒ–ç±»ä¸­å£°æ˜çš„é™æ€å­—æ®µï¼‰ï¼Œçº¿ç¨‹Bä¸€å®šèƒ½çœ‹åˆ°ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>é€šè¿‡å¯¹æ¯”åŸºäºvolatileçš„åŒé‡æ£€æŸ¥é”å®šçš„æ–¹æ¡ˆå’ŒåŸºäºç±»åˆå§‹åŒ–çš„æ–¹æ¡ˆï¼Œä¼šå‘ç°åŸºäºç±»åˆå§‹åŒ–çš„æ–¹æ¡ˆçš„å®ç°ä»£ç æ›´ç®€æ´ã€‚ä½†åŸºäºvolatileçš„åŒé‡æ£€æŸ¥é”å®šçš„æ–¹æ¡ˆæœ‰ä¸€ä¸ªé¢å¤–çš„ä¼˜åŠ¿ï¼šé™¤äº†å¯ä»¥å¯¹é™æ€å­—æ®µå®ç°å»¶è¿Ÿåˆå§‹åŒ–å¤–ï¼Œè¿˜å¯ä»¥å¯¹å®ä¾‹å­—æ®µå®ç°å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<p>å­—æ®µå»¶è¿Ÿåˆå§‹åŒ–é™ä½äº†åˆå§‹åŒ–ç±»æˆ–åˆ›å»ºå®ä¾‹çš„å¼€é”€ï¼Œä½†å¢åŠ äº†è®¿é—®è¢«å»¶è¿Ÿåˆå§‹åŒ–çš„å­—æ®µçš„å¼€é”€ã€‚åœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œ<code>æ­£å¸¸çš„åˆå§‹åŒ–è¦ä¼˜äºå»¶è¿Ÿåˆå§‹åŒ–</code>ã€‚å¦‚æœç¡®å®éœ€è¦å¯¹<code>å®ä¾‹å­—æ®µ</code>ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œè¯·ä½¿ç”¨åŸºäºvolatileçš„å»¶è¿Ÿåˆå§‹åŒ–çš„æ–¹æ¡ˆï¼›å¦‚æœç¡®å®éœ€è¦å¯¹<code>é™æ€å­—æ®µ</code>ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œè¯·ä½¿ç”¨åŸºäºç±»åˆå§‹åŒ–çš„æ–¹æ¡ˆã€‚</p>
<h2 id="cas">CAS</h2>
<h3 id="1å¤šçº¿ç¨‹ç¯å¢ƒä¸ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨åŸºæœ¬æ•°æ®ç±»å‹">1ã€å¤šçº¿ç¨‹ç¯å¢ƒä¸ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">T3</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">number</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å†™å…¥åŠ é”ä¿è¯åŸå­æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setNumber</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">number</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨åŸºæœ¬æ•°æ®ç±»å‹">2ã€å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">T3</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAtomicInteger</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAtomicInteger</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="caså®šä¹‰">CASå®šä¹‰</h3>
<p>CASï¼šcompare and swapçš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘æˆæ¯”è¾ƒå¹¶äº¤æ¢,å®ç°å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨åˆ°çš„ä¸€ç§æŠ€æœ¯ã€‚</p>
<p>å®ƒåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°â€”â€”å†…å­˜ä½ç½®ã€é¢„æœŸåŸå€¼åŠæ›´æ–°å€¼ã€‚</p>
<p>æ‰§è¡ŒCASæ“ä½œçš„æ—¶å€™ï¼Œå°†å†…å­˜ä½ç½®çš„å€¼ä¸é¢„æœŸåŸå€¼æ¯”è¾ƒï¼š</p>
<p>å¦‚æœç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œå¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡ŒCASæ“ä½œåªæœ‰ä¸€ä¸ªä¼šæˆåŠŸã€‚</p>
<p>CASæ˜¯JDKæä¾›çš„<code>éé˜»å¡åŸå­æ€§æ“ä½œ</code>ï¼Œå®ƒé€šè¿‡ç¡¬ä»¶ä¿è¯äº†æ¯”è¾ƒâ€”â€”æ›´æ–°çš„åŸå­æ€§ã€‚å®ƒæ˜¯éé˜»å¡çš„ä¸”è‡ªèº«åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ•ˆç‡æ›´é«˜ä¸”é€šè¿‡ç¡¬ä»¶ä¿è¯ï¼Œè¯´æ˜æ›´å¯é ã€‚</p>
<p>CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼ˆcmpxchgæŒ‡ä»¤ï¼‰ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼ŒUnsafeæä¾›çš„CASæ–¹æ³•ï¼ˆå¦‚compareAndSwapXXXï¼‰åº•å±‚å®ç°å³ä¸ºCPUæŒ‡ä»¤cmpxchgã€‚</p>
<p>æ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½ã€‚</p>
<h3 id="casåŸç†">CASåŸç†</h3>
<p>getAndIncrement</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Atomically increments by one the current value.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the previous value
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>getAndAddInt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAddInt</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">v</span> <span class="o">=</span> <span class="n">getIntVolatile</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">compareAndSwapInt</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">delta</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>CASçš„å…¨ç§°ä¸ºCompare-And-Swapï¼Œæ˜¯ä¸€æ¡CPUå¹¶å‘åŸè¯­ã€‚ å®ƒçš„åŠŸèƒ½æ˜¯åˆ¤æ–­å†…å­˜æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ”¹ä¸ºæ–°çš„å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„ã€‚</p>
<p>AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚</p>
<h3 id="åº•å±‚æ±‡ç¼–">åº•å±‚æ±‡ç¼–</h3>
<p>nativeä¿®é¥°çš„æ–¹æ³•ä»£è¡¨æ˜¯åº•å±‚æ–¹æ³•</p>
<p>Unsafeç±»ä¸­çš„compareAndSwapIntï¼Œæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®ç°ä½äºunsafe.cppä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">UNSAFE_ENTRY</span><span class="p">(</span><span class="n">jboolean</span><span class="p">,</span> <span class="n">Unsafe_CompareAndSwapInt</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">unsafe</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">offset</span><span class="p">,</span> <span class="n">jint</span> <span class="n">e</span><span class="p">,</span> <span class="n">jint</span> <span class="n">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">UnsafeWrapper</span><span class="p">(</span><span class="s">&#34;Unsafe_CompareAndSwapInt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">oop</span> <span class="n">p</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å…ˆæƒ³åŠæ³•æ‹¿åˆ°å˜é‡valueåœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæ ¹æ®åç§»é‡valueOffsetï¼Œè®¡ç®— value çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">jint</span><span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">jint</span> <span class="o">*</span><span class="p">)</span> <span class="n">index_oop_from_field_offset_long</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è°ƒç”¨ Atomic ä¸­çš„å‡½æ•° cmpxchgæ¥è¿›è¡Œæ¯”è¾ƒäº¤æ¢ï¼Œå…¶ä¸­å‚æ•°xæ˜¯å³å°†æ›´æ–°çš„å€¼ï¼Œå‚æ•°eæ˜¯åŸå†…å­˜çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span><span class="n">jint</span><span class="p">)(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="o">==</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UNSAFE_END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è‡ªæ—‹é”spinlock">è‡ªæ—‹é”ï¼ˆspinlockï¼‰</h3>
<p>æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œ å½“çº¿ç¨‹å‘ç°é”è¢«å ç”¨æ—¶ï¼Œä¼šä¸æ–­å¾ªç¯åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œç›´åˆ°è·å–ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é¢˜ç›®ï¼šå®ç°ä¸€ä¸ªè‡ªæ—‹é”
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è‡ªæ—‹é”å¥½å¤„ï¼šå¾ªç¯æ¯”è¾ƒè·å–æ²¡æœ‰ç±»ä¼¼waitçš„é˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”ï¼ŒAçº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’é’Ÿï¼ŒBéšåè¿›æ¥åå‘ç°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œä¸æ˜¯nullï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°Aé‡Šæ”¾é”åBéšåæŠ¢åˆ°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpinLockDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">atomicReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(!</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">thread</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myUnLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t myUnLock over&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpinLockDemo</span> <span class="n">spinLockDemo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpinLockDemo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spinLockDemo</span><span class="o">.</span><span class="na">myLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">spinLockDemo</span><span class="o">.</span><span class="na">myUnLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;A&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹ï¼Œä¿è¯Açº¿ç¨‹å…ˆäºBçº¿ç¨‹å¯åŠ¨å¹¶å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">spinLockDemo</span><span class="o">.</span><span class="na">myLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">spinLockDemo</span><span class="o">.</span><span class="na">myUnLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;B&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>A	 come in
B	 come in
B	 myUnLock over
A	 myUnLock over</p>
</blockquote>
<h3 id="casç¼ºç‚¹">CASç¼ºç‚¹</h3>
<h4 id="1å¾ªç¯æ—¶é—´é•¿å¼€é”€å¾ˆå¤§">1ã€å¾ªç¯æ—¶é—´é•¿å¼€é”€å¾ˆå¤§</h4>
<p>ä¼šç»™CPUå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚</p>
<h4 id="2abaé—®é¢˜">2ã€ABAé—®é¢˜</h4>
<p>CASä¼šå¯¼è‡´â€œABAé—®é¢˜â€ã€‚</p>
<p>CASç®—æ³•å®ç°ä¸€ä¸ªé‡è¦å‰æéœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®å¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶é—´å·®ç±»ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–ã€‚</p>
<p>æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vä¸­å–å‡ºAï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†Bï¼Œç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸã€‚</p>
<p>å°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ABADemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicStampedReference</span> <span class="n">atomicStampedReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">2019</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹,mainå½»åº•ç­‰å¾…ä¸Šé¢çš„ABAå‡ºç°æ¼”ç¤ºå®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;============ä»¥ä¸‹æ˜¯ABAé—®é¢˜çš„è§£å†³=============================&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t é¦–æ¬¡ç‰ˆæœ¬å·:&#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span><span class="c1">//1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 2æ¬¡ç‰ˆæœ¬å·:&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 3æ¬¡ç‰ˆæœ¬å·:&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t é¦–æ¬¡ç‰ˆæœ¬å·:&#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span><span class="c1">//1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹ï¼Œè·å¾—åˆå§‹å€¼100å’Œåˆå§‹ç‰ˆæœ¬å·1ï¼Œæ•…æ„æš‚åœ3ç§’é’Ÿè®©t3çº¿ç¨‹å®Œæˆä¸€æ¬¡ABAæ“ä½œäº§ç”Ÿé—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">2019</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="n">stamp</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t4&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>true	2019</p>
<p>============ä»¥ä¸‹æ˜¯ABAé—®é¢˜çš„è§£å†³=============================</p>
<p>t3	 é¦–æ¬¡ç‰ˆæœ¬å·:1</p>
<p>t4	 é¦–æ¬¡ç‰ˆæœ¬å·:1</p>
<p>t3	 2æ¬¡ç‰ˆæœ¬å·:2</p>
<p>t3	 3æ¬¡ç‰ˆæœ¬å·:3</p>
<p>t4	false	100</p>
</blockquote>
<h2 id="åŸå­æ“ä½œç±»">åŸå­æ“ä½œç±»</h2>
<ol>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicIntegerArray</li>
<li>AtomicIntegerFieldUpdater</li>
<li>AtomicLong</li>
<li>AtomicLongArray</li>
<li>AtomicLongFieldUpdater</li>
<li>AtomicMarkableReference</li>
<li>AtomicReference</li>
<li>AtomicReferenceArray</li>
<li>AtomicReferenceFieldUpdater</li>
<li>AtomicStampedReference</li>
<li>DoubleAccumulator</li>
<li>DoubleAdder</li>
<li>LongAccumulator</li>
<li>LongAdder</li>
</ol>
<h3 id="1åŸºæœ¬ç±»å‹åŸå­ç±»">1ã€åŸºæœ¬ç±»å‹åŸå­ç±»</h3>
<ul>
<li>AtomicInteger</li>
<li>AtomicBoolean</li>
<li>AtomicLong</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyNumber</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AtomicInteger</span> <span class="nf">getAtomicInteger</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">atomicInteger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPlusPlus</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyNumber</span> <span class="n">myNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyNumber</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">5000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">myNumber</span><span class="o">.</span><span class="na">addPlusPlus</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myNumber</span><span class="o">.</span><span class="na">getAtomicInteger</span><span class="o">().</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>500000</p>
</blockquote>
<h3 id="2æ•°ç»„ç±»å‹åŸå­ç±»">2ã€æ•°ç»„ç±»å‹åŸå­ç±»</h3>
<ul>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerArrayDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(new int[5]);
</span></span></span><span class="line"><span class="cl"><span class="c1">//        AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(5);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AtomicIntegerArray</span> <span class="n">atomicIntegerArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicIntegerArray</span><span class="o">(</span><span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">,</span> <span class="n">5</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">tmpInt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tmpInt</span> <span class="o">=</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1122</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">tmpInt</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmpInt</span> <span class="o">=</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">tmpInt</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>1	1122</p>
<p>4	5</p>
</blockquote>
<h3 id="3å¼•ç”¨ç±»å‹åŸå­ç±»">3ã€å¼•ç”¨ç±»å‹åŸå­ç±»</h3>
<ul>
<li>
<p>AtomicReference</p>
</li>
<li>
<p>AtomicStampedReference</p>
<ul>
<li>æºå¸¦ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»ï¼Œå¯ä»¥è§£å†³ABAé—®é¢˜</li>
<li>è§£å†³ä¿®æ”¹è¿‡å‡ æ¬¡</li>
<li>çŠ¶æ€æˆ³åŸå­å¼•ç”¨</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ABADemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicStampedReference</span> <span class="n">atomicStampedReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">abaProblem</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">abaResolve</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">abaProblem</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">200</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">20210308</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">abaResolve</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;t3 ----ç¬¬1æ¬¡stamp  &#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="n">stamp</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;t3 ----ç¬¬2æ¬¡stamp  &#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;t3 ----ç¬¬3æ¬¡stamp  &#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;t4 ----ç¬¬1æ¬¡stamp  &#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">20210308</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="n">stamp</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t4&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t2	true	20210308</p>
<p>t4 &mdash;-ç¬¬1æ¬¡stamp  1</p>
<p>t3 &mdash;-ç¬¬1æ¬¡stamp  1</p>
<p>t3 &mdash;-ç¬¬2æ¬¡stamp  2</p>
<p>t3 &mdash;-ç¬¬3æ¬¡stamp  3</p>
<p>t4	false	100</p>
</blockquote>
<ul>
<li>AtomicMarkableReference
<ul>
<li>åŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹å¯¹è±¡</li>
<li>è§£å†³æ˜¯å¦ä¿®æ”¹è¿‡ï¼šå°†çŠ¶æ€æˆ³ç®€åŒ–ä¸ºtrue|falseâ€”â€”ç±»ä¼¼ä¸€æ¬¡æ€§ç­·å­</li>
<li>çŠ¶æ€æˆ³(true/false)åŸå­å¼•ç”¨</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ABADemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicMarkableReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">markableReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicMarkableReference</span><span class="o">&lt;&gt;(</span><span class="n">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;============AtomicMarkableReferenceä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹è¿‡å‡ æ¬¡ï¼Œåªå…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡======================&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">marked</span> <span class="o">=</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 1æ¬¡ç‰ˆæœ¬å·&#34;</span> <span class="o">+</span> <span class="n">marked</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">markableReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">,</span> <span class="n">marked</span><span class="o">,</span> <span class="o">!</span><span class="n">marked</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 2æ¬¡ç‰ˆæœ¬å·&#34;</span> <span class="o">+</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">markableReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">(),</span> <span class="o">!</span><span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 3æ¬¡ç‰ˆæœ¬å·&#34;</span> <span class="o">+</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t5&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">marked</span> <span class="o">=</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 1æ¬¡ç‰ˆæœ¬å·&#34;</span> <span class="o">+</span> <span class="n">marked</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">markableReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">2020</span><span class="o">,</span> <span class="n">marked</span><span class="o">,</span> <span class="o">!</span><span class="n">marked</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">markableReference</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t6&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t5	 1æ¬¡ç‰ˆæœ¬å·false</p>
<p>t6	 1æ¬¡ç‰ˆæœ¬å·false</p>
<p>t5	 2æ¬¡ç‰ˆæœ¬å·true</p>
<p>t5	 3æ¬¡ç‰ˆæœ¬å·false</p>
<p>t6	101	false</p>
</blockquote>
<h3 id="4å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»">4ã€å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»</h3>
<ul>
<li>AtomicIntegerFieldUpdater
<ul>
<li>åŸå­æ›´æ–°<code>å¯¹è±¡ä¸­Integerç±»å‹å­—æ®µ</code>çš„å€¼</li>
</ul>
</li>
<li>AtomicLongFieldUpdater
<ul>
<li>åŸå­æ›´æ–°<code>å¯¹è±¡ä¸­Longç±»å‹å­—æ®µ</code>çš„å€¼</li>
</ul>
</li>
<li>AtomicReferenceFieldUpdater
<ul>
<li>åŸå­æ›´æ–°<code>å¼•ç”¨ç±»å‹å­—æ®µ</code>çš„å€¼</li>
</ul>
</li>
</ul>
<h4 id="1ä½¿ç”¨ç›®çš„">1ã€ä½¿ç”¨ç›®çš„</h4>
<p>ä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ“ä½œ<code>éçº¿ç¨‹å®‰å…¨å¯¹è±¡</code>å†…çš„æŸäº›å­—æ®µ</p>
<h4 id="2ä½¿ç”¨è¦æ±‚">2ã€ä½¿ç”¨è¦æ±‚</h4>
<ul>
<li>
<p>æ›´æ–°çš„å¯¹è±¡å±æ€§å¿…é¡»ä½¿ç”¨ <code>public volatile</code> ä¿®é¥°ç¬¦ã€‚</p>
</li>
<li>
<p>å› ä¸º<code>å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»</code>éƒ½æ˜¯<code>æŠ½è±¡ç±»</code>ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨<code>é™æ€æ–¹æ³•newUpdater()</code>åˆ›å»ºä¸€ä¸ª<code>æ›´æ–°å™¨</code>ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„<code>ç±»å’Œå±æ€§</code>ã€‚</p>
</li>
</ul>
<p>AtomicIntegerFieldUpdater</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BankAccount</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">bankName</span> <span class="o">=</span> <span class="s">&#34;CCB&#34;</span><span class="o">;</span><span class="c1">//é“¶è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="c1">//é’±æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="n">BankAccount</span><span class="o">&gt;</span> <span class="n">accountAtomicIntegerFieldUpdater</span> <span class="o">=</span> <span class="n">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">BankAccount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;money&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸åŠ é”+æ€§èƒ½é«˜ï¼Œå±€éƒ¨å¾®åˆ›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transferMoney</span><span class="o">(</span><span class="n">BankAccount</span> <span class="n">bankAccount</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountAtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">(</span><span class="n">bankAccount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ“ä½œéçº¿ç¨‹å®‰å…¨å¯¹è±¡çš„æŸäº›å­—æ®µã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * éœ€æ±‚ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1000ä¸ªäººåŒæ—¶å‘ä¸€ä¸ªè´¦å·è½¬è´¦ä¸€å…ƒé’±ï¼Œé‚£ä¹ˆç´¯è®¡åº”è¯¥å¢åŠ 1000å…ƒï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é™¤äº†synchronizedå’ŒCAS,è¿˜å¯ä»¥ä½¿ç”¨AtomicIntegerFieldUpdateræ¥å®ç°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerFieldUpdaterDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BankAccount</span> <span class="n">bankAccount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BankAccount</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bankAccount</span><span class="o">.</span><span class="na">transferMoney</span><span class="o">(</span><span class="n">bankAccount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æš‚åœæ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bankAccount</span><span class="o">.</span><span class="na">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1000</p>
</blockquote>
<p>AtomicReferenceFieldUpdater</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyVar</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">volatile</span> <span class="n">Boolean</span> <span class="n">isInit</span> <span class="o">=</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AtomicReferenceFieldUpdater</span><span class="o">&lt;</span><span class="n">MyVar</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">atomicReferenceFieldUpdater</span> <span class="o">=</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">MyVar</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;isInit&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">MyVar</span> <span class="n">myVar</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">atomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">myVar</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---init.....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---init.....over&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;------å…¶å®ƒçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¤šçº¿ç¨‹å¹¶å‘è°ƒç”¨ä¸€ä¸ªç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå¦‚æœæœªè¢«åˆå§‹åŒ–è¿‡ï¼Œå°†æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œè¦æ±‚åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicReferenceFieldUpdaterDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyVar</span> <span class="n">myVar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyVar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">myVar</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">myVar</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1	&mdash;init&hellip;..</p>
<p>4	&mdash;&mdash;å…¶å®ƒçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–</p>
<p>2	&mdash;&mdash;å…¶å®ƒçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–</p>
<p>5	&mdash;&mdash;å…¶å®ƒçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–</p>
<p>3	&mdash;&mdash;å…¶å®ƒçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–</p>
<p>1	&mdash;init&hellip;..over</p>
</blockquote>
<h3 id="5åŸå­æ“ä½œå¢å¼ºç±»">5ã€åŸå­æ“ä½œå¢å¼ºç±»</h3>
<ul>
<li>DoubleAccumulator</li>
<li>DoubleAdder</li>
<li>LongAccumulatorï¼šæä¾›äº†è‡ªå®šä¹‰çš„å‡½æ•°æ“ä½œ</li>
<li>LongAdderï¼šåªèƒ½ç”¨æ¥è®¡ç®—åŠ æ³•ï¼Œä¸”ä»é›¶å¼€å§‹è®¡ç®—</li>
</ul>
<h4 id="longadder">LongAdder</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdderAPIDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LongAdder</span> <span class="n">longAdder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAdder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAdder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAdder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAdder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">longAdder</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">LongAccumulator</span> <span class="n">longAccumulator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAccumulator</span><span class="o">((</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">,</span> <span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAccumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAccumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAccumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">longAccumulator</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3</p>
<p>12</p>
</blockquote>
<h4 id="longaccumulator">LongAccumulator</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAccumulatorDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LongAdder</span> <span class="n">longAdder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAdder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add_LongAdder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAdder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//longç±»å‹çš„èšåˆå™¨ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªlongç±»å‹çš„äºŒå…ƒæ“ä½œï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—å„ç§èšåˆæ“ä½œï¼ŒåŒ…æ‹¬åŠ ä¹˜ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//LongAccumulator longAccumulator = new LongAccumulator((x, y) -&gt; x + y,0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LongAccumulator</span> <span class="n">longAccumulator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAccumulator</span><span class="o">(</span><span class="k">new</span> <span class="n">LongBinaryOperator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">applyAsLong</span><span class="o">(</span><span class="kt">long</span> <span class="n">left</span><span class="o">,</span> <span class="kt">long</span> <span class="n">right</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span> <span class="n">777</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add_LongAccumulator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAccumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LongAccumulatorDemo</span> <span class="n">demo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAccumulatorDemo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">demo</span><span class="o">.</span><span class="na">add_LongAccumulator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">demo</span><span class="o">.</span><span class="na">add_LongAccumulator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">demo</span><span class="o">.</span><span class="na">longAccumulator</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>775</p>
</blockquote>
<h4 id="longadderé«˜æ€§èƒ½å¯¹æ¯”codeæ¼”ç¤º">LongAdderé«˜æ€§èƒ½å¯¹æ¯”Codeæ¼”ç¤º</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ClickNumberNet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">clickBySync</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">number</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AtomicLong</span> <span class="n">atomicLong</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clickByAtomicLong</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">atomicLong</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LongAdder</span> <span class="n">longAdder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAdder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clickByLongAdder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAdder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LongAccumulator</span> <span class="n">longAccumulator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LongAccumulator</span><span class="o">((</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clickByLongAccumulator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">longAccumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 50ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹100Wæ¬¡ï¼Œæ€»ç‚¹èµæ•°å‡ºæ¥
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdderDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClickNumberNet</span> <span class="n">clickNumberNet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClickNumberNet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CountDownLatch</span> <span class="n">countDownLatch2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CountDownLatch</span> <span class="n">countDownLatch3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CountDownLatch</span> <span class="n">countDownLatch4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">100</span> <span class="o">*</span> <span class="n">10000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">clickBySync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span> <span class="o">+</span> <span class="s">&#34;\t clickBySync result: &#34;</span> <span class="o">+</span> <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">100</span> <span class="o">*</span> <span class="n">10000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">clickByAtomicLong</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">countDownLatch2</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">countDownLatch2</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span> <span class="o">+</span> <span class="s">&#34;\t clickByAtomicLong result: &#34;</span> <span class="o">+</span> <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">atomicLong</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">100</span> <span class="o">*</span> <span class="n">10000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">clickByLongAdder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">countDownLatch3</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">countDownLatch3</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span> <span class="o">+</span> <span class="s">&#34;\t clickByLongAdder result: &#34;</span> <span class="o">+</span> <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">longAdder</span><span class="o">.</span><span class="na">sum</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">100</span> <span class="o">*</span> <span class="n">10000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">clickByLongAccumulator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">countDownLatch4</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">countDownLatch4</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span> <span class="o">+</span> <span class="s">&#34;\t clickByLongAccumulator result: &#34;</span> <span class="o">+</span> <span class="n">clickNumberNet</span><span class="o">.</span><span class="na">longAccumulator</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>&mdash;-costTime: 1487 æ¯«ç§’	 clickBySync result: 50000000</p>
<p>&mdash;-costTime: 2042 æ¯«ç§’	 clickByAtomicLong result: 50000000</p>
<p>&mdash;-costTime: 93 æ¯«ç§’	 clickByLongAdder result: 50000000</p>
<p>&mdash;-costTime: 115 æ¯«ç§’	 clickByLongAccumulator result: 50000000</p>
</blockquote>
<h4 id="æºç åŸç†åˆ†æ">æºç ã€åŸç†åˆ†æ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdder</span> <span class="kd">extends</span> <span class="n">Striped64</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Striped64</span> <span class="kd">extends</span> <span class="n">Number</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Striped64ä¸­å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æˆå‘˜å±æ€§ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/** Number of CPUS, to place bound on table size */</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NCPU</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Table of cells. When non-null, size is a power of 2.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">Cell</span><span class="o">[]</span> <span class="n">cells</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Base value, used mainly when there is no contention, but also as
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a fallback during table initialization races. Updated via CAS.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Spinlock (locked via CAS) used when resizing and/or creating Cells.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">cellsBusy</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>LongAdderçš„åŸºæœ¬æ€è·¯å°±æ˜¯åˆ†æ•£çƒ­ç‚¹ï¼Œå°†valueå€¼åˆ†æ•£åˆ°ä¸€ä¸ªCellæ•°ç»„ä¸­ï¼Œä¸åŒçº¿ç¨‹ä¼šå‘½ä¸­åˆ°æ•°ç»„çš„ä¸åŒæ§½ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åªå¯¹è‡ªå·±æ§½ä¸­çš„é‚£ä¸ªå€¼è¿›è¡ŒCASæ“ä½œï¼Œè¿™æ ·çƒ­ç‚¹å°±è¢«åˆ†æ•£äº†ï¼Œå†²çªçš„æ¦‚ç‡å°±å°å¾ˆå¤šã€‚å¦‚æœè¦è·å–çœŸæ­£çš„longå€¼ï¼Œåªè¦å°†å„ä¸ªæ§½ä¸­çš„å˜é‡å€¼ç´¯åŠ è¿”å›ã€‚</p>
<p>sum()ä¼šå°†æ‰€æœ‰Cellæ•°ç»„ä¸­çš„valueå’Œbaseç´¯åŠ ä½œä¸ºè¿”å›å€¼ï¼Œæ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯å°†ä¹‹å‰AtomicLongä¸€ä¸ªvalueçš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªvalueä¸­å»ï¼Œ ä»è€Œé™çº§æ›´æ–°çƒ­ç‚¹ã€‚</p>
<p>å†…éƒ¨æœ‰ä¸€ä¸ªbaseå˜é‡ï¼Œä¸€ä¸ªCell[]æ•°ç»„ã€‚</p>
<p>baseå˜é‡ï¼šéç«æ€æ¡ä»¶ä¸‹ï¼Œç›´æ¥ç´¯åŠ åˆ°è¯¥å˜é‡ä¸Š</p>
<p>Cell[]æ•°ç»„ï¼šç«æ€æ¡ä»¶ä¸‹ï¼Œç´¯åŠ ä¸ªå„ä¸ªçº¿ç¨‹è‡ªå·±çš„æ§½Cell[i]ä¸­</p>
<p>LongAdderåœ¨æ— ç«äº‰çš„æƒ…å†µï¼Œè·ŸAtomicLongä¸€æ ·ï¼Œå¯¹åŒä¸€ä¸ªbaseè¿›è¡Œæ“ä½œï¼Œå½“å‡ºç°ç«äº‰å…³ç³»æ—¶åˆ™æ˜¯é‡‡ç”¨åŒ–æ•´ä¸ºé›¶çš„åšæ³•ï¼Œä»ç©ºé—´æ¢æ—¶é—´ï¼Œç”¨ä¸€ä¸ªæ•°ç»„cellsï¼Œå°†ä¸€ä¸ªvalueæ‹†åˆ†è¿›è¿™ä¸ªæ•°ç»„cellsã€‚å¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶å¯¹valueè¿›è¡Œæ“ä½œæ—¶å€™ï¼Œå¯ä»¥å¯¹çº¿ç¨‹idè¿›è¡Œhashå¾—åˆ°hashå€¼ï¼Œå†æ ¹æ®hashå€¼æ˜ å°„åˆ°è¿™ä¸ªæ•°ç»„cellsçš„æŸä¸ªä¸‹æ ‡ï¼Œå†å¯¹è¯¥ä¸‹æ ‡æ‰€å¯¹åº”çš„å€¼è¿›è¡Œè‡ªå¢æ“ä½œã€‚å½“æ‰€æœ‰çº¿ç¨‹æ“ä½œå®Œæ¯•ï¼Œå°†æ•°ç»„cellsçš„æ‰€æœ‰å€¼å’Œæ— ç«äº‰å€¼baseéƒ½åŠ èµ·æ¥ä½œä¸ºæœ€ç»ˆç»“æœã€‚</p>
<h4 id="atomiclong-vs-longadder">AtomicLong VS LongAdder</h4>
<ul>
<li>AtomicLong
<ul>
<li>çº¿ç¨‹å®‰å…¨ï¼Œå¯å…è®¸ä¸€äº›æ€§èƒ½æŸè€—ï¼Œè¦æ±‚é«˜ç²¾åº¦æ—¶å¯ä½¿ç”¨</li>
<li>ä¿è¯ç²¾åº¦ï¼Œæ€§èƒ½ä»£ä»·</li>
<li>AtomicLongæ˜¯å¤šä¸ªçº¿ç¨‹é’ˆå¯¹å•ä¸ªçƒ­ç‚¹å€¼valueè¿›è¡ŒåŸå­æ“ä½œ</li>
</ul>
</li>
<li>LongAdder
<ul>
<li>å½“éœ€è¦åœ¨é«˜å¹¶å‘ä¸‹æœ‰è¾ƒå¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä¸”å¯¹å€¼çš„ç²¾ç¡®åº¦è¦æ±‚ä¸é«˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨</li>
<li>ä¿è¯æ€§èƒ½ï¼Œç²¾åº¦ä»£ä»·</li>
<li>LongAdderæ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ§½ï¼Œå„ä¸ªçº¿ç¨‹ä¸€èˆ¬åªå¯¹è‡ªå·±æ§½ä¸­çš„é‚£ä¸ªå€¼è¿›è¡ŒCASæ“ä½œ</li>
</ul>
</li>
</ul>
<h4 id="æ€»ç»“-1">æ€»ç»“</h4>
<h5 id="atomiclong">AtomicLong</h5>
<ul>
<li>åŸç†
<ul>
<li>CAS+è‡ªæ—‹</li>
<li>incrementAndGet</li>
</ul>
</li>
<li>åœºæ™¯
<ul>
<li>ä½å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®—</li>
<li>AtomicLongèƒ½ä¿è¯å¹¶å‘æƒ…å†µä¸‹è®¡æ•°çš„å‡†ç¡®æ€§ï¼Œå…¶å†…éƒ¨é€šè¿‡CASæ¥è§£å†³å¹¶å‘å®‰å…¨æ€§çš„é—®é¢˜ã€‚</li>
</ul>
</li>
<li>ç¼ºé™·
<ul>
<li>é«˜å¹¶å‘åæ€§èƒ½æ€¥å‰§ä¸‹é™</li>
<li>AtomicLongçš„è‡ªæ—‹ä¼šæˆä¸ºç“¶é¢ˆ</li>
<li>Nä¸ªçº¿ç¨‹CASæ“ä½œä¿®æ”¹çº¿ç¨‹çš„å€¼ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªæˆåŠŸè¿‡ï¼Œå…¶å®ƒN-1å¤±è´¥ï¼Œå¤±è´¥çš„ä¸åœçš„è‡ªæ—‹ç›´åˆ°æˆåŠŸï¼Œè¿™æ ·å¤§é‡å¤±è´¥è‡ªæ—‹çš„æƒ…å†µï¼Œä¸€ä¸‹å­cpuå°±æ‰“é«˜äº†</li>
</ul>
</li>
</ul>
<h5 id="longadder-1">LongAdder</h5>
<ul>
<li>åŸç†
<ul>
<li>CAS+Base+Cellæ•°ç»„åˆ†æ•£</li>
<li>ç©ºé—´æ¢æ—¶é—´å¹¶åˆ†æ•£äº†çƒ­ç‚¹æ•°æ®</li>
</ul>
</li>
<li>åœºæ™¯
<ul>
<li>é«˜å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®—</li>
</ul>
</li>
<li>ç¼ºé™·
<ul>
<li>sumæ±‚å’Œåè¿˜æœ‰è®¡ç®—çº¿ç¨‹ä¿®æ”¹ç»“æœçš„è¯ï¼Œæœ€åç»“æœä¸å¤Ÿå‡†ç¡®</li>
</ul>
</li>
</ul>
<h2 id="threadlocal">ThreadLocal</h2>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its <code>get</code> or <code>set</code> method) has its own, independently initialized copy of the variable. <code>ThreadLocal</code> instances are typically <code>private static</code> fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID).</p>
<p>ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚</p>
<p>å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬(è‡ªå·±ç”¨è‡ªå·±çš„å˜é‡ï¼Œä¸å’Œå…¶ä»–äººå…±äº«ï¼Œäººäººæœ‰ä»½ï¼Œäººå„ä¸€ä»½)ï¼Œä¸»è¦è§£å†³äº†è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œé€šè¿‡ä½¿ç”¨get()å’Œset()æ–¹æ³•ï¼Œè·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">House</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saleHouse</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Integer</span> <span class="n">value</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">House</span> <span class="n">house</span> <span class="o">=</span> <span class="k">new</span> <span class="n">House</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">house</span><span class="o">.</span><span class="na">saleHouse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span><span class="c1">//å¦‚æœä¸æ¸…ç†è‡ªå®šä¹‰çš„ ThreadLocal å˜é‡ï¼Œå¯èƒ½ä¼šå½±å“åç»­ä¸šåŠ¡é€»è¾‘å’Œé€ æˆå†…å­˜æ³„éœ²ç­‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">house</span><span class="o">.</span><span class="na">saleHouse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">house</span><span class="o">.</span><span class="na">saleHouse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---&#34;</span> <span class="o">+</span> <span class="n">house</span><span class="o">.</span><span class="na">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>t1	&mdash;3</p>
<p>t2	&mdash;2</p>
<p>main	&mdash;0</p>
<p>t3	&mdash;5</p>
</blockquote>
<h3 id="threadthreadlocalthreadlocalmap">Threadï¼ŒThreadLocalï¼ŒThreadLocalMap</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThreadLocalMap</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * The entries in this hash map extend WeakReference, using
</span></span></span><span class="line"><span class="cl"><span class="cm">         * its main ref field as the key (which is always a
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ThreadLocal object).  Note that null keys (i.e. entry.get()
</span></span></span><span class="line"><span class="cl"><span class="cm">         * == null) mean that the key is no longer referenced, so the
</span></span></span><span class="line"><span class="cl"><span class="cm">         * entry can be expunged from table.  Such entries are referred to
</span></span></span><span class="line"><span class="cl"><span class="cm">         * as &#34;stale entries&#34; in the code that follows.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="kd">extends</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/** The value associated with this ThreadLocal. */</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Entry</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span><span class="o">,</span> <span class="n">Object</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">super</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">     <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ThreadLocalMapå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªä»¥<code>ThreadLocalå®ä¾‹ä¸ºkey</code>ï¼Œ<code>ä»»æ„å¯¹è±¡ä¸ºvalue</code>çš„<code>Entryå¯¹è±¡</code>ã€‚ å½“ä¸ºThreadLocalå˜é‡èµ‹å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯ä»¥å½“å‰ThreadLocalå®ä¾‹ä¸ºkeyï¼Œå€¼ä¸ºvalueçš„Entryå¾€è¿™ä¸ªthreadLocalMapä¸­å­˜æ”¾ã€‚</p>
<p>è¿‘ä¼¼å¯ä»¥ç†è§£ä¸º: ThreadLocalMapä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªä¿å­˜ThreadLocalå¯¹è±¡çš„map(å…¶å®æ˜¯ä»¥ThreadLocalä¸ºKey)ï¼Œä¸è¿‡æ˜¯ç»è¿‡äº†ä¸¤å±‚åŒ…è£…çš„ThreadLocalå¯¹è±¡ã€‚</p>
<p>JVMå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹ç‰ˆçš„Map&lt;Thread,T&gt;(é€šè¿‡ThreadLocalå¯¹è±¡çš„setæ–¹æ³•ï¼Œç»“æœæŠŠThreadLocalå¯¹è±¡è‡ªå·±å½“åškeyï¼Œæ”¾è¿›äº†ThreadLoalMapä¸­)ï¼Œæ¯ä¸ªçº¿ç¨‹è¦ç”¨åˆ°è¿™ä¸ªTçš„æ—¶å€™ï¼Œç”¨å½“å‰çš„çº¿ç¨‹å»Mapé‡Œé¢è·å–ï¼Œé€šè¿‡è¿™æ ·è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰äº†è‡ªå·±ç‹¬ç«‹çš„å˜é‡ï¼Œäººæ‰‹ä¸€ä»½ï¼Œç«äº‰æ¡ä»¶è¢«å½»åº•æ¶ˆé™¤ï¼Œåœ¨å¹¶å‘æ¨¡å¼ä¸‹æ˜¯ç»å¯¹å®‰å…¨çš„å˜é‡ã€‚</p>
<h3 id="threadlocalå†…å­˜æ³„æ¼">ThreadLocalå†…å­˜æ³„æ¼</h3>
<p>ä¸å†ä¼šè¢«ä½¿ç”¨çš„å¯¹è±¡æˆ–è€…å˜é‡å ç”¨çš„å†…å­˜ä¸èƒ½è¢«å›æ”¶ï¼Œå°±æ˜¯å†…å­˜æ³„éœ²ã€‚</p>
<p>Java å…è®¸ä½¿ç”¨ finalize() æ–¹æ³•åœ¨åƒåœ¾æ”¶é›†å™¨å°†å¯¹è±¡ä»å†…å­˜ä¸­æ¸…é™¤å‡ºå»ä¹‹å‰åšå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚</p>
<h3 id="entryå¼±å¼•ç”¨">Entryå¼±å¼•ç”¨</h3>
<p><strong>ä¸ºä»€ä¹ˆThreadLocalMapçš„Entryè¦ç”¨å¼±å¼•ç”¨?ä¸ç”¨å¦‚ä½•ï¼Ÿ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">function01</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ThreadLocal</span> <span class="n">tl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>    <span class="c1">//line1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tl</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">2021</span><span class="o">);</span>                                   <span class="c1">//line2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>                                       <span class="c1">//line3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//line1æ–°å»ºäº†ä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œtl æ˜¯å¼ºå¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1">//line2è°ƒç”¨set()æ–¹æ³•åæ–°å»ºä¸€ä¸ªEntryï¼Œé€šè¿‡æºç å¯çŸ¥Entryå¯¹è±¡é‡Œçš„kæ˜¯å¼±å¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡ã€‚
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å½“function01æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œæ ˆå¸§é”€æ¯å¼ºå¼•ç”¨ tl ä¹Ÿå°±æ²¡æœ‰äº†ã€‚</p>
<p>ä½†æ­¤æ—¶çº¿ç¨‹çš„ThreadLocalMapé‡ŒæŸä¸ªentryçš„keyå¼•ç”¨è¿˜æŒ‡å‘è¿™ä¸ªå¯¹è±¡,è‹¥è¿™ä¸ªkeyå¼•ç”¨æ˜¯å¼ºå¼•ç”¨ï¼Œå°±ä¼šå¯¼è‡´keyæŒ‡å‘çš„ThreadLocalå¯¹è±¡åŠObject væŒ‡å‘çš„å¯¹è±¡ä¸èƒ½è¢«GCå›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<p>è‹¥è¿™ä¸ªkeyå¼•ç”¨æ˜¯å¼±å¼•ç”¨å°±å¤§æ¦‚ç‡ä¼šå‡å°‘å†…å­˜æ³„æ¼çš„é—®é¢˜(è¿˜æœ‰ä¸€ä¸ªkeyä¸ºnullçš„é›·)ã€‚</p>
<p>ä½¿ç”¨å¼±å¼•ç”¨ï¼Œå°±å¯ä»¥ä½¿ThreadLocalå¯¹è±¡åœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åé¡ºåˆ©è¢«å›æ”¶ä¸”Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnullã€‚</p>
<p><strong>æ­¤åæˆ‘ä»¬è°ƒç”¨get,setæˆ–removeæ–¹æ³•æ—¶ï¼Œå°±ä¼šå°è¯•åˆ é™¤keyä¸ºnullçš„entryï¼Œå¯ä»¥é‡Šæ”¾valueå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜</strong></p>
<p><strong>å¼±å¼•ç”¨å°±ä¸‡äº‹å¤§å‰äº†å—ï¼Ÿ</strong></p>
<ol>
<li>
<p>å½“æˆ‘ä»¬ä¸ºthreadLocalå˜é‡èµ‹å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯å½“å‰çš„Entry(ThreadLocalå®ä¾‹ä¸ºkeyï¼Œå€¼ä¸ºvalue)å¾€è¿™ä¸ªThreadLocalMapä¸­å­˜æ”¾ã€‚</p>
<p>Entryä¸­çš„keyæ˜¯å¼±å¼•ç”¨ï¼Œå½“ThreadLocalå¤–éƒ¨å¼ºå¼•ç”¨è¢«ç½®ä¸ºnull(tl=null),é‚£ä¹ˆç³»ç»Ÿ GC çš„æ—¶å€™ï¼Œæ ¹æ®å¯è¾¾æ€§åˆ†æï¼Œè¿™ä¸ªThreadLocalå®ä¾‹å°±æ²¡æœ‰ä»»ä½•ä¸€æ¡é“¾è·¯èƒ½å¤Ÿå¼•ç”¨åˆ°å®ƒï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š</p>
<p>Thread Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value</p>
<p>æ°¸è¿œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
</li>
<li>
<p>å¦‚æœå½“å‰Threadè¿è¡Œç»“æŸï¼ŒThreadLocalã€ThreadLocalMapã€Entryæ²¡æœ‰å¼•ç”¨é“¾å¯è¾¾ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™éƒ½ä¼šè¢«ç³»ç»Ÿè¿›è¡Œå›æ”¶ã€‚</p>
</li>
<li>
<p>ä½†åœ¨å®é™…ä½¿ç”¨ä¸­æœ‰æ—¶å€™ä¼šç”¨çº¿ç¨‹æ± å»ç»´æŠ¤çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨Executors.newFixedThreadPool()æ—¶åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å¤ç”¨çº¿ç¨‹æ˜¯ä¸ä¼šç»“æŸçš„ï¼Œæ‰€ä»¥ThreadLocalå†…å­˜æ³„æ¼å°±è¦å°å¿ƒã€‚</p>
</li>
</ol>
<h3 id="keyä¸ºnullçš„entry">keyä¸ºnullçš„Entry</h3>
<p>ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»ŸGCçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯(æ¯”å¦‚æ­£å¥½ç”¨åœ¨çº¿ç¨‹æ± )ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ã€‚</p>
<p>è™½ç„¶å¼±å¼•ç”¨ï¼Œä¿è¯äº†keyæŒ‡å‘çš„ThreadLocalå¯¹è±¡èƒ½è¢«åŠæ—¶å›æ”¶ï¼Œä½†æ˜¯væŒ‡å‘çš„valueå¯¹è±¡æ˜¯éœ€è¦ThreadLocalMapè°ƒç”¨getã€setæ—¶å‘ç°keyä¸ºnullæ—¶æ‰ä¼šå»å›æ”¶æ•´ä¸ªentryã€valueï¼Œå› æ­¤å¼±å¼•ç”¨ä¸èƒ½100%ä¿è¯å†…å­˜ä¸æ³„éœ²ã€‚</p>
<p>è¦åœ¨ä¸ä½¿ç”¨æŸä¸ªThreadLocalå¯¹è±¡åï¼Œæ‰‹åŠ¨è°ƒç”¨remoevæ–¹æ³•æ¥åˆ é™¤å®ƒï¼Œå°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¸ä»…ä»…æ˜¯å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œæ„å‘³ç€è¿™ä¸ªçº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ä¹Ÿæ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ‰‹åŠ¨è°ƒç”¨removeæ–¹æ³•ï¼Œé‚£ä¹ˆåé¢çš„çº¿ç¨‹å°±æœ‰å¯èƒ½è·å–åˆ°ä¸Šä¸ªçº¿ç¨‹é—ç•™ä¸‹æ¥çš„valueå€¼ï¼Œé€ æˆbugã€‚</p>
<p>ä»ThreadLocalçš„setã€getEntryã€removeæ–¹æ³•çœ‹å‡ºï¼Œåœ¨ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œé’ˆå¯¹ThreadLocalå­˜åœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œ éƒ½ä¼šé€šè¿‡expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntryè¿™ä¸‰ä¸ªæ–¹æ³•æ¸…ç†æ‰keyä¸ºnullçš„è„entryã€‚</p>
<h3 id="æ€»ç»“-2">æ€»ç»“</h3>
<p>æ¯ä¸ªThreadå¯¹è±¡ç»´æŠ¤ç€ä¸€ä¸ªThreadLocalMapçš„å¼•ç”¨</p>
<p>ThreadLocalMapæ˜¯ThreadLocalçš„å†…éƒ¨ç±»ï¼Œç”¨Entryæ¥è¿›è¡Œå­˜å‚¨</p>
<p>è°ƒç”¨ThreadLocalçš„set()æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¾€ThreadLocalMapè®¾ç½®å€¼ï¼Œkeyæ˜¯ThreadLocalå¯¹è±¡ï¼Œå€¼Valueæ˜¯ä¼ é€’è¿›æ¥çš„å¯¹è±¡</p>
<p>è°ƒç”¨ThreadLocalçš„get()æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¾€ThreadLocalMapè·å–å€¼ï¼Œkeyæ˜¯ThreadLocalå¯¹è±¡</p>
<p>ThreadLocalæœ¬èº«å¹¶ä¸å­˜å‚¨å€¼ï¼Œå®ƒåªæ˜¯è‡ªå·±ä½œä¸ºä¸€ä¸ªkeyæ¥è®©çº¿ç¨‹ä»ThreadLocalMapè·å–valueï¼Œæ­£å› ä¸ºè¿™ä¸ªåŸç†ï¼Œæ‰€ä»¥ThreadLocalèƒ½å¤Ÿå®ç°â€œæ•°æ®éš”ç¦»â€ï¼Œè·å–å½“å‰çº¿ç¨‹çš„å±€éƒ¨å˜é‡å€¼ï¼Œä¸å—å…¶ä»–çº¿ç¨‹å½±å“ã€‚</p>
<ul>
<li>ThreadLocal å¹¶ä¸è§£å†³çº¿ç¨‹é—´å…±äº«æ•°æ®çš„é—®é¢˜</li>
<li>ThreadLocal é€‚ç”¨äºå˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ä¸”åœ¨æ–¹æ³•é—´å…±äº«çš„åœºæ™¯</li>
<li>ThreadLocal é€šè¿‡éšå¼çš„åœ¨ä¸åŒçº¿ç¨‹å†…åˆ›å»ºç‹¬ç«‹å®ä¾‹å‰¯æœ¬é¿å…äº†å®ä¾‹çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</li>
<li>æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªåªå±äºè‡ªå·±çš„ä¸“å±Mapå¹¶ç»´æŠ¤äº†ThreadLocalå¯¹è±¡ä¸å…·ä½“å®ä¾‹çš„æ˜ å°„ï¼Œè¯¥Mapç”±äºåªè¢«æŒæœ‰å®ƒçš„çº¿ç¨‹è®¿é—®ï¼Œæ•…ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨ä»¥åŠé”çš„é—®é¢˜</li>
<li>ThreadLocalMapçš„Entryå¯¹ThreadLocalçš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œé¿å…äº†ThreadLocalå¯¹è±¡æ— æ³•è¢«å›æ”¶çš„é—®é¢˜</li>
<li>éƒ½ä¼šé€šè¿‡expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntryè¿™ä¸‰ä¸ªæ–¹æ³•å›æ”¶é”®ä¸º null çš„ Entry å¯¹è±¡çš„å€¼ï¼ˆå³ä¸ºå…·ä½“å®ä¾‹ï¼‰ä»¥åŠ Entry å¯¹è±¡æœ¬èº«ä»è€Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå±äºå®‰å…¨åŠ å›ºçš„æ–¹æ³•</li>
</ul>
<h3 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h3>
<ol>
<li>ä¸€å®šè¦è¿›è¡Œåˆå§‹åŒ–é¿å…<strong>ç©ºæŒ‡é’ˆé—®é¢˜</strong>ThreadLocal.withInitial(()- &gt; åˆå§‹åŒ–å€¼);</li>
<li>å»ºè®®æŠŠThreadLocalä¿®é¥°ä¸ºstatic</li>
<li>ç”¨å®Œè®°å¾—æ‰‹åŠ¨remove</li>
</ol>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<p>å¼•ç”¨ï¼šå¼ºâ€”â€”&gt;è½¯â€”â€”&gt;å¼±â€”â€”&gt;è™š</p>
<h3 id="1å¼ºå¼•ç”¨é»˜è®¤æ”¯æŒæ¨¡å¼">1ã€å¼ºå¼•ç”¨(é»˜è®¤æ”¯æŒæ¨¡å¼)</h3>
<p>å½“å†…å­˜ä¸è¶³ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå°±ç®—æ˜¯å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œæ­»éƒ½ä¸æ”¶ã€‚</p>
<p>å¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨ Java ä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ï¼Œå³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°JVMä¹Ÿä¸ä¼šå›æ”¶ã€‚å› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸º nullï¼Œä¸€èˆ¬è®¤ä¸ºå°±æ˜¯å¯ä»¥è¢«åƒåœ¾æ”¶é›†çš„äº†(å½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥)ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyObject</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----invoke finalize method&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReferenceDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">strongReference</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">strongReference</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyObject</span> <span class="n">myObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----gc before: &#34;</span> <span class="o">+</span> <span class="n">myObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">myObject</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">gc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----gc after: &#34;</span> <span class="o">+</span> <span class="n">myObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>&mdash;&ndash;gc before: shuo.laoma.concurrent.test.MyObject@5a07e868</p>
<p>&mdash;&ndash;invoke finalize method</p>
<p>&mdash;&ndash;gc after: null</p>
</blockquote>
<h3 id="2è½¯å¼•ç”¨">2ã€è½¯å¼•ç”¨</h3>
<p>è½¯å¼•ç”¨éœ€è¦ç”¨java.lang.ref.SoftReferenceç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ã€‚</p>
<p>å¯¹äºåªæœ‰è½¯å¼•ç”¨çš„å¯¹è±¡æ¥è¯´ï¼Œ</p>
<ul>
<li>å½“ç³»ç»Ÿå†…å­˜å……è¶³æ—¶ä¸ä¼šè¢«å›æ”¶ï¼Œ</li>
<li>å½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ã€‚</li>
</ul>
<p>è½¯å¼•ç”¨é€šå¸¸ç”¨åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå†…å­˜å¤Ÿç”¨çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶ï¼</p>
<h3 id="3å¼±å¼•ç”¨">3ã€å¼±å¼•ç”¨</h3>
<p>å¼±å¼•ç”¨éœ€è¦ç”¨java.lang.ref.WeakReferenceç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨çš„ç”Ÿå­˜æœŸæ›´çŸ­ï¼Œå¯¹äºåªæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ¥è¯´ï¼Œåªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚</p>
<p><strong>è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„é€‚ç”¨åœºæ™¯</strong></p>
<p>å‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡ï¼Œå¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œå¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­åˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡ºï¼Œæ­¤æ—¶ä½¿ç”¨è½¯å¼•ç”¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è®¾è®¡æ€è·¯æ˜¯ï¼šç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;&gt;</span> <span class="n">imageCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;&gt;();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4è™šå¼•ç”¨">4ã€è™šå¼•ç”¨</h3>
<p>è™šå¼•ç”¨éœ€è¦java.lang.ref.PhantomReferenceç±»æ¥å®ç°ã€‚</p>
<p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½¢åŒè™šè®¾ï¼Œä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒï¼Œè™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œå®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ä¹Ÿä¸èƒ½é€šè¿‡å®ƒè®¿é—®å¯¹è±¡ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ— (ReferenceQueue)è”åˆä½¿ç”¨ã€‚</p>
<p>è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ã€‚ ä»…ä»…æ˜¯æä¾›äº†ä¸€ç§ç¡®ä¿å¯¹è±¡è¢« finalizeä»¥åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚</p>
<p>PhantomReferenceçš„getæ–¹æ³•æ€»æ˜¯è¿”å›nullï¼Œå› æ­¤æ— æ³•è®¿é—®å¯¹åº”çš„å¼•ç”¨å¯¹è±¡ã€‚</p>
<p>å…¶æ„ä¹‰åœ¨äºï¼šè¯´æ˜ä¸€ä¸ªå¯¹è±¡å·²ç»è¿›å…¥finalizationé˜¶æ®µï¼Œå¯ä»¥è¢«gcå›æ”¶ï¼Œç”¨æ¥å®ç°æ¯”finalizationæœºåˆ¶æ›´çµæ´»çš„å›æ”¶æ“ä½œã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œè®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥æˆ–è€…åç»­æ·»åŠ è¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p>
<h2 id="javaå¯¹è±¡å†…å­˜å¸ƒå±€å’Œå¯¹è±¡å¤´">Javaå¯¹è±¡å†…å­˜å¸ƒå±€å’Œå¯¹è±¡å¤´</h2>
<h3 id="å¯¹è±¡åœ¨å †å†…å­˜ä¸­å¸ƒå±€">å¯¹è±¡åœ¨å †å†…å­˜ä¸­å¸ƒå±€</h3>
<p><img src="/image/memory-location.png" alt="memory-location"></p>
<p>å¯¹è±¡å†…éƒ¨ç»“æ„åˆ†ä¸ºï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ï¼ˆä¿è¯8ä¸ªå­—èŠ‚çš„å€æ•°ï¼‰ã€‚ å¯¹è±¡å¤´åˆ†ä¸ºå¯¹è±¡æ ‡è®°ï¼ˆmarkOopï¼‰å’Œç±»å…ƒä¿¡æ¯ï¼ˆklassOopï¼‰ï¼Œç±»å…ƒä¿¡æ¯å­˜å‚¨çš„æ˜¯æŒ‡å‘è¯¥å¯¹è±¡<code>ç±»å…ƒæ•°æ®ï¼ˆklassï¼‰</code>çš„<code>é¦–åœ°å€</code>ã€‚</p>
<h3 id="å¯¹è±¡å¤´">å¯¹è±¡å¤´</h3>
<h4 id="å¯¹è±¡æ ‡è®°mark-word">å¯¹è±¡æ ‡è®°Mark Word</h4>
<p>åœ¨64ä½ç³»ç»Ÿä¸­ï¼ŒMark Wordå äº†8ä¸ªå­—èŠ‚ï¼Œç±»å‹æŒ‡é’ˆå äº†8ä¸ªå­—èŠ‚ï¼Œä¸€å…±æ˜¯16ä¸ªå­—èŠ‚ã€‚</p>
<p>é»˜è®¤å­˜å‚¨å¯¹è±¡çš„HashCodeã€åˆ†ä»£å¹´é¾„å’Œé”æ ‡å¿—ä½ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯éƒ½æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰æ— å…³çš„æ•°æ®ï¼Œæ‰€ä»¥MarkWordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å­˜å‚¨å°½é‡å¤šçš„æ•°æ®ã€‚å®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡ŒæœŸé—´MarkWordé‡Œå­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ã€‚</p>
<h4 id="ç±»å…ƒä¿¡æ¯å¯¹è±¡æŒ‡é’ˆ">ç±»å…ƒä¿¡æ¯ï¼ˆå¯¹è±¡æŒ‡é’ˆï¼‰</h4>
<p>å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚</p>
<h3 id="å®ä¾‹æ•°æ®">å®ä¾‹æ•°æ®</h3>
<p>å­˜æ”¾ç±»çš„å±æ€§(Field)æ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬çˆ¶ç±»çš„å±æ€§ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ•°ç»„çš„å®ä¾‹éƒ¨åˆ†è¿˜åŒ…æ‹¬æ•°ç»„çš„é•¿åº¦ï¼Œè¿™éƒ¨åˆ†å†…å­˜æŒ‰<code>4å­—èŠ‚</code>å¯¹é½ã€‚</p>
<h3 id="å¯¹é½å¡«å……">å¯¹é½å¡«å……</h3>
<p>è™šæ‹Ÿæœºè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚å¡«å……æ•°æ®ä¸æ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œä»…ä»…æ˜¯ä¸ºäº†å­—èŠ‚å¯¹é½è¿™éƒ¨åˆ†å†…å­˜æŒ‰<code>8å­—èŠ‚</code>è¡¥å……å¯¹é½ã€‚</p>
<h2 id="synchronizedä¸é”å‡çº§">Synchronizedä¸é”å‡çº§</h2>
<h3 id="1synchronized-é”ä¼˜åŒ–çš„èƒŒæ™¯">1ã€Synchronized é”ä¼˜åŒ–çš„èƒŒæ™¯</h3>
<p>ç”¨é”èƒ½å¤Ÿå®ç°æ•°æ®çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ€§èƒ½ä¸‹é™ã€‚ æ— é”èƒ½å¤ŸåŸºäºçº¿ç¨‹å¹¶è¡Œæå‡ç¨‹åºæ€§èƒ½ï¼Œä½†æ˜¯ä¼šå¸¦æ¥å®‰å…¨æ€§ä¸‹é™ã€‚</p>
<p>synchronizedé”ï¼šç”±å¯¹è±¡å¤´ä¸­çš„<code>Mark Word</code>æ ¹æ®<code>é”æ ‡å¿—ä½</code>çš„ä¸åŒè€Œè¢«å¤ç”¨åŠé”å‡çº§ç­–ç•¥</p>
<h3 id="2synchronizedçš„æ€§èƒ½å˜åŒ–">2ã€Synchronizedçš„æ€§èƒ½å˜åŒ–</h3>
<p>java5ä»¥å‰ï¼Œåªæœ‰Synchronizedï¼Œè¿™ä¸ªæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„é‡é‡çº§æ“ä½œï¼Œé‡é‡çº§é”ï¼Œå‡å¦‚é”çš„ç«äº‰æ¯”è¾ƒæ¿€çƒˆçš„è¯ï¼Œæ€§èƒ½ä¸‹é™</p>
<h4 id="java5ä¹‹å‰ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢">Java5ä¹‹å‰ï¼Œç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢</h4>
<p>Javaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ï¼Œå¦‚æœè¦é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªçº¿ç¨‹å°±éœ€è¦æ“ä½œç³»ç»Ÿä»‹å…¥ï¼Œéœ€è¦åœ¨æˆ·æ€ä¸æ ¸å¿ƒæ€ä¹‹é—´åˆ‡æ¢ï¼Œè¿™ç§åˆ‡æ¢ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼Œå› ä¸ºç”¨æˆ·æ€ä¸å†…æ ¸æ€éƒ½æœ‰å„è‡ªä¸“ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä¸“ç”¨çš„å¯„å­˜å™¨ç­‰ï¼Œç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€éœ€è¦ä¼ é€’ç»™è®¸å¤šå˜é‡ã€å‚æ•°ç»™å†…æ ¸ï¼Œå†…æ ¸ä¹Ÿéœ€è¦ä¿æŠ¤å¥½ç”¨æˆ·æ€åœ¨åˆ‡æ¢æ—¶çš„ä¸€äº›å¯„å­˜å™¨å€¼ã€å˜é‡ç­‰ï¼Œä»¥ä¾¿å†…æ ¸æ€è°ƒç”¨ç»“æŸååˆ‡æ¢å›ç”¨æˆ·æ€ç»§ç»­å·¥ä½œã€‚</p>
<p>åœ¨Javaæ—©æœŸç‰ˆæœ¬ä¸­ï¼Œsynchronizedå±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockæ¥å®ç°çš„ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹éƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€å»å®Œæˆï¼Œé˜»å¡æˆ–å”¤é†’ä¸€ä¸ªJavaçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿåˆ‡æ¢CPUçŠ¶æ€æ¥å®Œæˆï¼Œè¿™ç§çŠ¶æ€åˆ‡æ¢éœ€è¦è€—è´¹å¤„ç†å™¨æ—¶é—´ï¼Œå¦‚æœåŒæ­¥ä»£ç å—ä¸­å†…å®¹è¿‡äºç®€å•ï¼Œè¿™ç§åˆ‡æ¢çš„æ—¶é—´å¯èƒ½æ¯”ç”¨æˆ·ä»£ç æ‰§è¡Œçš„æ—¶é—´è¿˜é•¿â€ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ—©æœŸçš„synchronizedæ•ˆç‡ä½çš„åŸå›  Java 6ä¹‹åï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†è½»é‡çº§é”å’Œåå‘é”</p>
<h4 id="ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥æˆä¸ºä¸€ä¸ªé”">ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥æˆä¸ºä¸€ä¸ªé”ï¼Ÿ</h4>
<p>Monitorå¯ä»¥ç†è§£ä¸ºä¸€ç§åŒæ­¥å·¥å…·ï¼Œä¹Ÿå¯ç†è§£ä¸ºä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå¸¸å¸¸è¢«æè¿°ä¸ºä¸€ä¸ªJavaå¯¹è±¡ã€‚<code>Javaå¯¹è±¡æ˜¯å¤©ç”Ÿçš„Monitor</code>ï¼Œæ¯ä¸€ä¸ªJavaå¯¹è±¡éƒ½æœ‰æˆä¸ºMonitorçš„æ½œè´¨ï¼Œå› ä¸ºåœ¨Javaçš„è®¾è®¡ä¸­ ï¼Œæ¯ä¸€ä¸ªJavaå¯¹è±¡è‡ªæ‰“å¨˜èƒé‡Œå‡ºæ¥å°±å¸¦äº†ä¸€æŠŠçœ‹ä¸è§çš„é”ï¼Œå®ƒå«åšå†…éƒ¨é”æˆ–è€…Monitoré”ã€‚</p>
<p>Monitorçš„æœ¬è´¨æ˜¯ä¾èµ–äºåº•å±‚æ“ä½œç³»ç»Ÿçš„<code>Mutex Lock</code>å®ç°ï¼Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢éœ€è¦ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è½¬æ¢ï¼Œæˆæœ¬éå¸¸é«˜ã€‚</p>
<p>Mutex Lock Monitoræ˜¯åœ¨jvmåº•å±‚å®ç°çš„ï¼Œåº•å±‚ä»£ç æ˜¯c++ã€‚æœ¬è´¨æ˜¯ä¾èµ–äºåº•å±‚æ“ä½œç³»ç»Ÿçš„Mutex Lockå®ç°ï¼Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢éœ€è¦ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è½¬æ¢ï¼ŒçŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´æˆæœ¬éå¸¸é«˜ã€‚æ‰€ä»¥synchronizedæ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ä¸ªé‡é‡çº§æ“ä½œã€‚</p>
<p>Monitorä¸javaå¯¹è±¡ä»¥åŠçº¿ç¨‹æ˜¯å¦‚ä½•å…³è” ï¼Ÿ</p>
<p>1.å¦‚æœä¸€ä¸ªjavaå¯¹è±¡è¢«æŸä¸ªçº¿ç¨‹é”ä½ï¼Œåˆ™è¯¥javaå¯¹è±¡çš„Mark Wordå­—æ®µä¸­LockWordæŒ‡å‘monitorçš„èµ·å§‹åœ°å€</p>
<p>2.Monitorçš„Ownerå­—æ®µä¼šå­˜æ”¾æ‹¥æœ‰ç›¸å…³è”å¯¹è±¡é”çš„çº¿ç¨‹id</p>
<p>Mutex Lock çš„åˆ‡æ¢éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ä¸­ï¼Œå› æ­¤çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´ã€‚</p>
<h4 id="java6å¼€å§‹ä¼˜åŒ–synchronized">java6å¼€å§‹ï¼Œä¼˜åŒ–Synchronized</h4>
<p>Java 6ä¹‹åï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†è½»é‡çº§é”å’Œåå‘é”</p>
<p>éœ€è¦æœ‰ä¸ªé€æ­¥å‡çº§çš„è¿‡ç¨‹ï¼Œåˆ«ä¸€å¼€å§‹å°±æ…åˆ°é‡é‡çº§é”</p>
<h3 id="3synchronizedé”ç§ç±»åŠå‡çº§æ­¥éª¤">3ã€Synchronizedé”ç§ç±»åŠå‡çº§æ­¥éª¤</h3>
<h4 id="å¤šçº¿ç¨‹è®¿é—®æƒ…å†µ3ç§">å¤šçº¿ç¨‹è®¿é—®æƒ…å†µï¼Œ3ç§</h4>
<ul>
<li>åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è®¿é—®ï¼Œæœ‰ä¸”å”¯ä¸€Only One</li>
<li>æœ‰2ä¸ªçº¿ç¨‹Aã€Bæ¥äº¤æ›¿è®¿é—®</li>
<li>ç«äº‰æ¿€çƒˆï¼Œå¤šä¸ªçº¿ç¨‹æ¥è®¿é—®</li>
</ul>
<p><img src="/image/markword-lock.png" alt="markword-lock"></p>
<h4 id="æ— é”">æ— é”</h4>
<h4 id="åå‘é”">åå‘é”</h4>
<p>Hotspot çš„ä½œè€…ç»è¿‡ç ”ç©¶å‘ç°ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼š</p>
<p>å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè¿˜å­˜åœ¨é”ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—çš„æƒ…å†µï¼Œ</p>
<p>åå‘é”å°±æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹å‡ºç°çš„ï¼Œå®ƒçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³åªæœ‰åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥æ—¶æé«˜æ€§èƒ½ã€‚</p>
<p>ç†è®ºè½åœ°ï¼š åœ¨å®é™…åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç°ï¼Œâ€œé”æ€»æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œå¾ˆå°‘å‘ç”Ÿç«äº‰â€ï¼Œä¹Ÿå°±æ˜¯è¯´é”æ€»æ˜¯è¢«ç¬¬ä¸€ä¸ªå ç”¨ä»–çš„çº¿ç¨‹æ‹¥æœ‰ï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ˜¯é”çš„åå‘çº¿ç¨‹ã€‚</p>
<p>é‚£ä¹ˆåªéœ€è¦åœ¨é”ç¬¬ä¸€æ¬¡è¢«æ‹¥æœ‰çš„æ—¶å€™ï¼Œè®°å½•ä¸‹åå‘çº¿ç¨‹IDã€‚è¿™æ ·åå‘çº¿ç¨‹å°±ä¸€ç›´æŒæœ‰ç€é”(åç»­è¿™ä¸ªçº¿ç¨‹è¿›å…¥å’Œé€€å‡ºè¿™æ®µåŠ äº†åŒæ­¥é”çš„ä»£ç å—æ—¶ï¼Œä¸éœ€è¦å†æ¬¡åŠ é”å’Œé‡Šæ”¾é”ã€‚è€Œæ˜¯ç›´æ¥æ¯”è¾ƒå¯¹è±¡å¤´é‡Œé¢æ˜¯å¦å­˜å‚¨äº†æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”)ã€‚ å¦‚æœç›¸ç­‰è¡¨ç¤ºåå‘é”æ˜¯åå‘äºå½“å‰çº¿ç¨‹çš„ï¼Œå°±ä¸éœ€è¦å†å°è¯•è·å¾—é”äº†ï¼Œç›´åˆ°ç«äº‰å‘ç”Ÿæ‰é‡Šæ”¾é”ã€‚ä»¥åæ¯æ¬¡åŒæ­¥ï¼Œæ£€æŸ¥é”çš„åå‘çº¿ç¨‹IDä¸å½“å‰çº¿ç¨‹IDæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ç›´æ¥è¿›å…¥åŒæ­¥ã€‚æ— éœ€æ¯æ¬¡åŠ é”è§£é”éƒ½å»CASæ›´æ–°å¯¹è±¡å¤´ã€‚å¦‚æœè‡ªå§‹è‡³ç»ˆä½¿ç”¨é”çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå¾ˆæ˜æ˜¾åå‘é”å‡ ä¹æ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ€§èƒ½æé«˜ã€‚</p>
<p>å‡å¦‚ä¸ä¸€è‡´æ„å‘³ç€å‘ç”Ÿäº†ç«äº‰ï¼Œé”å·²ç»ä¸æ˜¯æ€»æ˜¯åå‘äºåŒä¸€ä¸ªçº¿ç¨‹äº†ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦å‡çº§å˜ä¸ºè½»é‡çº§é”ï¼Œæ‰èƒ½ä¿è¯çº¿ç¨‹é—´å…¬å¹³ç«äº‰é”ã€‚åå‘é”åªæœ‰é‡åˆ°å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ï¼Œçº¿ç¨‹æ˜¯ä¸ä¼šä¸»åŠ¨é‡Šæ”¾åå‘é”çš„ã€‚</p>
<p>æŠ€æœ¯å®ç°ï¼š ä¸€ä¸ªsynchronizedæ–¹æ³•è¢«ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°äº†é”æ—¶ï¼Œé‚£è¿™ä¸ªæ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡å°±ä¼šåœ¨å…¶æ‰€åœ¨çš„Mark Wordä¸­å°†åå‘é”ä¿®æ”¹çŠ¶æ€ä½ï¼ŒåŒæ—¶è¿˜ ä¼šæœ‰å ç”¨å‰54ä½æ¥å­˜å‚¨çº¿ç¨‹æŒ‡é’ˆä½œä¸ºæ ‡è¯†ã€‚è‹¥è¯¥çº¿ç¨‹å†æ¬¡è®¿é—®åŒä¸€ä¸ªsynchronizedæ–¹æ³•æ—¶ï¼Œè¯¥çº¿ç¨‹åªéœ€å»å¯¹è±¡å¤´çš„Mark Word ä¸­å»åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æœ‰åå‘é”æŒ‡å‘æœ¬èº«çš„IDï¼Œæ— éœ€å†è¿›å…¥ Monitor å»ç«äº‰å¯¹è±¡äº†ã€‚</p>
<p>åå‘é”JVMå‘½ä»¤ï¼š</p>
<blockquote>
<p>java -XX:+PrintFlagsInitial |grep BiasedLock</p>
</blockquote>
<ul>
<li>å®é™…ä¸Šåå‘é”åœ¨JDK1.6ä¹‹åæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä½†æ˜¯å¯åŠ¨æ—¶é—´æœ‰å»¶è¿Ÿï¼Œ</li>
<li>æ‰€ä»¥éœ€è¦æ·»åŠ å‚æ•°-XX:BiasedLockingStartupDelay=0ï¼Œè®©å…¶åœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹åˆ»å¯åŠ¨ã€‚</li>
<li>å¼€å¯åå‘é”ï¼š</li>
<li>-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=0</li>
<li>å…³é—­åå‘é”ï¼šå…³é—­ä¹‹åç¨‹åºé»˜è®¤ä¼šç›´æ¥è¿›å…¥&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&raquo;&raquo;&raquo;&raquo;   è½»é‡çº§é”çŠ¶æ€ã€‚</li>
<li>-XX:-UseBiasedLocking</li>
</ul>
<h4 id="åå‘é”çš„æ’¤é”€">åå‘é”çš„æ’¤é”€</h4>
<p>å½“æœ‰å¦å¤–çº¿ç¨‹é€æ­¥æ¥ç«äº‰é”çš„æ—¶å€™ï¼Œå°±ä¸èƒ½å†ä½¿ç”¨åå‘é”äº†ï¼Œè¦å‡çº§ä¸ºè½»é‡çº§é”</p>
<p>ç«äº‰çº¿ç¨‹å°è¯•CASæ›´æ–°å¯¹è±¡å¤´å¤±è´¥ï¼Œä¼šç­‰å¾…åˆ°<code>å…¨å±€å®‰å…¨ç‚¹</code>ï¼ˆæ­¤æ—¶ä¸ä¼šæ‰§è¡Œä»»ä½•ä»£ç ï¼‰æ’¤é”€åå‘é”ã€‚</p>
<p>åå‘é”ä½¿ç”¨ä¸€ç§ç­‰åˆ°ç«äº‰å‡ºç°æ‰é‡Šæ”¾é”çš„æœºåˆ¶ï¼Œåªæœ‰å½“å…¶ä»–çº¿ç¨‹ç«äº‰é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„åŸæ¥çº¿ç¨‹æ‰ä¼šè¢«æ’¤é”€ã€‚ æ’¤é”€éœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹(è¯¥æ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å­—èŠ‚ç æ­£åœ¨æ‰§è¡Œ)ï¼ŒåŒæ—¶æ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦è¿˜åœ¨æ‰§è¡Œï¼š</p>
<p>â‘  ç¬¬ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œsynchronizedæ–¹æ³•(å¤„äºåŒæ­¥å—)ï¼Œå®ƒè¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå…¶å®ƒçº¿ç¨‹æ¥æŠ¢å¤ºï¼Œè¯¥åå‘é”ä¼šè¢«å–æ¶ˆæ‰å¹¶å‡ºç°é”å‡çº§ã€‚ æ­¤æ—¶è½»é‡çº§é”ç”±åŸæŒæœ‰åå‘é”çš„çº¿ç¨‹æŒæœ‰ï¼Œç»§ç»­æ‰§è¡Œå…¶åŒæ­¥ä»£ç ï¼Œè€Œæ­£åœ¨ç«äº‰çš„çº¿ç¨‹ä¼šè¿›å…¥è‡ªæ—‹ç­‰å¾…è·å¾—è¯¥è½»é‡çº§é”ã€‚</p>
<p>â‘¡ ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆsynchronizedæ–¹æ³•(é€€å‡ºåŒæ­¥å—)ï¼Œåˆ™å°†å¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€å¹¶æ’¤é”€åå‘é”ï¼Œé‡æ–°åå‘ ã€‚</p>
<h4 id="è½»é”">è½»é”</h4>
<p>æœ‰çº¿ç¨‹æ¥å‚ä¸é”çš„ç«äº‰ï¼Œä½†æ˜¯è·å–é”çš„å†²çªæ—¶é—´æçŸ­</p>
<p>æœ¬è´¨å°±æ˜¯è‡ªæ—‹é”</p>
<h5 id="è½»é‡çº§é”çš„è·å–">è½»é‡çº§é”çš„è·å–</h5>
<p>è½»é‡çº§é”æ˜¯ä¸ºäº†åœ¨çº¿ç¨‹è¿‘ä¹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—æ—¶æé«˜æ€§èƒ½ã€‚ ä¸»è¦ç›®çš„ï¼š åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œé€šè¿‡CASå‡å°‘é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ï¼Œè¯´ç™½äº†å…ˆè‡ªæ—‹å†é˜»å¡ã€‚ å‡çº§æ—¶æœºï¼š å½“å…³é—­åå‘é”åŠŸèƒ½æˆ–å¤šçº¿ç¨‹ç«äº‰åå‘é”ä¼šå¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</p>
<p>å‡å¦‚çº¿ç¨‹Aå·²ç»æ‹¿åˆ°é”ï¼Œè¿™æ—¶çº¿ç¨‹Båˆæ¥æŠ¢è¯¥å¯¹è±¡çš„é”ï¼Œç”±äºè¯¥å¯¹è±¡çš„é”å·²ç»è¢«çº¿ç¨‹Aæ‹¿åˆ°ï¼Œå½“å‰è¯¥é”å·²æ˜¯åå‘é”äº†ã€‚ è€Œçº¿ç¨‹Båœ¨äº‰æŠ¢æ—¶å‘ç°å¯¹è±¡å¤´Mark Wordä¸­çš„çº¿ç¨‹IDä¸æ˜¯çº¿ç¨‹Bè‡ªå·±çš„çº¿ç¨‹ID(è€Œæ˜¯çº¿ç¨‹A)ï¼Œé‚£çº¿ç¨‹Bå°±ä¼šè¿›è¡ŒCASæ“ä½œå¸Œæœ›èƒ½è·å¾—é”ã€‚ æ­¤æ—¶çº¿ç¨‹Bæ“ä½œä¸­æœ‰ä¸¤ç§æƒ…å†µï¼š å¦‚æœé”è·å–æˆåŠŸï¼Œç›´æ¥æ›¿æ¢Mark Wordä¸­çš„çº¿ç¨‹IDä¸ºBè‡ªå·±çš„ID(A â†’ B)ï¼Œé‡æ–°åå‘äºå…¶ä»–çº¿ç¨‹(å³å°†åå‘é”äº¤ç»™å…¶ä»–çº¿ç¨‹ï¼Œç›¸å½“äºå½“å‰çº¿ç¨‹&quot;è¢«&quot;é‡Šæ”¾äº†é”)ï¼Œè¯¥é”ä¼šä¿æŒåå‘é”çŠ¶æ€ï¼ŒAçº¿ç¨‹Overï¼ŒBçº¿ç¨‹ä¸Šä½ï¼›</p>
<p>å¦‚æœé”è·å–å¤±è´¥ï¼Œåˆ™åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œæ­¤æ—¶è½»é‡çº§é”ç”±åŸæŒæœ‰åå‘é”çš„çº¿ç¨‹æŒæœ‰ï¼Œç»§ç»­æ‰§è¡Œå…¶åŒæ­¥ä»£ç ï¼Œè€Œæ­£åœ¨ç«äº‰çš„çº¿ç¨‹Bä¼šè¿›å…¥è‡ªæ—‹ç­‰å¾…è·å¾—è¯¥è½»é‡çº§é”ã€‚</p>
<h4 id="è‡ªæ—‹è¾¾åˆ°ä¸€å®šæ¬¡æ•°å’Œç¨‹åº¦">è‡ªæ—‹è¾¾åˆ°ä¸€å®šæ¬¡æ•°å’Œç¨‹åº¦</h4>
<p>java6ä¹‹å‰</p>
<p>é»˜è®¤å¯ç”¨ï¼Œé»˜è®¤æƒ…å†µä¸‹è‡ªæ—‹çš„æ¬¡æ•°æ˜¯ 10 æ¬¡ -XX:PreBlockSpin=10æ¥ä¿®æ”¹ï¼Œæˆ–è€…è‡ªæ—‹çº¿ç¨‹æ•°è¶…è¿‡cpuæ ¸æ•°ä¸€åŠ</p>
<p>Java6ä¹‹å</p>
<p>è‡ªé€‚åº”ï¼Œè‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ¬¡æ•°ä¸æ˜¯å›ºå®šä¸å˜çš„</p>
<p>è€Œæ˜¯æ ¹æ®ï¼šåŒä¸€ä¸ªé”ä¸Šä¸€æ¬¡è‡ªæ—‹çš„æ—¶é—´ï¼Œæ‹¥æœ‰é”çº¿ç¨‹çš„çŠ¶æ€æ¥å†³å®šã€‚</p>
<p>äº‰å¤ºè½»é‡çº§é”å¤±è´¥æ—¶ï¼Œè‡ªæ—‹å°è¯•æŠ¢å é”</p>
<p>è½»é‡çº§é”æ¯æ¬¡é€€å‡ºåŒæ­¥å—éƒ½éœ€è¦é‡Šæ”¾é”ï¼Œè€Œåå‘é”æ˜¯åœ¨ç«äº‰å‘ç”Ÿæ—¶æ‰é‡Šæ”¾é”</p>
<h4 id="é‡é”">é‡é”</h4>
<p>æœ‰å¤§é‡çš„çº¿ç¨‹å‚ä¸é”çš„ç«äº‰ï¼Œå†²çªæ€§å¾ˆé«˜</p>
<h4 id="å„ç§é”ä¼˜ç¼ºç‚¹synchronizedé”å‡çº§å’Œå®ç°åŸç†">å„ç§é”ä¼˜ç¼ºç‚¹ã€synchronizedé”å‡çº§å’Œå®ç°åŸç†</h4>
<p>synchronizedé”å‡çº§è¿‡ç¨‹æ€»ç»“ï¼šä¸€å¥è¯ï¼Œå°±æ˜¯å…ˆè‡ªæ—‹ï¼Œä¸è¡Œå†é˜»å¡ã€‚ å®é™…ä¸Šæ˜¯æŠŠä¹‹å‰çš„æ‚²è§‚é”(é‡é‡çº§é”)å˜æˆåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä½¿ç”¨åå‘é”ä»¥åŠä½¿ç”¨è½»é‡çº§(è‡ªæ—‹é”CAS)çš„å½¢å¼</p>
<p>synchronizedåœ¨ä¿®é¥°æ–¹æ³•å’Œä»£ç å—åœ¨å­—èŠ‚ç ä¸Šå®ç°æ–¹å¼æœ‰å¾ˆå¤§å·®å¼‚ï¼Œä½†æ˜¯å†…éƒ¨å®ç°è¿˜æ˜¯åŸºäºå¯¹è±¡å¤´çš„MarkWordæ¥å®ç°çš„ã€‚ JDK1.6ä¹‹å‰synchronizedä½¿ç”¨çš„æ˜¯é‡é‡çº§é”ï¼ŒJDK1.6ä¹‹åè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‹¥æœ‰äº†æ— é”â€”â€”&gt;åå‘é”â€”â€”&gt;è½»é‡çº§é”â€”â€”&gt;é‡é‡çº§é”çš„å‡çº§è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯æ— è®ºä»€ä¹ˆæƒ…å†µéƒ½ä½¿ç”¨é‡é‡çº§é”ã€‚</p>
<p>åå‘é”:é€‚ç”¨äºå•çº¿ç¨‹é€‚ç”¨çš„æƒ…å†µï¼Œåœ¨ä¸å­˜åœ¨é”ç«äº‰çš„æ—¶å€™è¿›å…¥åŒæ­¥æ–¹æ³•/ä»£ç å—åˆ™ä½¿ç”¨åå‘é”ã€‚</p>
<p>è½»é‡çº§é”ï¼šé€‚ç”¨äºç«äº‰è¾ƒä¸æ¿€çƒˆçš„æƒ…å†µ(è¿™å’Œä¹è§‚é”çš„ä½¿ç”¨èŒƒå›´ç±»ä¼¼)ï¼Œ å­˜åœ¨ç«äº‰æ—¶å‡çº§ä¸ºè½»é‡çº§é”ï¼Œè½»é‡çº§é”é‡‡ç”¨çš„æ˜¯è‡ªæ—‹é”ï¼Œå¦‚æœåŒæ­¥æ–¹æ³•/ä»£ç å—æ‰§è¡Œæ—¶é—´å¾ˆçŸ­çš„è¯ï¼Œé‡‡ç”¨è½»é‡çº§é”è™½ç„¶ä¼šå ç”¨cpuèµ„æºä½†æ˜¯ç›¸å¯¹æ¯”ä½¿ç”¨é‡é‡çº§é”è¿˜æ˜¯æ›´é«˜æ•ˆã€‚</p>
<p>é‡é‡çº§é”ï¼šé€‚ç”¨äºç«äº‰æ¿€çƒˆçš„æƒ…å†µï¼Œå¦‚æœåŒæ­¥æ–¹æ³•/ä»£ç å—æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆä½¿ç”¨è½»é‡çº§é”è‡ªæ—‹å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—å°±æ¯”ä½¿ç”¨é‡é‡çº§é”æ›´ä¸¥é‡ï¼Œè¿™æ—¶å€™å°±éœ€è¦å‡çº§ä¸ºé‡é‡çº§é”ã€‚</p>
<h3 id="4jitç¼–è¯‘å™¨å¯¹é”çš„ä¼˜åŒ–">4ã€JITç¼–è¯‘å™¨å¯¹é”çš„ä¼˜åŒ–</h3>
<p>Just In Time Compilerï¼Œä¸€èˆ¬ç¿»è¯‘ä¸ºå³æ—¶ç¼–è¯‘å™¨</p>
<h4 id="é”æ¶ˆé™¤">é”æ¶ˆé™¤</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é”æ¶ˆé™¤
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»JITè§’åº¦çœ‹ç›¸å½“äºæ— è§†å®ƒï¼Œsynchronized (o)ä¸å­˜åœ¨äº†,è¿™ä¸ªé”å¯¹è±¡å¹¶æ²¡æœ‰è¢«å…±ç”¨æ‰©æ•£åˆ°å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æç«¯çš„è¯´å°±æ˜¯æ ¹æœ¬æ²¡æœ‰åŠ è¿™ä¸ªé”å¯¹è±¡çš„åº•å±‚æœºå™¨ç ï¼Œæ¶ˆé™¤äº†é”çš„ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockClearUpDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ­£å¸¸çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">static</span> <span class="n">Object</span> <span class="n">objectLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">m1</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//é”æ¶ˆé™¤,JITä¼šæ— è§†å®ƒï¼Œsynchronized(å¯¹è±¡é”)ä¸å­˜åœ¨äº†ã€‚ä¸æ­£å¸¸çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----hello LockClearUPDemo&#34;</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">objectLock</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockClearUpDemo</span> <span class="n">demo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockClearUpDemo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">demo</span><span class="o">.</span><span class="na">m1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é”ç²—åŒ–">é”ç²—åŒ–</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * é”ç²—åŒ–
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å‡å¦‚æ–¹æ³•ä¸­é¦–å°¾ç›¸æ¥ï¼Œå‰åç›¸é‚»çš„éƒ½æ˜¯åŒä¸€ä¸ªé”å¯¹è±¡ï¼Œé‚£JITç¼–è¯‘å™¨å°±ä¼šæŠŠè¿™å‡ ä¸ªsynchronizedå—åˆå¹¶æˆä¸€ä¸ªå¤§å—ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åŠ ç²—åŠ å¤§èŒƒå›´ï¼Œä¸€æ¬¡ç”³è¯·é”ä½¿ç”¨å³å¯ï¼Œé¿å…æ¬¡æ¬¡çš„ç”³è¯·å’Œé‡Šæ”¾é”ï¼Œæå‡äº†æ€§èƒ½
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockBigDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Object</span> <span class="n">objectLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;11111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;22222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;33333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;a&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">objectLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;11111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;22222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;33333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="s">&#34;b&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="abstractqueuedsynchronizeraqs">AbstractQueuedSynchronizer(AQS)</h2>
<h3 id="aqsæ¦‚å¿µ">AQSæ¦‚å¿µ</h3>
<p>AbstractOwnableSynchronizer</p>
<p>AbstractQueuedLongSynchronizer</p>
<p>AbstractQueuedSynchronizer</p>
<p>é€šå¸¸åœ°ï¼šAbstractQueuedSynchronizerç®€ç§°ä¸ºAQS</p>
<p>AQSï¼šæ˜¯ç”¨æ¥æ„å»º<code>é”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶</code>çš„åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€ã€‚</p>
<p>CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—FIFO</p>
<h3 id="é”å’ŒåŒæ­¥å™¨">é”å’ŒåŒæ­¥å™¨</h3>
<p>é”ï¼šé¢å‘é”çš„ä½¿ç”¨è€…ã€‚å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚APIï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼Œè°ƒç”¨å³å¯ã€‚</p>
<p>åŒæ­¥å™¨ï¼šé¢å‘é”çš„å®ç°è€…ã€‚æ¯”å¦‚Javaå¹¶å‘å¤§ç¥Doug Leeï¼Œæå‡ºç»Ÿä¸€è§„èŒƒå¹¶ç®€åŒ–äº†é”çš„å®ç°ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€é˜»å¡çº¿ç¨‹æ’é˜Ÿå’Œé€šçŸ¥ã€å”¤é†’æœºåˆ¶ç­‰ã€‚</p>
<p>åŠ é”ä¼šå¯¼è‡´é˜»å¡ï¼Œæœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—</p>
<p>æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚</p>
<p>æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ</p>
<p>å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚</p>
<h3 id="aqsæºç ">AQSæºç </h3>
<p>æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—</p>
<p>AQSä½¿ç”¨ä¸€ä¸ªvolatileçš„intç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çš„æ’é˜Ÿå·¥ä½œå°†æ¯æ¡è¦å»æŠ¢å èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…ï¼Œé€šè¿‡CASå®Œæˆå¯¹Stateå€¼çš„ä¿®æ”¹ã€‚</p>
<p><img src="/image/AQS-Node.png" alt="AQS-Node"></p>
<p>å¯ä»¥æ˜æ˜¾çœ‹å‡ºå…¬å¹³é”ä¸éå…¬å¹³é”çš„lock()æ–¹æ³•å”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºå…¬å¹³é”åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶å¤šäº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼š hasQueuedPredecessors()</p>
<p>hasQueuedPredecessorsæ˜¯å…¬å¹³é”åŠ é”æ—¶åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æœ‰æ•ˆèŠ‚ç‚¹çš„æ–¹æ³•</p>
<p><img src="/image/ReetrantLock.png" alt="ReentrantLock"></p>
<p>å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ <code>!hasQueuedPredecessors()</code></p>
<p>hasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š</p>
<p>å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›</p>
<p>éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰</p>
<p><img src="/image/Sync.png" alt="Sync"></p>
<h4 id="acquire">acquire</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ReservedStackAccess</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸»è¦å®Œæˆäº†åŒæ­¥çŠ¶æ€è·å–ã€èŠ‚ç‚¹æ„é€ ã€åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä»¥åŠåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è‡ªæ—‹ç­‰å¾…çš„ç›¸å…³å·¥ä½œï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼šé¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„tryAcquire(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼Node.EXCLUSIVEï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼‰å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œæœ€åè°ƒç”¨acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè€Œè¢«é˜»å¡çº¿ç¨‹çš„å”¤é†’ä¸»è¦ä¾é <code>å‰é©±èŠ‚ç‚¹çš„å‡ºé˜Ÿ</code>æˆ–<code>é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­</code>æ¥å®ç°ã€‚</p>
<h4 id="tryacquire">tryAcquire</h4>
<p>FairSync</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Sync object for fair locks
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">FairSync</span> <span class="kd">extends</span> <span class="n">Sync</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">3000897897090466540L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Fair version of tryAcquire.  Don&#39;t grant access unless
</span></span></span><span class="line"><span class="cl"><span class="cm">     * recursive call or no waiters or is first.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ReservedStackAccess</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">hasQueuedPredecessors</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>NonfairSync</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Sync object for non-fair locks
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NonfairSync</span> <span class="kd">extends</span> <span class="n">Sync</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">7316153563782823691L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Performs lock.  Try immediate barge, backing up to normal
</span></span></span><span class="line"><span class="cl"><span class="cm">     * acquire on failure.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ReservedStackAccess</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">acquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">nonfairTryAcquire</span><span class="o">(</span><span class="n">acquires</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>nonfairTryAcquire</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Performs non-fair tryLock.  tryAcquire is implemented in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * subclasses, but both need nonfair try for trylock method.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ReservedStackAccess</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">nonfairTryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="addwaiter">addWaiter</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Creates and enqueues node for current thread and given mode.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the new node
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Node</span> <span class="nf">addWaiter</span><span class="o">(</span><span class="n">Node</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span> <span class="n">mode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try the fast path of enq; backup to full enq on failure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Node</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetTail</span><span class="o">(</span><span class="n">pred</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">enq</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>enq(node)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Inserts node into queue, initializing if necessary. See picture above.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param node the node to insert
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return node&#39;s predecessor
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Node</span> <span class="nf">enq</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Must initialize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetHead</span><span class="o">(</span><span class="k">new</span> <span class="n">Node</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                <span class="n">tail</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetTail</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirequeued">acquireQueued</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Acquires in exclusive uninterruptible mode for thread already in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * queue. Used by condition wait methods as well as acquire.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param node the node
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param arg the acquire argument
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@code true} if interrupted while waiting
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ReservedStackAccess</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>shouldParkAfterFailedAcquire</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Checks and updates status for a node that failed to acquire.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Returns true if thread should block. This is the main signal
</span></span></span><span class="line"><span class="cl"><span class="cm"> * control in all acquire loops.  Requires that pred == node.prev.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param pred node&#39;s predecessor holding status
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param node the node
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@code true} if thread should block
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">Node</span> <span class="n">pred</span><span class="o">,</span> <span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * This node has already set status asking a release
</span></span></span><span class="line"><span class="cl"><span class="cm">         * to signal it, so it can safely park.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Predecessor was cancelled. Skip over predecessors and
</span></span></span><span class="line"><span class="cl"><span class="cm">         * indicate retry.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * waitStatus must be 0 or PROPAGATE.  Indicate that we
</span></span></span><span class="line"><span class="cl"><span class="cm">         * need a signal, but don&#39;t park yet.  Caller will need to
</span></span></span><span class="line"><span class="cl"><span class="cm">         * retry to make sure it cannot acquire before parking.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">pred</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>parkAndCheckInterrupt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Convenience method to park and then check if interrupted
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@code true} if interrupted
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">parkAndCheckInterrupt</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶twinslock">è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TwinsLock</span> <span class="kd">implements</span> <span class="n">Lock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sync</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="n">AbstractQueuedSynchronizer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">7889272986162341211L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Sync</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;count must large than zero.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">setState</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">tryAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">reduceCount</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">newCount</span> <span class="o">=</span> <span class="n">current</span> <span class="o">-</span> <span class="n">reduceCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">newCount</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">newCount</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">newCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryReleaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">returnCount</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">newCount</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">returnCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">newCount</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ConditionObject</span> <span class="nf">newCondition</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">ConditionObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sync</span><span class="o">.</span><span class="na">acquireShared</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sync</span><span class="o">.</span><span class="na">releaseShared</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockInterruptibly</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sync</span><span class="o">.</span><span class="na">acquireSharedInterruptibly</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquireShared</span><span class="o">(</span><span class="n">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">(</span><span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquireSharedNanos</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">time</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Condition</span> <span class="nf">newCondition</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>TwinsLockå®ç°äº†Lockæ¥å£ï¼Œæä¾›äº†é¢å‘ä½¿ç”¨è€…çš„æ¥å£ï¼Œä½¿ç”¨è€…è°ƒç”¨lock()æ–¹æ³•è·å–é”ï¼Œéšåè°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ï¼Œè€ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°é”ã€‚TwinsLockåŒæ—¶åŒ…å«äº†ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥å™¨Syncï¼Œè€Œè¯¥åŒæ­¥å™¨é¢å‘çº¿ç¨‹è®¿é—®å’ŒåŒæ­¥çŠ¶æ€æ§åˆ¶ã€‚ä»¥å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ä¸ºä¾‹ï¼šåŒæ­¥å™¨ä¼šå…ˆè®¡ç®—å‡ºè·å–åçš„åŒæ­¥çŠ¶æ€ï¼Œç„¶åé€šè¿‡CASç¡®ä¿çŠ¶æ€çš„æ­£ç¡®è®¾ç½®ï¼Œå½“tryAcquireShared(int reduceCount)æ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œå½“å‰çº¿ç¨‹æ‰è·å–åŒæ­¥çŠ¶æ€ï¼Œå¯¹äºä¸Šå±‚çš„TwinsLockè€Œè¨€ï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—äº†é”ã€‚</p>
<h2 id="reentrantreadwritelockstampedlock">ReentrantReadWriteLockã€StampedLock</h2>
<h3 id="reentrantreadwritelock">ReentrantReadWriteLock</h3>
<p>è¯»å†™é”ReentrantReadWriteLockå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„è¯»å†™åˆ†ç¦»ï¼Œå®ƒåªå…è®¸<code>è¯»è¯»å…±å­˜</code>ï¼Œè€Œè¯»å†™å’Œå†™å†™ä¾ç„¶æ˜¯äº’æ–¥çš„ï¼Œ å¤§å¤šå®é™…åœºæ™¯æ˜¯â€œè¯»/è¯»â€çº¿ç¨‹é—´å¹¶ä¸å­˜åœ¨äº’æ–¥å…³ç³»ï¼Œåªæœ‰&quot;è¯»/å†™&quot;çº¿ç¨‹æˆ–&quot;å†™/å†™&quot;çº¿ç¨‹é—´çš„æ“ä½œéœ€è¦äº’æ–¥çš„ã€‚å› æ­¤å¼•å…¥ReentrantReadWriteLockã€‚</p>
<p>ä¸€ä¸ªReentrantReadWriteLockåŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªå†™é”ä½†æ˜¯å¯ä»¥å­˜åœ¨å¤šä¸ªè¯»é”ï¼Œä½†ä¸èƒ½åŒæ—¶å­˜åœ¨å†™é”å’Œè¯»é”ã€‚ä¹Ÿå³ä¸€ä¸ªèµ„æºå¯ä»¥è¢«<code>å¤šä¸ªè¯»æ“ä½œ</code>è®¿é—®æˆ–<code>ä¸€ä¸ªå†™æ“ä½œ</code>è®¿é—®ï¼Œä½†ä¸¤è€…ä¸èƒ½åŒæ—¶è¿›è¡Œã€‚</p>
<p>åªæœ‰åœ¨è¯»å¤šå†™å°‘æƒ…å¢ƒä¹‹ä¸‹ï¼Œè¯»å†™é”æ‰å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ä½“ç°ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å¯é‡å…¥</li>
<li>è¯»å†™åˆ†ç¦»</li>
</ul>
<h3 id="å†™é”çš„è·å–ä¸é‡Šæ”¾">å†™é”çš„è·å–ä¸é‡Šæ”¾</h3>
<p>å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œ<code>è¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º0ï¼‰</code>æˆ–è€…<code>è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹</code>ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>è·å–å†™é”çš„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Walkthrough:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 1. If read count nonzero or write count nonzero
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and owner is a different thread, fail.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 2. If count would saturate, fail. (This can only
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    happen if count is already nonzero.)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 3. Otherwise, this thread is eligible for lock if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    it is either a reentrant acquire or
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    queue policy allows it. If so, update state
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and set owner.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// (Note: if c != 0 and w == 0 then shared count != 0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">acquires</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">MAX_COUNT</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Reentrant acquire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setState</span><span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">writerShouldBlock</span><span class="o">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯¥æ–¹æ³•é™¤äº†é‡å…¥æ¡ä»¶ï¼ˆå½“å‰çº¿ç¨‹ä¸ºè·å–äº†å†™é”çš„çº¿ç¨‹ï¼‰ä¹‹å¤–ï¼Œå¢åŠ äº†ä¸€ä¸ªè¯»é”æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ã€‚å¦‚æœå­˜åœ¨è¯»é”ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ï¼ŒåŸå› åœ¨äºï¼šè¯»å†™é”è¦ç¡®ä¿å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœå…è®¸è¯»é”åœ¨å·²è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚å› æ­¤ï¼Œåªæœ‰ç­‰å¾…å…¶ä»–è¯»çº¿ç¨‹éƒ½é‡Šæ”¾äº†è¯»é”ï¼Œå†™é”æ‰èƒ½è¢«å½“å‰çº¿ç¨‹è·å–ï¼Œè€Œå†™é”ä¸€æ—¦è¢«è·å–ï¼Œåˆ™å…¶ä»–è¯»å†™çº¿ç¨‹çš„åç»­è®¿é—®å‡è¢«é˜»å¡ã€‚</p>
<p>å†™é”çš„é‡Šæ”¾ä¸ReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å‡å°‘å†™çŠ¶æ€ï¼Œå½“å†™çŠ¶æ€ä¸º0æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾ï¼Œä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹èƒ½å¤Ÿç»§ç»­è®¿é—®è¯»å†™é”ï¼ŒåŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­è¯»å†™çº¿ç¨‹å¯è§ã€‚</p>
<h3 id="é”é™çº§">é”é™çº§</h3>
<p>é”çš„ä¸¥è‹›ç¨‹åº¦å˜å¼ºå«åšå‡çº§ï¼Œåä¹‹å«åšé™çº§</p>
<p>é”é™çº§ï¼šå°†å†™å…¥é”é™çº§ä¸ºè¯»é”(ç±»ä¼¼Linuxæ–‡ä»¶è¯»å†™æƒé™ç†è§£ï¼Œå°±åƒå†™æƒé™è¦é«˜äºè¯»æƒé™ä¸€æ ·)</p>
<p>è·å¾—å†™é”â€”â€”&gt;è·å¾—è¯»é”â€”â€”&gt;é‡Šæ”¾å†™é” â€”â€”&gt;é‡Šæ”¾è¯»é”</p>
<p>é‡å…¥è¿˜å…è®¸é€šè¿‡è·å–å†™å…¥é”å®šï¼Œç„¶åè¯»å–é”ç„¶åé‡Šæ”¾å†™é”ä»å†™é”åˆ°è¯»å–é”, ä½†æ˜¯ï¼Œä»è¯»é”å®šå‡çº§åˆ°å†™é”æ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<p><strong>é”é™çº§æ˜¯ä¸ºäº†è®©å½“å‰çº¿ç¨‹æ„ŸçŸ¥åˆ°æ•°æ®çš„å˜åŒ–ï¼Œç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§</strong></p>
<p>é”é™çº§ä¸­è¯»é”çš„è·å–æ˜¯å¦å¿…è¦å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¿…è¦çš„ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸è·å–è¯»é”è€Œæ˜¯ç›´æ¥é‡Šæ”¾å†™é”ï¼Œå‡è®¾æ­¤åˆ»å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆè®°ä½œçº¿ç¨‹Tï¼‰è·å–äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ— æ³•æ„ŸçŸ¥çº¿ç¨‹Tçš„æ•°æ®æ›´æ–°ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–è¯»é”ï¼Œå³éµå¾ªé”é™çº§çš„æ­¥éª¤ï¼Œåˆ™çº¿ç¨‹Tå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹ä½¿ç”¨æ•°æ®å¹¶é‡Šæ”¾è¯»é”ä¹‹åï¼Œçº¿ç¨‹Tæ‰èƒ½è·å–å†™é”è¿›è¡Œæ•°æ®æ›´æ–°ã€‚</p>
<p><strong>å¦‚æœæœ‰çº¿ç¨‹åœ¨è¯»ï¼Œé‚£ä¹ˆå†™çº¿ç¨‹æ˜¯æ— æ³•è·å–å†™é”çš„ï¼Œæ˜¯æ‚²è§‚é”çš„ç­–ç•¥</strong></p>
<p>ä¸å¯é”å‡çº§</p>
<p>çº¿ç¨‹è·å–è¯»é”æ˜¯ä¸èƒ½ç›´æ¥å‡çº§ä¸ºå†™å…¥é”çš„ã€‚</p>
<p>åœ¨ReentrantReadWriteLockä¸­ï¼Œå½“è¯»é”è¢«ä½¿ç”¨æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å°è¯•è·å–å†™é”ï¼Œè¯¥å†™çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚æ‰€ä»¥ï¼Œéœ€è¦é‡Šæ”¾æ‰€æœ‰è¯»é”ï¼Œæ‰å¯è·å–å†™é”</p>
<p>StampedLockçš„æ”¹è¿›ä¹‹å¤„åœ¨äºï¼šè¯»çš„è¿‡ç¨‹ä¸­ä¹Ÿå…è®¸è·å–å†™é”ä»‹å…¥(ç›¸å½“ç‰›Bï¼Œè¯»å’Œå†™ä¸¤ä¸ªæ“ä½œä¹Ÿè®©ä½ â€œå…±äº«â€(æ³¨æ„å¼•å·))ï¼Œè¿™æ ·ä¼šå¯¼è‡´è¯»çš„æ•°æ®å°±å¯èƒ½ä¸ä¸€è‡´ï¼æ‰€ä»¥ï¼Œéœ€è¦é¢å¤–çš„æ–¹æ³•æ¥åˆ¤æ–­è¯»çš„è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å†™å…¥ï¼Œè¿™æ˜¯ä¸€ç§ä¹è§‚çš„è¯»é”ã€‚ æ˜¾ç„¶ä¹è§‚é”çš„å¹¶å‘æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸€æ—¦æœ‰å°æ¦‚ç‡çš„å†™å…¥å¯¼è‡´è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦èƒ½æ£€æµ‹å‡ºæ¥ï¼Œå†è¯»ä¸€éå°±è¡Œã€‚</p>
<h3 id="å¦‚ä½•ç¼“è§£é”é¥¥é¥¿é—®é¢˜">å¦‚ä½•ç¼“è§£é”é¥¥é¥¿é—®é¢˜ï¼Ÿ</h3>
<p>ä½¿ç”¨â€œå…¬å¹³â€ç­–ç•¥å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£è¿™ä¸ªé—®é¢˜</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">new</span> <span class="n">ReentrantReadWriteLock</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯â€œå…¬å¹³â€ç­–ç•¥æ˜¯ä»¥ç‰ºç‰²ç³»ç»Ÿååé‡ä¸ºä»£ä»·çš„</p>
<p><strong>StampedLockç±»çš„ä¹è§‚è¯»é”é—ªäº®ç™»åœº</strong></p>
<p>ReentrantReadWriteLock</p>
<p>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œåœ¨çº¿ç¨‹è·å–åˆ°å†™é”çš„æ—¶å€™ï¼Œå…¶ä»–å†™æ“ä½œå’Œè¯»æ“ä½œéƒ½ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œ</p>
<p>è¯»é”å’Œå†™é”ä¹Ÿæ˜¯äº’æ–¥çš„ï¼Œæ‰€ä»¥åœ¨è¯»çš„æ—¶å€™æ˜¯ä¸å…è®¸å†™çš„ï¼Œè¯»å†™é”æ¯”ä¼ ç»Ÿçš„synchronizedé€Ÿåº¦è¦å¿«å¾ˆå¤šï¼Œ</p>
<p>åŸå› å°±æ˜¯åœ¨äºReentrantReadWriteLockæ”¯æŒè¯»å¹¶å‘</p>
<p>StampedLock</p>
<p>ReentrantReadWriteLockçš„è¯»é”è¢«å ç”¨çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹å°è¯•è·å–å†™é”çš„æ—¶å€™ä¼šè¢«é˜»å¡ã€‚</p>
<p>ä½†æ˜¯ï¼ŒStampedLocké‡‡å–ä¹è§‚è·å–é”åï¼Œå…¶ä»–çº¿ç¨‹å°è¯•è·å–å†™é”æ—¶ä¸ä¼šè¢«é˜»å¡ï¼Œè¿™å…¶å®æ˜¯å¯¹è¯»é”çš„ä¼˜åŒ–ï¼Œ</p>
<p>æ‰€ä»¥ï¼Œåœ¨è·å–ä¹è§‚è¯»é”åï¼Œè¿˜éœ€è¦å¯¹ç»“æœè¿›è¡Œæ ¡éªŒã€‚</p>
<h3 id="é‚®æˆ³é”stampedlock">é‚®æˆ³é”StampedLock</h3>
<p>æ— é”â†’ç‹¬å é”â†’è¯»å†™é”â†’é‚®æˆ³é”</p>
<p>StampedLockæ˜¯JDK1.8ä¸­æ–°å¢çš„ä¸€ä¸ªè¯»å†™é”ï¼Œä¹Ÿæ˜¯å¯¹JDK1.5ä¸­çš„è¯»å†™é”ReentrantReadWriteLockçš„ä¼˜åŒ–ã€‚</p>
<p>é‚®æˆ³é” - ä¹Ÿå«ç¥¨æ®é”</p>
<blockquote>
<p>stampï¼ˆæˆ³è®°ï¼Œlongç±»å‹ï¼‰</p>
<p>ä»£è¡¨äº†é”çš„çŠ¶æ€ã€‚å½“stampè¿”å›é›¶æ—¶ï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”å¤±è´¥ã€‚å¹¶ä¸”ï¼Œå½“é‡Šæ”¾é”æˆ–è€…è½¬æ¢é”çš„æ—¶å€™ï¼Œéƒ½è¦ä¼ å…¥æœ€åˆè·å–çš„stampå€¼ã€‚</p>
</blockquote>
<p>StampedLockç”±é”é¥¥é¥¿é—®é¢˜å¼•å‡º</p>
<p>ReentrantReadWriteLockå®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œä½†æ˜¯ä¸€æ—¦è¯»æ“ä½œæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæƒ³è¦è·å–å†™é”å°±å˜å¾—æ¯”è¾ƒå›°éš¾äº†ï¼Œå‡å¦‚å½“å‰1000ä¸ªçº¿ç¨‹ï¼Œ999ä¸ªè¯»ï¼Œ1ä¸ªå†™ï¼Œæœ‰å¯èƒ½999ä¸ªè¯»å–çº¿ç¨‹é•¿æ—¶é—´æŠ¢åˆ°äº†é”ï¼Œé‚£1ä¸ªå†™çº¿ç¨‹å°±æ‚²å‰§äº† å› ä¸ºå½“å‰æœ‰å¯èƒ½ä¼šä¸€ç›´å­˜åœ¨è¯»é”ï¼Œè€Œæ— æ³•è·å¾—å†™é”ï¼Œæ ¹æœ¬æ²¡æœºä¼šå†™</p>
<h5 id="stampedlockçš„ç‰¹ç‚¹">StampedLockçš„ç‰¹ç‚¹</h5>
<ul>
<li>æ‰€æœ‰è·å–é”çš„æ–¹æ³•ï¼Œéƒ½è¿”å›ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼ŒStampä¸ºé›¶è¡¨ç¤ºè·å–å¤±è´¥ï¼Œå…¶ä½™éƒ½è¡¨ç¤ºæˆåŠŸï¼›</li>
<li>æ‰€æœ‰é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œéƒ½éœ€è¦ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼Œè¿™ä¸ªStampå¿…é¡»æ˜¯å’ŒæˆåŠŸè·å–é”æ—¶å¾—åˆ°çš„Stampä¸€è‡´ï¼›</li>
<li>StampedLockæ˜¯ä¸å¯é‡å…¥çš„ï¼Œå±é™©(å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†å†™é”ï¼Œå†å»è·å–å†™é”çš„è¯å°±ä¼šé€ æˆæ­»é”)</li>
</ul>
<h5 id="stampedlockæœ‰ä¸‰ç§è®¿é—®æ¨¡å¼">StampedLockæœ‰ä¸‰ç§è®¿é—®æ¨¡å¼</h5>
<ol>
<li>Readingï¼ˆè¯»æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„è¯»é”ç±»ä¼¼</li>
<li>Writingï¼ˆå†™æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„å†™é”ç±»ä¼¼</li>
<li>Optimistic readingï¼ˆä¹è§‚è¯»æ¨¡å¼ï¼‰ï¼šæ— é”æœºåˆ¶ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„ä¹è§‚é”ï¼Œæ”¯æŒè¯»å†™å¹¶å‘ï¼Œå¾ˆä¹è§‚è®¤ä¸ºè¯»å–æ—¶æ²¡äººä¿®æ”¹ï¼Œå‡å¦‚è¢«ä¿®æ”¹å†å®ç°å‡çº§ä¸ºæ‚²è§‚è¯»æ¨¡å¼</li>
</ol>
<h5 id="stampedlockçš„ç¼ºç‚¹">StampedLockçš„ç¼ºç‚¹</h5>
<ul>
<li>StampedLock ä¸æ”¯æŒé‡å…¥ï¼Œæ²¡æœ‰Reå¼€å¤´</li>
<li>StampedLock çš„æ‚²è§‚è¯»é”å’Œå†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ï¼ˆConditionï¼‰ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦æ³¨æ„ã€‚</li>
<li>ä½¿ç”¨ StampedLockä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå³ä¸è¦è°ƒç”¨interrupt() æ–¹æ³•
<ul>
<li>å¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é” readLockInterruptibly()å’Œå†™é”writeLockInterruptibly()</li>
</ul>
</li>
</ul>
<h2 id="å€’è®¡æ—¶é—¨æ “countdownlatch">å€’è®¡æ—¶é—¨æ “CountDownLatch</h2>
<p>ä½¿ç”¨joinæ–¹æ³•è®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œjoinå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†waitã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åªè¦çº¿ç¨‹æ˜¯æ´»ç€çš„ï¼ŒisAlive()è¿”å›true, joinå°±ä¸€ç›´ç­‰å¾…ã€‚è°æ¥é€šçŸ¥å®ƒå‘¢ï¼Ÿå½“çº¿ç¨‹è¿è¡Œç»“æŸçš„æ—¶å€™ï¼ŒJavaç³»ç»Ÿè°ƒç”¨notifyAllæ¥é€šçŸ¥ã€‚</p>
<p>ä½¿ç”¨joinæœ‰æ—¶æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ä¸»çº¿ç¨‹é€ä¸€ç­‰å¾…æ¯ä¸ªå­çº¿ç¨‹ã€‚</p>
<h3 id="mylatch">MyLatch</h3>
<p>ä¸»çº¿ç¨‹ä¸å„ä¸ªå­çº¿ç¨‹åä½œçš„å…±äº«å˜é‡æ˜¯ä¸€ä¸ªæ•°ï¼Œè¿™ä¸ªæ•°è¡¨ç¤ºæœªå®Œæˆçš„çº¿ç¨‹ä¸ªæ•°ï¼Œåˆå§‹å€¼ä¸ºå­çº¿ç¨‹ä¸ªæ•°ï¼Œä¸»çº¿ç¨‹ç­‰å¾…è¯¥å€¼å˜ä¸º0ï¼Œè€Œæ¯ä¸ªå­çº¿ç¨‹ç»“æŸåéƒ½å°†è¯¥å€¼å‡ä¸€ï¼Œå½“å‡ä¸º0æ—¶è°ƒç”¨notifyAllï¼Œä½¿ç”¨MyLatchæ¥è¡¨ç¤ºè¿™ä¸ªåä½œå¯¹è±¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLatch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">MyLatch</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MyLatchæ„é€ æ–¹æ³•çš„å‚æ•°countåº”åˆå§‹åŒ–ä¸ºå­çº¿ç¨‹çš„ä¸ªæ•°ï¼Œä¸»çº¿ç¨‹åº”è¯¥è°ƒç”¨await()ï¼Œè€Œå­çº¿ç¨‹åœ¨æ‰§è¡Œå®Œååº”è¯¥è°ƒç”¨countDown()ã€‚</p>
<p>ä½¿ç”¨MyLatchçš„å·¥ä½œå­çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyLatch</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">MyLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// simulate working on task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="n">1000</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">workerNum</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyLatch</span><span class="o">(</span><span class="n">workerNum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Worker</span><span class="o">[]</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">[</span><span class="n">workerNum</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">workerNum</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">workers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">latch</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">workers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;collect worker results&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MyLatchæ˜¯ä¸€ä¸ªç”¨äºåŒæ­¥åä½œçš„å·¥å…·ç±»ï¼Œä¸»è¦ç”¨äºæ¼”ç¤ºåŸºæœ¬åŸç†ï¼Œåœ¨Javaä¸­æœ‰ä¸€ä¸ªä¸“é—¨çš„åŒæ­¥ç±»CountDownLatchï¼Œåœ¨å®é™…å¼€å‘ä¸­åº”è¯¥ä½¿ç”¨å®ƒã€‚</p>
<p>MyLatchçš„åŠŸèƒ½æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œå®ƒä¹Ÿå¯ä»¥åº”ç”¨äºä¸Šé¢â€œåŒæ—¶å¼€å§‹â€çš„åœºæ™¯ï¼Œåˆå§‹å€¼è®¾ä¸º1, Racerç±»è°ƒç”¨await()ï¼Œä¸»çº¿ç¨‹è°ƒç”¨countDown()å³å¯ã€‚</p>
<p>ä½¿ç”¨MyLatchå®ç°åŒæ—¶å¼€å§‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RacerWithLatchDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Racer</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyLatch</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Racer</span><span class="o">(</span><span class="n">MyLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;start run &#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyLatch</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">[]</span> <span class="n">racers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">[</span><span class="n">num</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">racers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Racer</span><span class="o">(</span><span class="n">latch</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">racers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="countdownlatch">CountDownLatch</h3>
<p>CountDownLatchç›¸å½“äºæ˜¯ä¸€ä¸ªé—¨æ “ï¼Œä¸€å¼€å§‹æ˜¯å…³é—­çš„ï¼Œæ‰€æœ‰å¸Œæœ›é€šè¿‡è¯¥é—¨çš„çº¿ç¨‹éƒ½éœ€è¦ç­‰å¾…ï¼Œç„¶åå¼€å§‹å€’è®¡æ—¶ï¼Œå€’è®¡æ—¶å˜ä¸º0åï¼Œé—¨æ “æ‰“å¼€ï¼Œç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥é€šè¿‡ï¼Œå®ƒæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæ‰“å¼€åå°±ä¸èƒ½å†å…³ä¸Šäº†ã€‚</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Anjana</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-08-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a href="https://github.com/gohugoio/hugoBasicExample" rel="noopener" target="_blank">See origin</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://anjanavakil.github.io/tags/cs/">CSğŸ’»</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/go/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Goè¯­è¨€</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/sql/">
            <span class="next-text nav-default">SQL</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:anjana.cheng@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/AnjanaVakil" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/188748525/?_i=5959211pTN39WJ,5959254pTN39WJ" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://anjanavakil.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2021 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Anjana
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
