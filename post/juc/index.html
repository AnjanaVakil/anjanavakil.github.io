<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Javaå¹¶å‘-JUC - Anjana</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Anjana" />
  <meta name="description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.93.0" />


<link rel="canonical" href="https://anjanavakil.github.io/post/juc/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css" integrity="sha256-&#43;ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Javaå¹¶å‘-JUC" />
<meta property="og:description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anjanavakil.github.io/post/juc/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-01T08:15:48+08:00" />
<meta property="article:modified_time" content="2022-08-01T08:15:48+08:00" />

<meta itemprop="name" content="Javaå¹¶å‘-JUC">
<meta itemprop="description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight"><meta itemprop="datePublished" content="2022-08-01T08:15:48+08:00" />
<meta itemprop="dateModified" content="2022-08-01T08:15:48+08:00" />
<meta itemprop="wordCount" content="13657">
<meta itemprop="keywords" content="Javaâ˜•ï¸,CSğŸ’»," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Javaå¹¶å‘-JUC"/>
<meta name="twitter:description" content="Package java.util.concurrent Description Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the java.util.concurrent.locks and java.util.concurrent.atomic packages. Executors Interfaces. Executoris a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Anjana</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Anjana
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://anjanavakil.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Javaå¹¶å‘-JUC</h1>
      
      <div class="post-meta">
        <time datetime="2022-08-01" class="post-time">
          2022-08-01
        </time>
        <div class="post-category">
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#package-javautilconcurrent-description">Package java.util.concurrent Description</a>
      <ul>
        <li><a href="#executors">Executors</a></li>
        <li><a href="#queues">Queues</a></li>
        <li><a href="#timing">Timing</a></li>
        <li><a href="#synchronizers">Synchronizers</a></li>
        <li><a href="#concurrent-collections">Concurrent Collections</a></li>
        <li><a href="#memory-consistency-properties">Memory Consistency Properties</a></li>
      </ul>
    </li>
    <li><a href="#çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a>
      <ul>
        <li><a href="#executor">Executor</a></li>
        <li><a href="#executorservice">ExecutorService</a></li>
        <li><a href="#executorserviceçš„æŠ½è±¡å®ç°ç±»abstractexecutorservice">ExecutorServiceçš„æŠ½è±¡å®ç°ç±»AbstractExecutorService</a></li>
        <li><a href="#threadpoolexecutor">ThreadPoolExecutor</a></li>
        <li><a href="#å·¥å‚ç±»executors">å·¥å‚ç±»Executors</a></li>
      </ul>
    </li>
    <li><a href="#futuretask">FutureTask</a></li>
    <li><a href="#completablefuture">CompletableFuture</a>
      <ul>
        <li><a href="#æ¡ˆä¾‹ç”µå•†ç½‘ç«™çš„æ¯”ä»·">æ¡ˆä¾‹â€”â€”ç”µå•†ç½‘ç«™çš„æ¯”ä»·</a></li>
        <li><a href="#completablefutureå¸¸ç”¨æ–¹æ³•">CompletableFutureå¸¸ç”¨æ–¹æ³•</a></li>
      </ul>
    </li>
    <li><a href="#é”">é”</a>
      <ul>
        <li><a href="#synchronized">synchronized</a></li>
        <li><a href="#lock">Lock</a></li>
        <li><a href="#synchronized-vs-lock">synchronized VS Lock</a></li>
        <li><a href="#reentrantlock">ReentrantLock</a></li>
        <li><a href="#reentrantlockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„">ReentrantLockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„</a></li>
        <li><a href="#synchronized-vs-reentrantlock">synchronized VS ReentrantLock</a></li>
        <li><a href="#æ‚²è§‚é”">æ‚²è§‚é”</a></li>
        <li><a href="#ä¹è§‚é”">ä¹è§‚é”</a></li>
        <li><a href="#å¯é‡å…¥é”åˆåé€’å½’é”">å¯é‡å…¥é”(åˆåé€’å½’é”)</a></li>
        <li><a href="#æ’æŸ¥æ­»é”">æ’æŸ¥æ­»é”</a></li>
      </ul>
    </li>
    <li><a href="#jmm">JMM</a>
      <ul>
        <li><a href="#jmmè§„èŒƒä¸‹å¤šçº¿ç¨‹å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹happens-before">JMMè§„èŒƒä¸‹ï¼Œå¤šçº¿ç¨‹å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹happens-before</a></li>
      </ul>
    </li>
    <li><a href="#å€’è®¡æ—¶é—¨æ “countdownlatch">å€’è®¡æ—¶é—¨æ “CountDownLatch</a>
      <ul>
        <li><a href="#mylatch">MyLatch</a></li>
        <li><a href="#countdownlatch">CountDownLatch</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="package-javautilconcurrent-description">Package java.util.concurrent Description</h2>
<p>Utility classes commonly useful in concurrent programming. This package includes a few small standardized extensible frameworks, as well as some classes that provide useful functionality and are otherwise tedious or difficult to implement. Here are brief descriptions of the main components. See also the <code>java.util.concurrent.locks</code> and <code>java.util.concurrent.atomic</code> packages.</p>
<h3 id="executors">Executors</h3>
<p><strong>Interfaces.</strong> <code>Executor</code>is a simple standardized interface for defining custom thread-like subsystems, including thread pools, asynchronous I/O, and lightweight task frameworks. Depending on which concrete Executor class is being used, tasks may execute in a newly created thread, an existing task-execution thread, or the thread calling <code>execute</code>, and may execute sequentially or concurrently. <code>ExecutorService</code> provides a more complete asynchronous task execution framework. An ExecutorService manages queuing and scheduling of tasks, and allows controlled shutdown. The <code>ScheduledExecutorService</code> subinterface and associated interfaces add support for delayed and periodic task execution. ExecutorServices provide methods arranging asynchronous execution of any function expressed as <code>Callable</code>, the result-bearing analog of <code>Runnable</code>. A <code>Future</code> returns the results of a function, allows determination of whether execution has completed, and provides a means to cancel execution. A <code>RunnableFuture</code> is a <code>Future</code> that possesses a <code>run</code> method that upon execution, sets its results.</p>
<p><strong>Implementations.</strong> Classes <code>ThreadPoolExecutor</code>and <code>ScheduledThreadPoolExecutor</code>provide tunable, flexible thread pools. The <code>Executors</code> class provides factory methods for the most common kinds and configurations of Executors, as well as a few utility methods for using them. Other utilities based on <code>Executors</code> include the concrete class <code>FutureTask</code> providing a common extensible implementation of Futures, and<code>ExecutorCompletionService</code>, that assists in coordinating the processing of groups of asynchronous tasks.</p>
<p>Class <code>ForkJoinPool</code> provides an Executor primarily designed for processing instances of <code>ForkJoinTask</code> and its subclasses. These classes employ a work-stealing scheduler that attains high throughput for tasks conforming to restrictions that often hold in computation-intensive parallel processing.</p>
<h3 id="queues">Queues</h3>
<p>The <code>ConcurrentLinkedQueue</code> class supplies an efficient scalable thread-safe non-blocking FIFO queue. The <code>ConcurrentLinkedDeque</code> class is similar, but additionally supports the <code>Deque</code> interface.</p>
<p>Five implementations in <code>java.util.concurrent</code> support the extended <code>BlockingQueue</code> interface, that defines blocking versions of put and take:<code>LinkedBlockingQueue</code>, <code>ArrayBlockingQueue</code>, <code>SynchronousQueue</code>, <code>PriorityBlockingQueue</code>, and <code>DelayQueue</code>. The different classes cover the most common usage contexts for producer-consumer, messaging, parallel tasking, and related concurrent designs.</p>
<p>Extended interface <code>TransferQueue</code>, and implementation <code>LinkedTransferQueue</code>introduce a synchronous <code>transfer</code> method (along with related features) in which a producer may optionally block awaiting its consumer.</p>
<p>The <code>BlockingDeque</code> interface extends <code>BlockingQueue</code> to support both FIFO and LIFO (stack-based) operations. Class <code>LinkedBlockingDeque</code> provides an implementation.</p>
<h3 id="timing">Timing</h3>
<p>The <code>TimeUnit</code> class provides multiple granularities (including nanoseconds) for specifying and controlling time-out based operations. Most classes in the package contain operations based on time-outs in addition to indefinite waits. In all cases that time-outs are used, the time-out specifies the minimum time that the method should wait before indicating that it timed-out. Implementations make a &ldquo;best effort&rdquo; to detect time-outs as soon as possible after they occur. However, an indefinite amount of time may elapse between a time-out being detected and a thread actually executing again after that time-out. All methods that accept timeout parameters treat values less than or equal to zero to mean not to wait at all. To wait &ldquo;forever&rdquo;, you can use a value of <code>Long.MAX_VALUE</code>.</p>
<h3 id="synchronizers">Synchronizers</h3>
<p>Five classes aid common special-purpose synchronization idioms.</p>
<ul>
<li><code>Semaphore</code> is a classic concurrency tool.</li>
<li><code>CountDownLatch</code> is a very simple yet very common utility for blocking until a given number of signals, events, or conditions hold.</li>
<li>A <code>CyclicBarrier</code> is a resettable multiway synchronization point useful in some styles of parallel programming.</li>
<li>A <code>Phaser</code> provides a more flexible form of barrier that may be used to control phased computation among multiple threads.</li>
<li>An <code>Exchanger</code> allows two threads to exchange objects at a rendezvous point, and is useful in several pipeline designs.</li>
</ul>
<h3 id="concurrent-collections">Concurrent Collections</h3>
<p>Besides Queues, this package supplies Collection implementations designed for use in multithreaded contexts: <code>ConcurrentHashMap</code>,<code>ConcurrentSkipListMap</code>, <code>ConcurrentSkipListSet</code>, <code>CopyOnWriteArrayList</code> and <code>CopyOnWriteArraySet</code>. When many threads are expected to access a given collection, a <code>ConcurrentHashMap</code> is normally preferable to a synchronized <code>HashMap</code>, and a <code>ConcurrentSkipListMap</code> is normally preferable to a synchronized <code>TreeMap</code>. A <code>CopyOnWriteArrayList</code> is preferable to a synchronized <code>ArrayList</code> when the expected number of reads and traversals greatly outnumber the number of updates to a list.</p>
<p>The &ldquo;Concurrent&rdquo; prefix used with some classes in this package is a shorthand indicating several differences from similar &ldquo;synchronized&rdquo; classes. For example <code>java.util.Hashtable</code> and <code>Collections.synchronizedMap(new HashMap())</code> are synchronized. But <code>ConcurrentHashMap</code>is &ldquo;concurrent&rdquo;. A concurrent collection is thread-safe, but not governed by a single exclusion lock. In the particular case of ConcurrentHashMap, it safely permits any number of concurrent reads as well as a tunable number of concurrent writes. &ldquo;Synchronized&rdquo; classes can be useful when you need to prevent all access to a collection via a single lock, at the expense of poorer scalability. In other cases in which multiple threads are expected to access a common collection, &ldquo;concurrent&rdquo; versions are normally preferable. And unsynchronized collections are preferable when either collections are unshared, or are accessible only when holding other locks.</p>
<p>Most concurrent Collection implementations (including most Queues) also differ from the usual <code>java.util</code> conventions in that their Iterators and Spliterators provide <em>weakly consistent</em> rather than fast-fail traversal:</p>
<ul>
<li>they may proceed concurrently with other operations</li>
<li>they will never throw <code>ConcurrentModificationException</code></li>
<li>they are guaranteed to traverse elements as they existed upon construction exactly once, and may (but are not guaranteed to) reflect any modifications subsequent to construction.</li>
</ul>
<h3 id="memory-consistency-properties">Memory Consistency Properties</h3>
<p><a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html#jls-17.4.5">Chapter 17 of the Java Language Specification</a> defines the <em>happens-before</em> relation on memory operations such as reads and writes of shared variables. The results of a write by one thread are guaranteed to be visible to a read by another thread only if the write operation <em>happens-before</em> the read operation. The <code>synchronized</code> and <code>volatile</code> constructs, as well as the <code>Thread.start()</code> and <code>Thread.join()</code> methods, can form <em>happens-before</em>relationships. In particular:</p>
<ul>
<li>Each action in a thread <em>happens-before</em> every action in that thread that comes later in the program&rsquo;s order.</li>
<li>An unlock (<code>synchronized</code> block or method exit) of a monitor <em>happens-before</em> every subsequent lock (<code>synchronized</code> block or method entry) of that same monitor. And because the <em>happens-before</em> relation is transitive, all actions of a thread prior to unlocking <em>happen-before</em> all actions subsequent to any thread locking that monitor.</li>
<li>A write to a <code>volatile</code> field <em>happens-before</em> every subsequent read of that same field. Writes and reads of <code>volatile</code> fields have similar memory consistency effects as entering and exiting monitors, but do <em>not</em> entail mutual exclusion locking.</li>
<li>A call to <code>start</code> on a thread <em>happens-before</em> any action in the started thread.</li>
<li>All actions in a thread <em>happen-before</em> any other thread successfully returns from a <code>join</code> on that thread.</li>
</ul>
<p>The methods of all classes in <code>java.util.concurrent</code> and its subpackages extend these guarantees to higher-level synchronization. In particular:</p>
<ul>
<li>
<p>Actions in a thread prior to placing an object into any concurrent collection <em>happen-before</em> actions subsequent to the access or removal of that element from the collection in another thread.</p>
</li>
<li>
<p>Actions in a thread prior to the submission of a <code>Runnable</code> to an <code>Executor</code> <em>happen-before</em> its execution begins. Similarly for <code>Callables</code> submitted to an <code>ExecutorService</code>.</p>
</li>
<li>
<p>Actions taken by the asynchronous computation represented by a <code>Future</code> <em>happen-before</em> actions subsequent to the retrieval of the result via <code>Future.get()</code> in another thread.</p>
</li>
<li>
<p>Actions prior to &ldquo;releasing&rdquo; synchronizer methods such as <code>Lock.unlock</code>, <code>Semaphore.release</code>, and <code>CountDownLatch.countDown</code> <em>happen-before</em>actions subsequent to a successful &ldquo;acquiring&rdquo; method such as <code>Lock.lock</code>, <code>Semaphore.acquire</code>, <code>Condition.await</code>, and <code>CountDownLatch.await</code>on the same synchronizer object in another thread.</p>
</li>
<li>
<p>For each pair of threads that successfully exchange objects via an <code>Exchanger</code>, actions prior to the <code>exchange()</code> in each thread <em>happen-before</em> those subsequent to the corresponding <code>exchange()</code> in another thread.</p>
</li>
<li>
<p>Actions prior to calling <code>CyclicBarrier.await</code> and <code>Phaser.awaitAdvance</code> (as well as its variants) <em>happen-before</em> actions performed by the barrier action, and actions performed by the barrier action <em>happen-before</em> actions subsequent to a successful return from the corresponding <code>await</code> in other threads.</p>
</li>
<li>
<p><strong>Since:</strong></p>
<p>1.5</p>
</li>
</ul>
<h2 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h2>
<h3 id="executor">Executor</h3>
<p>Executorè¡¨ç¤ºæœ€ç®€å•çš„æ‰§è¡ŒæœåŠ¡ï¼Œå…¶å®šä¹‰ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Executes the given command at some time in the future.  The command
</span></span></span><span class="line"><span class="cl"><span class="cm">     * may execute in a new thread, in a pooled thread, or in the calling
</span></span></span><span class="line"><span class="cl"><span class="cm">     * thread, at the discretion of the {@code Executor} implementation.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param command the runnable task
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws RejectedExecutionException if this task cannot be
</span></span></span><span class="line"><span class="cl"><span class="cm">     * accepted for execution
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws NullPointerException if command is null
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//commandå¯èƒ½åœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸€ä¸ªçº¿ç¨‹æ± é‡Œï¼Œæˆ–è€…ä¸€ä¸ªè°ƒç”¨çº¿ç¨‹ï¼Œå–å†³äºExecutoræ¥å£çš„å®ç°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executor:</p>
<p>An object that executes submitted <code>Runnable</code> tasks. This interface provides a way of decoupling task submission from the mechanics of how each task will be run, including details of thread use, scheduling, etc. An <code>Executor</code> is normally used instead of explicitly creating threads. For example, rather than invoking <code>new Thread(new(RunnableTask())).start()</code> for each of a set of tasks, you might use:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">anExecutor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableTask1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"> <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">RunnableTask2</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"> <span class="o">...</span>
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, the <code>Executor</code> interface does not strictly require that execution be asynchronous. In the simplest case, an executor can run the submitted task immediately in the caller&rsquo;s thread:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">class</span> <span class="nc">DirectExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>More typically, tasks are executed in some thread other than the caller&rsquo;s thread. The executor below spawns a new thread for each task.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">class</span> <span class="nc">ThreadPerTaskExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Many <code>Executor</code> implementations impose some sort of limitation on how and when tasks are scheduled. The executor below serializes the submission of tasks to a second executor, illustrating a composite executor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> class SerialExecutor implements Executor {
</span></span><span class="line"><span class="cl">   final Queue&lt;Runnable&gt; tasks = new ArrayDeque&lt;Runnable&gt;();
</span></span><span class="line"><span class="cl">   final Executor executor;
</span></span><span class="line"><span class="cl">   Runnable active;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   SerialExecutor(Executor executor) {
</span></span><span class="line"><span class="cl">     this.executor = executor;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public synchronized void execute(final Runnable r) {
</span></span><span class="line"><span class="cl">     tasks.offer(new Runnable() {
</span></span><span class="line"><span class="cl">       public void run() {
</span></span><span class="line"><span class="cl">         try {
</span></span><span class="line"><span class="cl">           r.run();
</span></span><span class="line"><span class="cl">         } finally {
</span></span><span class="line"><span class="cl">           scheduleNext();
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl">       }
</span></span><span class="line"><span class="cl">     });
</span></span><span class="line"><span class="cl">     if (active == null) {
</span></span><span class="line"><span class="cl">       scheduleNext();
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   protected synchronized void scheduleNext() {
</span></span><span class="line"><span class="cl">     if ((active = tasks.poll()) != null) {
</span></span><span class="line"><span class="cl">       executor.execute(active);
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Executor</code> implementations provided in this package implement <code>ExecutorService</code>, which is a more extensive interface. The <code>ThreadPoolExecutor</code> class provides an extensible thread pool implementation. The <code>Executors</code> class provides convenient factory methods for these Executors.</p>
<p>Memory consistency effects: Actions in a thread prior to submitting a <code>Runnable</code> object to an <code>Executor</code> <em>happen-before</em> its execution begins, perhaps in another thread.</p>
<p><code>void execute(Runnable command);</code>å¯ä»¥æ‰§è¡Œä¸€ä¸ªRunnableï¼Œæ²¡æœ‰è¿”å›ç»“æœã€‚æ¥å£æ²¡æœ‰é™å®šä»»åŠ¡å¦‚ä½•æ‰§è¡Œï¼Œå¯èƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯å¤ç”¨çº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯åœ¨è°ƒç”¨è€…çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p>
<h3 id="executorservice">ExecutorService</h3>
<p>ExecutorServiceæ‰©å±•äº†Executorï¼Œå®šä¹‰äº†æ›´å¤šæœåŠ¡ï¼ŒåŸºæœ¬æ–¹æ³•æœ‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public interface ExecutorService extends Executor {
</span></span><span class="line"><span class="cl">  &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);
</span></span><span class="line"><span class="cl">  &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);
</span></span><span class="line"><span class="cl">  Future&lt;?&gt; submit(Runnable task);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸‰ä¸ªsubmitéƒ½è¡¨ç¤ºæäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œè¿”å›å€¼ç±»å‹éƒ½æ˜¯Futureï¼Œè¿”å›åï¼Œåªæ˜¯è¡¨ç¤ºä»»åŠ¡å·²æäº¤ï¼Œä¸ä»£è¡¨å·²æ‰§è¡Œï¼Œé€šè¿‡Futureå¯ä»¥æŸ¥è¯¢å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€ã€è·å–æœ€ç»ˆç»“æœã€å–æ¶ˆä»»åŠ¡ç­‰ã€‚å¯¹äºCallableï¼Œä»»åŠ¡æœ€ç»ˆæœ‰ä¸ªè¿”å›å€¼ï¼Œè€Œå¯¹äºRunnableæ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼›ç¬¬äºŒä¸ªæäº¤Runnableçš„æ–¹æ³•å¯ä»¥åŒæ—¶æä¾›ä¸€ä¸ªç»“æœï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶è¿”å›ï¼›ç¬¬ä¸‰ä¸ªæ–¹æ³•å¼‚æ­¥ä»»åŠ¡çš„æœ€ç»ˆè¿”å›å€¼ä¸ºnullã€‚</p>
<p><code>&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</code></p>
<p>Submits a value-returning task for execution and returns a Future representing the pending results of the task. The Future&rsquo;s <code>get</code> method will return the task&rsquo;s result upon successful completion.</p>
<p>If you would like to immediately block waiting for a task, you can use constructions of the form <code>result = exec.submit(aCallable).get();</code></p>
<p>Note: The <code>Executors</code>class includes a set of methods that can convert some other common closure-like objects, for example, <code>PrivilegedAction</code>to <code>Callable</code> form so they can be submitted.</p>
<p><code>&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</code></p>
<p>Submits a Runnable task for execution and returns a Future representing that task. The Future&rsquo;s <code>get</code> method will return the given result upon successful completion.</p>
<p><code>Future&lt;?&gt; submit(Runnable task);</code></p>
<p>Submits a Runnable task for execution and returns a Future representing that task. The Future&rsquo;s <code>get</code> method will return <code>null</code> upon <em>successful</em> completion.</p>
<p>æœ‰ä¸¤ä¸ªå…³é—­æ–¹æ³•ï¼šshutdownå’ŒshutdownNowã€‚åŒºåˆ«æ˜¯ï¼Œshutdownè¡¨ç¤ºä¸å†æ¥å—æ–°ä»»åŠ¡ï¼Œä½†å·²æäº¤çš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œï¼Œå³ä½¿ä»»åŠ¡è¿˜æœªå¼€å§‹æ‰§è¡Œï¼›shutdownNowä¸ä»…ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œè€Œä¸”ä¼šç»ˆæ­¢å·²æäº¤ä½†å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯¹äºæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸€èˆ¬ä¼šè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•å°è¯•ä¸­æ–­ï¼Œä¸è¿‡ï¼Œçº¿ç¨‹å¯èƒ½ä¸å“åº”ä¸­æ–­ï¼ŒshutdownNowä¼šè¿”å›å·²æäº¤ä½†å°šæœªæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚</p>
<p><code>void shutdown();</code>æ³¨é‡Šï¼š</p>
<p>Initiates an orderly shutdown in which previously submitted tasks are executed, but no new tasks will be accepted. Invocation has no additional effect if already shut down.</p>
<p>This method does not wait for previously submitted tasks to complete execution. Use <code>awaitTermination</code> to do that.</p>
<p><code>List&lt;Runnable&gt; shutdownNow();</code>æ³¨é‡Šï¼š</p>
<p>Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and returns a list of the tasks that were awaiting execution.</p>
<p>This method does not wait for actively executing tasks to terminate. Use <code>awaitTermination</code>to do that.</p>
<p>There are no guarantees beyond best-effort attempts to stop processing actively executing tasks. For example, typical implementations will cancel via <code>Thread.interrupt()</code>, so any task that fails to respond to interrupts may never terminate.</p>
<p><strong>Returns:</strong></p>
<p>list of tasks that never commenced execution</p>
<p>shutdownå’ŒshutdownNowä¸ä¼šé˜»å¡ç­‰å¾…ï¼Œå®ƒä»¬è¿”å›åä¸ä»£è¡¨æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»“æŸï¼Œä¸è¿‡isShutdownæ–¹æ³•ä¼šè¿”å›trueã€‚è°ƒç”¨è€…å¯ä»¥é€šè¿‡awaitTerminationç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸï¼Œå®ƒå¯ä»¥é™å®šç­‰å¾…çš„æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶å‰æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œå³isTerminatedæ–¹æ³•è¿”å›trueï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>ExecutorServiceæœ‰ä¸¤ç»„æ‰¹é‡æäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼šinvokeAllå’ŒinvokeAnyï¼Œå®ƒä»¬éƒ½æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªé™å®šç­‰å¾…æ—¶é—´ã€‚</p>
<p>invokeAllç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œè¿”å›çš„Futureåˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªFutureçš„isDoneæ–¹æ³•éƒ½è¿”å›trueï¼Œä¸è¿‡isDoneä¸ºtrueä¸ä»£è¡¨ä»»åŠ¡å°±æ‰§è¡ŒæˆåŠŸäº†ï¼Œå¯èƒ½æ˜¯è¢«å–æ¶ˆäº†ã€‚invokeAllå¯ä»¥æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶åæœ‰çš„ä»»åŠ¡æ²¡å®Œæˆï¼Œå°±ä¼šè¢«å–æ¶ˆã€‚</p>
<p>è€Œå¯¹äºinvokeAnyï¼Œåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨é™æ—¶å†…æˆåŠŸè¿”å›äº†ï¼Œå®ƒå°±ä¼šè¿”å›è¯¥ä»»åŠ¡çš„ç»“æœï¼Œå…¶ä»–ä»»åŠ¡ä¼šè¢«å–æ¶ˆï¼›å¦‚æœæ²¡æœ‰ä»»åŠ¡èƒ½åœ¨é™æ—¶å†…æˆåŠŸè¿”å›ï¼ŒæŠ›å‡ºTimeoutExceptionï¼›å¦‚æœé™æ—¶å†…æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œä½†éƒ½å‘ç”Ÿäº†å¼‚å¸¸ï¼ŒæŠ›å‡ºExecutionExceptionã€‚</p>
<h3 id="executorserviceçš„æŠ½è±¡å®ç°ç±»abstractexecutorservice">ExecutorServiceçš„æŠ½è±¡å®ç°ç±»AbstractExecutorService</h3>
<h3 id="threadpoolexecutor">ThreadPoolExecutor</h3>
<p>çº¿ç¨‹æ± ä¸»è¦ç”±ä¸¤ä¸ªæ¦‚å¿µç»„æˆï¼šä¸€ä¸ªæ˜¯å·¥ä½œè€…çº¿ç¨‹ï¼›å¦ä¸€ä¸ªæ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚å·¥ä½œè€…çº¿ç¨‹ä¸»ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯ä»é˜Ÿåˆ—ä¸­æ¥å—ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä»»åŠ¡é˜Ÿåˆ—ä¿å­˜å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
<p>Javaå¹¶å‘åŒ…ä¸­çº¿ç¨‹æ± çš„å®ç°ç±»æ˜¯ThreadPoolExecutorï¼Œå®ƒç»§æ‰¿è‡ªAbstractExecutorServiceï¼Œå®ç°äº†ExecutorServiceã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">defaultHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Creates</span> <span class="n">a</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span> <span class="n">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">initial</span> <span class="n">parameters</span> <span class="n">and</span> <span class="k">default</span> <span class="n">thread</span> <span class="n">factory</span> <span class="n">and</span> <span class="n">rejected</span> <span class="n">execution</span> <span class="n">handler</span><span class="o">.</span> <span class="n">It</span> <span class="n">may</span> <span class="n">be</span> <span class="n">more</span> <span class="n">convenient</span> <span class="n">to</span> <span class="n">use</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Executors</span> <span class="n">factory</span> <span class="n">methods</span> <span class="n">instead</span> <span class="n">of</span> <span class="k">this</span> <span class="n">general</span> <span class="n">purpose</span> <span class="n">constructor</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">threadFactory</span><span class="o">,</span> <span class="n">defaultHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Creates</span> <span class="n">a</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span> <span class="n">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">initial</span> <span class="n">parameters</span> <span class="n">and</span> <span class="k">default</span> <span class="n">rejected</span> <span class="n">execution</span> <span class="n">handler</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">handler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Creates</span> <span class="n">a</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span> <span class="n">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">initial</span> <span class="n">parameters</span> <span class="n">and</span> <span class="k">default</span> <span class="n">thread</span> <span class="n">factory</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">    <span class="kc">null</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Creates</span> <span class="n">a</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span> <span class="n">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">initial</span> <span class="n">parameters</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>corePoolSize</code> - the number of threads to keep in the pool, even if they are idle, unless <code>allowCoreThreadTimeOut</code> is set</p>
<p><code>maximumPoolSize</code> - the maximum number of threads to allow in the pool</p>
<p><code>keepAliveTime</code> - when the number of threads is greater than the core, this is the maximum time that excess idle threads will wait for new tasks before terminating.</p>
<p><code>unit</code> - the time unit for the <code>keepAliveTime</code> argument</p>
<p><code>workQueue</code> - the queue to use for holding tasks before they are executed. This queue will hold only the <code>Runnable</code> tasks submitted by the <code>execute</code> method.</p>
<p><code>threadFactory</code> - the factory to use when the executor creates a new thread</p>
<p><code>handler</code> - the handler to use when execution is blocked because the thread bounds and queue capacities are reached</p>
<p><strong>ä»»åŠ¡æ‹’ç»ç­–ç•¥</strong></p>
<p>å¦‚æœé˜Ÿåˆ—æœ‰ç•Œï¼Œä¸”maximumPoolSizeæœ‰é™ï¼Œåˆ™å½“é˜Ÿåˆ—æ’æ»¡ï¼Œçº¿ç¨‹ä¸ªæ•°ä¹Ÿè¾¾åˆ°äº†maxi-mumPoolSizeï¼Œè¿™æ—¶ï¼Œæ–°ä»»åŠ¡æ¥äº†ï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿæ­¤æ—¶ï¼Œä¼šè§¦å‘çº¿ç¨‹æ± çš„ä»»åŠ¡æ‹’ç»ç­–ç•¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The default rejected execution handler
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">RejectedExecutionHandler</span> <span class="n">defaultHandler</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">AbortPolicy</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼ˆå¦‚execute/submit/invokeAllç­‰ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç±»å‹ä¸ºRejectedExecutionExceptionã€‚</p>
<p>ä¸è¿‡ï¼Œæ‹’ç»ç­–ç•¥æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼ŒThreadPoolExecutorå®ç°äº†4ç§å¤„ç†æ–¹å¼ã€‚</p>
<p>1ï¼‰ThreadPoolExecutor.AbortPolicyï¼šè¿™å°±æ˜¯é»˜è®¤çš„æ–¹å¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that throws a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * {@code RejectedExecutionException}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbortPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates an {@code AbortPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AbortPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Always throws RejectedExecutionException.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws RejectedExecutionException always
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RejectedExecutionException</span><span class="o">(</span><span class="s">&#34;Task &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                             <span class="s">&#34; rejected from &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ï¼‰ThreadPoolExecutor.DiscardPolicyï¼šé™é»˜å¤„ç†ï¼Œå¿½ç•¥æ–°ä»»åŠ¡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿä¸æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that silently discards the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * rejected task.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code DiscardPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DiscardPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Does nothing, which has the effect of discarding task r.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ï¼‰ThreadPoolExecutor.DiscardOldestPolicyï¼šå°†ç­‰å¾…æ—¶é—´æœ€é•¿çš„ä»»åŠ¡æ‰”æ‰ï¼Œç„¶åè‡ªå·±æ’é˜Ÿã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that discards the oldest unhandled
</span></span></span><span class="line"><span class="cl"><span class="cm"> * request and then retries {@code execute}, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is shut down, in which case the task is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardOldestPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code DiscardOldestPolicy} for the given executor.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DiscardOldestPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Obtains and ignores the next task that the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * would otherwise execute, if one is immediately available,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and then retries execution of task r, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is shut down, in which case task r is instead discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">getQueue</span><span class="o">().</span><span class="na">poll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4ï¼‰ThreadPoolExecutor.CallerRunsPolicyï¼šåœ¨ä»»åŠ¡æäº¤è€…çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯äº¤ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A handler for rejected tasks that runs the rejected task
</span></span></span><span class="line"><span class="cl"><span class="cm"> * directly in the calling thread of the {@code execute} method,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * unless the executor has been shut down, in which case the task
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallerRunsPolicy</span> <span class="kd">implements</span> <span class="n">RejectedExecutionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a {@code CallerRunsPolicy}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CallerRunsPolicy</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Executes task r in the caller&#39;s thread, unless the executor
</span></span></span><span class="line"><span class="cl"><span class="cm">     * has been shut down, in which case the task is discarded.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param r the runnable task requested to be executed
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param e the executor attempting to execute this task
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä»¬éƒ½æ˜¯ThreadPoolExecutorçš„<code>publicé™æ€å†…éƒ¨ç±»</code>ï¼Œéƒ½å®ç°äº†RejectedExecutionHandleræ¥å£ã€‚</p>
<p>æ‹’ç»ç­–ç•¥åªæœ‰åœ¨é˜Ÿåˆ—æœ‰ç•Œï¼Œä¸”maximumPoolSizeæœ‰é™çš„æƒ…å†µä¸‹æ‰ä¼šè§¦å‘ã€‚å¦‚æœé˜Ÿåˆ—æ— ç•Œï¼ŒæœåŠ¡ä¸äº†çš„ä»»åŠ¡æ€»æ˜¯ä¼šæ’é˜Ÿï¼Œä½†è¿™ä¸ä¸€å®šæ˜¯æœŸæœ›çš„ç»“æœï¼Œå› ä¸ºè¯·æ±‚å¤„ç†é˜Ÿåˆ—å¯èƒ½ä¼šæ¶ˆè€—éå¸¸å¤§çš„å†…å­˜ï¼Œç”šè‡³å¼•å‘å†…å­˜ä¸å¤Ÿçš„å¼‚å¸¸ã€‚å¦‚æœé˜Ÿåˆ—æœ‰ç•Œä½†maxi-mumPoolSizeæ— é™ï¼Œå¯èƒ½ä¼šåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œå æ»¡CPUå’Œå†…å­˜ï¼Œä½¿å¾—ä»»ä½•ä»»åŠ¡éƒ½éš¾ä»¥å®Œæˆã€‚æ‰€ä»¥ï¼Œåœ¨ä»»åŠ¡é‡éå¸¸å¤§çš„åœºæ™¯ä¸­ï¼Œè®©æ‹’ç»ç­–ç•¥æœ‰æœºä¼šæ‰§è¡Œæ˜¯ä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œå¾ˆé‡è¦çš„æ–¹é¢ã€‚</p>
<p><strong>æ ¸å¿ƒçº¿ç¨‹</strong></p>
<p>çº¿ç¨‹ä¸ªæ•°å°äºç­‰äºcorePoolSizeæ—¶ï¼Œæˆ‘ä»¬ç§°è¿™äº›çº¿ç¨‹ä¸ºæ ¸å¿ƒçº¿ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ã€‚</p>
<ul>
<li>
<p>æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé¢„å…ˆåˆ›å»ºï¼Œåªæœ‰å½“æœ‰ä»»åŠ¡æ—¶æ‰ä¼šåˆ›å»ºã€‚</p>
</li>
<li>
<p>æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šå› ä¸ºç©ºé—²è€Œè¢«ç»ˆæ­¢ï¼ŒkeepAliveTimeå‚æ•°ä¸é€‚ç”¨äºå®ƒã€‚</p>
</li>
</ul>
<h3 id="å·¥å‚ç±»executors">å·¥å‚ç±»Executors</h3>
<p>ç±»Executorsæä¾›äº†ä¸€äº›é™æ€å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºä¸€äº›é¢„é…ç½®çš„çº¿ç¨‹æ± ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded queue. At any point, at most <code>nThreads</code> threads will be active processing tasks. If additional tasks are submitted when all threads are active, they will wait in the queue until a thread is available. If any thread terminates due to a failure during execution prior to shutdown, a new one will take its place if needed to execute subsequent tasks. The threads in the pool will exist until it is explicitly <code>shutdown</code>.</p>
<p>ä½¿ç”¨å›ºå®šæ•°ç›®çš„nä¸ªçº¿ç¨‹ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œçº¿ç¨‹åˆ›å»ºåä¸ä¼šè¶…æ—¶ç»ˆæ­¢ã€‚å’ŒnewSingleThreadExecutorä¸€æ ·ï¼Œç”±äºæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¦‚æœæ’é˜Ÿä»»åŠ¡è¿‡å¤šï¼Œå¯èƒ½ä¼šæ¶ˆè€—è¿‡å¤šçš„å†…å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FinalizableDelegatedExecutorService</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates an Executor that uses <code>a single worker thread</code> operating off an <code>unbounded queue</code>. (Note however that if this single thread terminates due to a failure during execution prior to shutdown, a new one will take its place if needed to execute subsequent tasks.) Tasks are guaranteed to execute sequentially, and no more than one task will be active at any given time. Unlike the otherwise equivalent <code>newFixedThreadPool(1)</code> the returned executor is guaranteed not to be reconfigurable to use additional threads.</p>
<p>åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œçº¿ç¨‹åˆ›å»ºåä¸ä¼šè¶…æ—¶ç»ˆæ­¢ï¼Œè¯¥çº¿ç¨‹é¡ºåºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚è¯¥çº¿ç¨‹æ± é€‚ç”¨äºéœ€è¦ç¡®ä¿æ‰€æœ‰ä»»åŠ¡è¢«é¡ºåºæ‰§è¡Œçš„åœºåˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">60L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creates a thread pool that creates new threads as needed, but will reuse previously constructed threads when they are available. These pools will typically improve the performance of programs that execute many short-lived asynchronous tasks. Calls to <code>execute</code> will reuse previously constructed threads if available. If no existing thread is available, a new thread will be created and added to the pool. Threads that have not been used for sixty seconds are terminated and removed from the cache. Thus, a pool that remains idle for long enough will not consume any resources. Note that pools with similar properties but different details (for example, timeout parameters) may be created using <code>ThreadPoolExecutor</code> constructors.</p>
<p>å®ƒçš„corePoolSizeä¸º0, maximumPoolSizeä¸ºInteger.MAâ…©_VALUE, keepAliveTimeæ˜¯60ç§’ï¼Œé˜Ÿåˆ—ä¸ºSynchronousQueueã€‚å®ƒçš„å«ä¹‰æ˜¯ï¼šå½“æ–°ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œå¦‚æœæ­£å¥½æœ‰ç©ºé—²çº¿ç¨‹åœ¨ç­‰å¾…ä»»åŠ¡ï¼Œåˆ™å…¶ä¸­ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ¥å—è¯¥ä»»åŠ¡ï¼Œå¦åˆ™å°±æ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåˆ›å»ºçš„æ€»çº¿ç¨‹ä¸ªæ•°ä¸å—é™åˆ¶ï¼Œå¯¹ä»»ä¸€ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœ60ç§’å†…æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œå°±ç»ˆæ­¢ã€‚</p>
<h2 id="futuretask">FutureTask</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RunnableFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Sets this Future to the result of its computation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * unless it has been cancelled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="completablefuture">CompletableFuture</h2>
<p>ä»Java8å¼€å§‹å¼•å…¥äº†CompletableFutureï¼Œå®ƒæ˜¯Futureçš„åŠŸèƒ½å¢å¼ºç‰ˆï¼Œå¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo3</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;-----come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">6</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">10</span> <span class="o">/</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----result: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----exception: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="n">44</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:æš‚åœ3ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>whenComplete:</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;&ndash;come in</p>
<p>&mdash;&ndash;è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š 4</p>
<p>&mdash;&ndash;result: 4</p>
</blockquote>
<p>exceptionally:</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;&ndash;come in</p>
<p>&mdash;&ndash;è®¡ç®—ç»“æŸè€—æ—¶1ç§’é’Ÿï¼Œresultï¼š 9</p>
<p>&mdash;&ndash;exception: java.lang.ArithmeticException: / by zero	java.lang.ArithmeticException: / by zero</p>
</blockquote>
<p><strong>CompletableFutureçš„ä¼˜ç‚¹ï¼š</strong></p>
<p>å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›</p>
<p>å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›</p>
<p>ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¼‚æ­¥ä»»åŠ¡ä¹‹é—´å¯ä»¥é¡ºåºæ‰§è¡Œã€‚</p>
<h3 id="æ¡ˆä¾‹ç”µå•†ç½‘ç«™çš„æ¯”ä»·">æ¡ˆä¾‹â€”â€”ç”µå•†ç½‘ç«™çš„æ¯”ä»·</h3>
<p>åˆ‡è®°ï¼ŒåŠŸèƒ½â†’æ€§èƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;jd&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;tmall&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;pdd&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">NetMall</span><span class="o">(</span><span class="s">&#34;mi&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPriceSync</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">mall</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">productName</span> <span class="o">+</span> <span class="s">&#34; %s price is %.2f&#34;</span><span class="o">,</span> <span class="n">mall</span><span class="o">.</span><span class="na">getNetMallName</span><span class="o">(),</span> <span class="n">mall</span><span class="o">.</span><span class="na">getPriceByName</span><span class="o">(</span><span class="n">productName</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPriceASync</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NetMall</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">mall</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">productName</span> <span class="o">+</span> <span class="s">&#34; %s price is %.2f&#34;</span><span class="o">,</span> <span class="n">mall</span><span class="o">.</span><span class="na">getNetMallName</span><span class="o">(),</span> <span class="n">mall</span><span class="o">.</span><span class="na">getPriceByName</span><span class="o">(</span><span class="n">productName</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">findPriceSync</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="s">&#34;thinking in java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span> <span class="o">:</span> <span class="n">list1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">findPriceASync</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="s">&#34;thinking in java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span> <span class="o">:</span> <span class="n">list2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----costTime: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">endTime2</span> <span class="o">-</span> <span class="n">startTime2</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; æ¯«ç§’&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">NetMall</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNetMallName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">NetMall</span><span class="o">(</span><span class="n">String</span> <span class="n">netMallName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">netMallName</span> <span class="o">=</span> <span class="n">netMallName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getPriceByName</span><span class="o">(</span><span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">calcPrice</span><span class="o">(</span><span class="n">productName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">calcPrice</span><span class="o">(</span><span class="n">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">()</span> <span class="o">+</span> <span class="n">productName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>thinking in java jd price is 116.41</p>
<p>thinking in java tmall price is 116.65</p>
<p>thinking in java pdd price is 116.76</p>
<p>thinking in java mi price is 116.53</p>
<p>&mdash;-costTime: 4082 æ¯«ç§’</p>
<p>thinking in java jd price is 116.42</p>
<p>thinking in java tmall price is 116.28</p>
<p>thinking in java pdd price is 116.06</p>
<p>thinking in java mi price is 116.68
&mdash;-costTime: 1008 æ¯«ç§’</p>
</blockquote>
<h3 id="completablefutureå¸¸ç”¨æ–¹æ³•">CompletableFutureå¸¸ç”¨æ–¹æ³•</h3>
<h4 id="è·å¾—ç»“æœå’Œè§¦å‘è®¡ç®—">è·å¾—ç»“æœå’Œè§¦å‘è®¡ç®—</h4>
<p>è·å¾—ç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">reportGet</span><span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">waitingGet</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">:</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Waits</span> <span class="k">if</span> <span class="n">necessary</span> <span class="k">for</span> <span class="k">this</span> <span class="n">future</span> <span class="n">to</span> <span class="n">complete</span><span class="o">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">returns</span> <span class="n">its</span> <span class="n">result</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">reportGet</span><span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">timedGet</span><span class="o">(</span><span class="n">nanos</span><span class="o">)</span> <span class="o">:</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Waits</span> <span class="k">if</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">at</span> <span class="n">most</span> <span class="n">the</span> <span class="n">given</span> <span class="n">time</span> <span class="k">for</span> <span class="k">this</span> <span class="n">future</span> <span class="n">to</span> <span class="n">complete</span><span class="o">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">returns</span> <span class="n">its</span> <span class="n">result</span><span class="o">,</span> <span class="k">if</span> <span class="n">available</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">533</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//å»æ‰ç­‰å¾…æ—¶é—´ä¸Šé¢è®¡ç®—æ²¡æœ‰å®Œæˆï¼Œè¿”å›valueIfAbsentï¼š444
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//å¼€å¯ç­‰å¾…æ—¶é—´ä¸Šé¢è®¡ç®—å®Œæˆï¼Œè¿”å›è®¡ç®—ç»“æœ533
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">completableFuture</span><span class="o">.</span><span class="na">getNow</span><span class="o">(</span><span class="n">444</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»åŠ¨è§¦å‘è®¡ç®—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">complete</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">triggered</span> <span class="o">=</span> <span class="n">completeValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">postComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">triggered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">If</span> <span class="n">not</span> <span class="n">already</span> <span class="n">completed</span><span class="o">,</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">value</span> <span class="n">returned</span> <span class="n">by</span> <span class="nf">get</span><span class="o">()</span> <span class="n">and</span> <span class="n">related</span> <span class="n">methods</span> <span class="n">to</span> <span class="n">the</span> <span class="n">given</span> <span class="n">value</span><span class="o">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">533</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æ³¨é‡Šæ‰æš‚åœæ—¶é—´ï¼Œgetè¿˜æ²¡æœ‰ç®—å®Œåªèƒ½è¿”å›completeæ–¹æ³•è®¾ç½®çš„444ï¼›æš‚åœ2ç§’é’Ÿï¼Œå¼‚æ­¥çº¿ç¨‹èƒ½å¤Ÿè®¡ç®—å®Œæˆè¿”å›get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“è°ƒç”¨CompletableFuture.get()è¢«é˜»å¡çš„æ—¶å€™,completeæ–¹æ³•å°±æ˜¯ç»“æŸé˜»å¡å¹¶get()è·å–è®¾ç½®çš„completeé‡Œé¢çš„å€¼.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">completableFuture</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">444</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">completableFuture</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æš‚åœ2ç§’é’Ÿï¼Œå¼‚æ­¥çº¿ç¨‹èƒ½å¤Ÿè®¡ç®—å®Œæˆè¿”å›getï¼š</p>
<blockquote>
<p>false	533</p>
</blockquote>
<p>æ³¨é‡Šæ‰æš‚åœæ—¶é—´ï¼Œgetè¿˜æ²¡æœ‰ç®—å®Œåªèƒ½è¿”å›completeæ–¹æ³•è®¾ç½®çš„444ï¼š</p>
<blockquote>
<p>true	444</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†">å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†</h4>
<h5 id="thenapply">thenApply</h5>
<p>å­˜åœ¨ä¾èµ–å…³ç³»(å½“å‰æ­¥é”™ï¼Œä¸èµ°ä¸‹ä¸€æ­¥)ï¼Œå½“å‰æ­¥éª¤æœ‰å¼‚å¸¸çš„è¯å°±å«åœã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// è®¡ç®—ç»“æœå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo4</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ç”¨ thenApply æ–¹æ³•æ¥æŠŠè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//int age = 10/0; // å¼‚å¸¸æƒ…å†µï¼šå“ªæ­¥å‡ºé”™å°±åœåœ¨å“ªæ­¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenCompleteAsync</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*****v: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æ— å¼‚å¸¸æƒ…å†µï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>222</p>
<p>333</p>
<p>*****v: 1026</p>
</blockquote>
<p>æœ‰å¼‚å¸¸æƒ…å†µï¼ˆint age = 10/0;ï¼‰ï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>222</p>
<p>*****v: null</p>
<p>java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero
at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:618)
at java.util.concurrent.CompletableFuture$UniApply.tryFire(CompletableFuture.java:591)
at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:488)
at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1609)
at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)
Caused by: java.lang.ArithmeticException: / by zero
at shuo.laoma.concurrent.test.CompletableFutureDemo4.lambda$main$2(CompletableFutureDemo4.java:25)
at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:616)
&hellip; 8 more</p>
</blockquote>
<h5 id="handle">handle</h5>
<p>æœ‰å¼‚å¸¸ä¹Ÿå¯ä»¥å¾€ä¸‹ä¸€æ­¥èµ°ï¼Œæ ¹æ®å¸¦çš„å¼‚å¸¸å‚æ•°å¯ä»¥è¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo4</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ç”¨ handle æ–¹æ³•æ¥æŠŠè¿™ä¸¤ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//å¼‚å¸¸æƒ…å†µï¼šæœ‰å¼‚å¸¸ä¹Ÿå¯ä»¥å¾€ä¸‹ä¸€æ­¥èµ°ï¼Œæ ¹æ®å¸¦çš„å¼‚å¸¸å‚æ•°å¯ä»¥è¿›ä¸€æ­¥å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;111&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">handle</span><span class="o">((</span><span class="n">f</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">10</span> <span class="o">/</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;222&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">handle</span><span class="o">((</span><span class="n">f</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;333&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">whenCompleteAsync</span><span class="o">((</span><span class="n">v</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*****v: &#34;</span> <span class="o">+</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p>æ— å¼‚å¸¸æƒ…å†µï¼šåŒä¸ŠthenApply</p>
<p>æœ‰å¼‚å¸¸æƒ…å†µï¼š</p>
<blockquote>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>111</p>
<p>333</p>
<p>*****v: null</p>
<p>java.util.concurrent.CompletionException: java.lang.NullPointerException
at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
at java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:838)
at java.util.concurrent.CompletableFuture$UniHandle.tryFire(CompletableFuture.java:811)
at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:488)
at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1609)
at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)
Caused by: java.lang.NullPointerException
at shuo.laoma.concurrent.test.CompletableFutureDemo4.lambda$main$2(CompletableFutureDemo4.java:70)
at java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:836)
&hellip; 8 more</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ¶ˆè´¹">å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ¶ˆè´¹</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">4</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">r</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š10</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">thenRun
</span></span><span class="line"><span class="cl">thenRun(Runnable runnable)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼Œå¹¶ä¸” B ä¸éœ€è¦ A çš„ç»“æœ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">thenAccept
</span></span><span class="line"><span class="cl">thenAccept(Consumer action)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼ŒB éœ€è¦ A çš„ç»“æœï¼Œä½†æ˜¯ä»»åŠ¡ B æ— è¿”å›å€¼
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">thenApply
</span></span><span class="line"><span class="cl">thenApply(Function fn)
</span></span><span class="line"><span class="cl">// ä»»åŠ¡ A æ‰§è¡Œå®Œæ‰§è¡Œ Bï¼ŒB éœ€è¦ A çš„ç»“æœï¼ŒåŒæ—¶ä»»åŠ¡ B æœ‰è¿”å›å€¼
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenRun</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{}).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">resultA</span> <span class="o">-&gt;</span> <span class="o">{}).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&#34;resultA&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">resultA</span> <span class="o">-&gt;</span> <span class="n">resultA</span> <span class="o">+</span> <span class="s">&#34; resultB&#34;</span><span class="o">).</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>null</p>
<p>null</p>
<p>resultA resultB</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨">å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨</h4>
<p>applyToEither: è°å¿«ç”¨è°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo5</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture1</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture2</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">completableFuture1</span><span class="o">.</span><span class="na">applyToEither</span><span class="o">(</span><span class="n">completableFuture2</span><span class="o">,</span> <span class="n">f</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in</p>
<p>main	21</p>
</blockquote>
<h4 id="å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶">å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶</h4>
<p>thenCombine:</p>
<p>ä¸¤ä¸ªCompletionStageä»»åŠ¡éƒ½å®Œæˆåï¼Œæœ€ç»ˆèƒ½æŠŠä¸¤ä¸ªä»»åŠ¡çš„ç»“æœä¸€èµ·äº¤ç»™thenCombineæ¥å¤„ç†</p>
<p>å…ˆå®Œæˆçš„å…ˆç­‰ç€ï¼Œç­‰å¾…å…¶å®ƒåˆ†æ”¯ä»»åŠ¡</p>
<p>codeæ ‡å‡†ç‰ˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture1</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture2</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">completableFuture1</span><span class="o">.</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">completableFuture2</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in</p>
<p>main	&mdash;come in</p>
<p>30</p>
</blockquote>
<p>codeè¡¨è¾¾å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo5</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">thenCombineResult</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}),</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">30</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}),</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="s">&#34;---come in 5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thenCombineResult</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<blockquote>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in 1</p>
<p>ForkJoinPool.commonPool-worker-1	&mdash;come in 2</p>
<p>main	&mdash;come in 3</p>
<p>ForkJoinPool.commonPool-worker-2	&mdash;come in 4</p>
<p>main	&mdash;come in 5</p>
<p>&mdash;&ndash;ä¸»çº¿ç¨‹ç»“æŸï¼ŒEND</p>
<p>60</p>
</blockquote>
<h2 id="é”">é”</h2>
<h3 id="synchronized">synchronized</h3>
<ol>
<li>
<p>ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰å®ä¾‹ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰éœ€è¦å…ˆè·å–å®ä¾‹çš„é”</p>
<p>synchronizedå®ä¾‹æ–¹æ³•å®é™…ä¿æŠ¤çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œç¡®ä¿åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚å†å…·ä½“æ¥è¯´ï¼Œsynchronizedå®ä¾‹æ–¹æ³•ä¿æŠ¤çš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ï¼Œå³this, thiså¯¹è±¡æœ‰ä¸€ä¸ªé”å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œå…¶ä»–è¯•å›¾è·å¾—åŒæ ·é”çš„çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚</p>
<p>ä¸€èˆ¬åœ¨ä¿æŠ¤å˜é‡æ—¶ï¼Œéœ€è¦åœ¨æ‰€æœ‰è®¿é—®è¯¥å˜é‡çš„æ–¹æ³•ä¸ŠåŠ ä¸Šsynchronizedã€‚</p>
</li>
<li>
<p>ä¿®é¥°é™æ€æ–¹æ³•ï¼Œä½œç”¨äºç±»çš„Classå¯¹è±¡ï¼Œè¿›å…¥ä¿®é¥°çš„é™æ€æ–¹æ³•å‰éœ€è¦å…ˆè·å–ç±»çš„Classå¯¹è±¡çš„é”</p>
</li>
<li>
<p>ä¿®é¥°ä»£ç å—ï¼Œéœ€è¦æŒ‡å®šåŠ é”å¯¹è±¡(è®°åšlockobj)ï¼Œåœ¨è¿›å…¥åŒæ­¥ä»£ç å—å‰éœ€è¦å…ˆè·å–lockobjçš„é”</p>
</li>
</ol>
<h4 id="å¯é‡å…¥æ€§">å¯é‡å…¥æ€§</h4>
<p>æ¯ä¸ªé”å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ª<code>é”è®¡æ•°å™¨</code>å’Œä¸€ä¸ª<code>æŒ‡å‘æŒæœ‰è¯¥é”çš„çº¿ç¨‹çš„æŒ‡é’ˆ</code>ã€‚</p>
<p>å½“æ‰§è¡Œmonitorenteræ—¶ï¼Œå¦‚æœç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ºé›¶ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒæ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ‰€æŒæœ‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†è¯¥é”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶è®¡æ•°å™¨åŠ 1ã€‚</p>
<p>åœ¨ç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ä¸ºé›¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºå¯ä»¥å°†å…¶è®¡æ•°å™¨åŠ 1ï¼Œå¦åˆ™éœ€è¦ç­‰å¾…ï¼Œç›´è‡³æŒæœ‰çº¿ç¨‹é‡Šæ”¾è¯¥é”ã€‚</p>
<p>å½“æ‰§è¡Œmonitorexitæ—¶ï¼ŒJavaè™šæ‹Ÿæœºåˆ™éœ€å°†é”å¯¹è±¡çš„è®¡æ•°å™¨å‡1ã€‚è®¡æ•°å™¨ä¸ºé›¶ä»£è¡¨é”å·²è¢«é‡Šæ”¾ã€‚</p>
<h4 id="å†…å­˜å¯è§æ€§">å†…å­˜å¯è§æ€§</h4>
<p>synchronizedé™¤äº†ä¿è¯åŸå­æ“ä½œå¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨ï¼Œå°±æ˜¯ä¿è¯å†…å­˜å¯è§æ€§ï¼Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œæ‰€æœ‰å†™å…¥éƒ½ä¼šå†™å›å†…å­˜ï¼Œè€Œè·å¾—é”åï¼Œéƒ½ä¼šä»å†…å­˜ä¸­è¯»æœ€æ–°æ•°æ®ã€‚</p>
<p>ä¸è¿‡ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†ä¿è¯å†…å­˜å¯è§æ€§ï¼Œä½¿ç”¨synchronizedçš„æˆæœ¬æœ‰ç‚¹é«˜ï¼Œæœ‰ä¸€ä¸ªæ›´è½»é‡çº§çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯ç»™å˜é‡åŠ ä¿®é¥°ç¬¦volatileã€‚</p>
<p>åŠ äº†volatileä¹‹åï¼ŒJavaä¼šåœ¨æ“ä½œå¯¹åº”å˜é‡æ—¶æ’å…¥ç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œä¿è¯è¯»å†™åˆ°å†…å­˜æœ€æ–°å€¼ï¼Œè€Œéç¼“å­˜çš„å€¼ã€‚</p>
<h3 id="lock">Lock</h3>
<p><img src="/image/lock.png" alt="lock"></p>
<p>1ï¼‰lock()/unlock()ï¼šå°±æ˜¯æ™®é€šçš„è·å–é”å’Œé‡Šæ”¾é”æ–¹æ³•ï¼Œlock()ä¼šé˜»å¡ç›´åˆ°æˆåŠŸã€‚</p>
<p>2ï¼‰lockInterruptibly()ï¼šä¸lock()çš„ä¸åŒæ˜¯ï¼Œå®ƒå¯ä»¥å“åº”ä¸­æ–­ï¼Œå¦‚æœè¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­äº†ï¼Œåˆ™æŠ›å‡ºInterruptedExceptionã€‚</p>
<p>3ï¼‰tryLock()ï¼šåªæ˜¯å°è¯•è·å–é”ï¼Œç«‹å³è¿”å›ï¼Œä¸é˜»å¡ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>4ï¼‰tryLock(long time, TimeUnit unit)ï¼šå…ˆå°è¯•è·å–é”ï¼Œå¦‚æœèƒ½æˆåŠŸåˆ™ç«‹å³è¿”å›trueï¼Œå¦åˆ™é˜»å¡ç­‰å¾…ï¼Œä½†ç­‰å¾…çš„æœ€é•¿æ—¶é—´ç”±æŒ‡å®šçš„å‚æ•°è®¾ç½®ï¼Œåœ¨ç­‰å¾…çš„åŒæ—¶å“åº”ä¸­æ–­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœåœ¨ç­‰å¾…çš„æ—¶é—´å†…è·å¾—äº†é”ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<p>5ï¼‰newConditionï¼šæ–°å»ºä¸€ä¸ªæ¡ä»¶ï¼Œä¸€ä¸ªLockå¯ä»¥å…³è”å¤šä¸ªæ¡ä»¶ã€‚</p>
<h3 id="synchronized-vs-lock">synchronized VS Lock</h3>
<ol>
<li>synchronizedæ˜¯javaå†…ç½®å…³é”®å­—ï¼Œåœ¨jvmå±‚é¢ï¼ŒLockæ˜¯ä¸ªjavaç±»ï¼›</li>
<li>synchronizedæ— æ³•åˆ¤æ–­æ˜¯å¦è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼›</li>
<li>synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”(a çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ä¼šé‡Šæ”¾é” ï¼›b çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¼šé‡Šæ”¾é”)ï¼ŒLockéœ€åœ¨finallyä¸­æ‰‹å·¥é‡Šæ”¾é”ï¼ˆunlock()æ–¹æ³•é‡Šæ”¾é”ï¼‰ï¼Œå¦åˆ™å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”ï¼›</li>
<li>ç”¨synchronizedå…³é”®å­—çš„ä¸¤ä¸ªçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œå¦‚æœå½“å‰çº¿ç¨‹1è·å¾—é”ï¼Œçº¿ç¨‹2çº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœçº¿ç¨‹1é˜»å¡ï¼Œçº¿ç¨‹2åˆ™ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œè€ŒLocké”å°±ä¸ä¸€å®šä¼šç­‰å¾…ä¸‹å»ï¼Œå¦‚æœå°è¯•è·å–ä¸åˆ°é”ï¼Œçº¿ç¨‹å¯ä»¥ä¸ç”¨ä¸€ç›´ç­‰å¾…å°±ç»“æŸäº†ï¼›</li>
<li>synchronizedçš„é”å¯é‡å…¥ã€ä¸å¯ä¸­æ–­ã€éå…¬å¹³ï¼Œè€ŒLocké”å¯é‡å…¥ã€å¯åˆ¤æ–­ã€å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰</li>
<li>Locké”é€‚åˆå¤§é‡åŒæ­¥çš„ä»£ç çš„åŒæ­¥é—®é¢˜ï¼Œsynchronizedé”é€‚åˆä»£ç å°‘é‡çš„åŒæ­¥é—®é¢˜ã€‚</li>
</ol>
<h3 id="reentrantlock">ReentrantLock</h3>
<p>ReentrantLockæ˜¯Lockçš„é»˜è®¤å®ç°ï¼š</p>
<ol>
<li>å¯é‡å…¥é”ï¼šå¯é‡å…¥é”æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å¾—åŒä¸€æŠŠé”ï¼›ReentrantLockå’Œå…³é”®å­—Synchronizedéƒ½æ˜¯å¯é‡å…¥é”</li>
<li>å¯ä¸­æ–­é”ï¼šå¯ä¸­æ–­é”æ—¶å­çº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å¯ä»¥ç›¸åº”çº¿ç¨‹ä¸­æ–­æ“ä½œã€‚synchronizedæ˜¯ä¸å¯ä¸­æ–­çš„ï¼ŒReentrantLockæ˜¯å¯ä¸­æ–­çš„</li>
<li>å…¬å¹³é”å’Œéå…¬å¹³é”ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹å°è¯•è·å–åŒä¸€æŠŠé”çš„æ—¶å€™ï¼Œè·å–é”çš„é¡ºåºæŒ‰ç…§çº¿ç¨‹åˆ°è¾¾çš„å…ˆåé¡ºåºè·å–ï¼Œè€Œä¸æ˜¯éšæœºæ’é˜Ÿçš„æ–¹å¼è·å–ã€‚synchronizedæ˜¯éå…¬å¹³é”ï¼Œè€ŒReentrantLockæ˜¯ä¸¤ç§éƒ½å¯ä»¥å®ç°ï¼Œä¸è¿‡é»˜è®¤æ˜¯éå…¬å¹³é”</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Creates an instance of {@code ReentrantLock}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This is equivalent to using {@code ReentrantLock(false)}.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Creates an instance of {@code ReentrantLock} with the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * given fairness policy.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param fair {@code true} if this lock should use a fair ordering policy
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fair</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="n">fair</span> <span class="o">?</span> <span class="k">new</span> <span class="n">FairSync</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="reentrantlockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„">ReentrantLockè·å–é”çš„è¿‡ç¨‹æ˜¯å¯ä¸­æ–­çš„</h3>
<p>å¯¹äºsynchronizedå…³é”®å­—ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…è·å–é”ï¼Œæœ€ç»ˆåªæœ‰2ç§ç»“æœï¼š</p>
<ol>
<li>è¦ä¹ˆè·å–åˆ°é”ç„¶åç»§ç»­åé¢çš„æ“ä½œ</li>
<li>è¦ä¹ˆä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”ä¸ºæ­¢</li>
</ol>
<p>è€ŒReentrantLockæä¾›äº†å¦å¤–ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼ˆ<strong>å‘èµ·è·å–é”è¯·æ±‚åˆ°è¿˜æœªè·å–åˆ°é”è¿™æ®µæ—¶é—´å†…</strong>ï¼‰æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦å–æ¶ˆè·å–é”çš„è¯·æ±‚ã€‚æœ‰äº›ä½¿ç”¨è¿™ä¸ªæ“ä½œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>å…³äºè·å–é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œæ³¨æ„å‡ ç‚¹:</p>
<ol>
<li><strong>ReentrankLockä¸­å¿…é¡»ä½¿ç”¨å®ä¾‹æ–¹æ³•<code>lockInterruptibly()</code>è·å–é”æ—¶ï¼Œåœ¨çº¿ç¨‹è°ƒç”¨interrupt()æ–¹æ³•ä¹‹åï¼Œæ‰ä¼šå¼•å‘<code>InterruptedException</code>å¼‚å¸¸</strong></li>
<li><strong>çº¿ç¨‹è°ƒç”¨interrupt()ä¹‹åï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¼šè¢«ç½®ä¸ºtrue</strong></li>
<li><strong>è§¦å‘InterruptedExceptionå¼‚å¸¸ä¹‹åï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¼šè¢«æ¸…ç©ºï¼Œå³ç½®ä¸ºfalse</strong></li>
<li><strong>æ‰€ä»¥å½“çº¿ç¨‹è°ƒç”¨interrupt()å¼•å‘InterruptedExceptionå¼‚å¸¸ï¼Œä¸­æ–­æ ‡å¿—çš„å˜åŒ–æ˜¯:false-&gt;true-&gt;false</strong></li>
</ol>
<h3 id="synchronized-vs-reentrantlock">synchronized VS ReentrantLock</h3>
<p>ç›¸æ¯”synchronized, ReentrantLockå¯ä»¥å®ç°ä¸synchronizedç›¸åŒçš„è¯­ä¹‰ï¼Œè€Œä¸”æ”¯æŒä»¥éé˜»å¡æ–¹å¼è·å–é”ï¼Œå¯ä»¥å“åº”ä¸­æ–­ï¼Œå¯ä»¥é™æ—¶ï¼Œæ›´ä¸ºçµæ´»ã€‚ä¸è¿‡ï¼Œsynchronizedçš„ä½¿ç”¨æ›´ä¸ºç®€å•ï¼Œå†™çš„ä»£ç æ›´å°‘ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™ã€‚</p>
<p>synchronizedä»£è¡¨ä¸€ç§å£°æ˜å¼ç¼–ç¨‹æ€ç»´ï¼Œç¨‹åºå‘˜æ›´å¤šçš„æ˜¯è¡¨è¾¾ä¸€ç§åŒæ­¥å£°æ˜ï¼Œç”±Javaç³»ç»Ÿè´Ÿè´£å…·ä½“å®ç°ï¼Œç¨‹åºå‘˜ä¸çŸ¥é“å…¶å®ç°ç»†èŠ‚ï¼›æ˜¾å¼é”ä»£è¡¨ä¸€ç§å‘½ä»¤å¼ç¼–ç¨‹æ€ç»´ï¼Œç¨‹åºå‘˜å®ç°æ‰€æœ‰ç»†èŠ‚ã€‚</p>
<p>å£°æ˜å¼ç¼–ç¨‹çš„å¥½å¤„é™¤äº†ç®€å•ï¼Œè¿˜åœ¨äºæ€§èƒ½ï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„JVMä¸Šï¼ŒReentrantLockå’Œsynchronizedçš„æ€§èƒ½æ˜¯æ¥è¿‘çš„ï¼Œä½†Javaç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå¯ä»¥ä¸æ–­ä¼˜åŒ–synchronizedçš„å®ç°ï¼Œæ¯”å¦‚è‡ªåŠ¨åˆ†æsynchronizedçš„ä½¿ç”¨ï¼Œå¯¹äºæ²¡æœ‰é”ç«äº‰çš„åœºæ™¯ï¼Œè‡ªåŠ¨çœç•¥å¯¹é”è·å–/é‡Šæ”¾çš„è°ƒç”¨ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸‹ï¼Œèƒ½ç”¨synchronizedå°±ç”¨synchronizedï¼Œä¸æ»¡è¶³è¦æ±‚æ—¶å†è€ƒè™‘Reentrant-Lockã€‚</p>
<h3 id="æ‚²è§‚é”">æ‚²è§‚é”</h3>
<p>è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚</p>
<p>synchronizedå…³é”®å­—å’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”</p>
<p>é€‚åˆå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œå…ˆåŠ é”å¯ä»¥ä¿è¯å†™æ“ä½œæ—¶æ•°æ®æ­£ç¡®ã€‚</p>
<p>æ˜¾å¼çš„é”å®šä¹‹åå†æ“ä½œåŒæ­¥èµ„æº</p>
<h3 id="ä¹è§‚é”">ä¹è§‚é”</h3>
<p>ä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šæ·»åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ›´æ–°äº†è¿™ä¸ªæ•°æ®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹å°†è‡ªå·±ä¿®æ”¹çš„æ•°æ®æˆåŠŸå†™å…¥ã€‚å¦‚æœæ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼Œåˆ™æ ¹æ®ä¸åŒçš„å®ç°æ–¹å¼æ‰§è¡Œä¸åŒçš„æ“ä½œ</p>
<p>ä¹è§‚é”åœ¨Javaä¸­æ˜¯é€šè¿‡ä½¿ç”¨æ— é”ç¼–ç¨‹æ¥å®ç°ï¼Œæœ€å¸¸é‡‡ç”¨çš„æ˜¯CASç®—æ³•ï¼ŒJavaåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±é€šè¿‡CASè‡ªæ—‹å®ç°çš„ã€‚</p>
<p>é€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¸åŠ é”çš„ç‰¹ç‚¹èƒ½å¤Ÿä½¿å…¶è¯»æ“ä½œçš„æ€§èƒ½å¤§å¹…æå‡ã€‚</p>
<p>ä¹è§‚é”åˆ™ç›´æ¥å»æ“ä½œåŒæ­¥èµ„æºï¼Œæ˜¯ä¸€ç§æ— é”ç®—æ³•ã€‚</p>
<p>ä¹è§‚é”ä¸€èˆ¬æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>é‡‡ç”¨ç‰ˆæœ¬å·æœºåˆ¶</li>
<li>CASï¼ˆCompare-and-Swapï¼Œå³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼‰ç®—æ³•å®ç°</li>
</ol>
<h3 id="å¯é‡å…¥é”åˆåé€’å½’é”">å¯é‡å…¥é”(åˆåé€’å½’é”)</h3>
<p>æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”(å‰æï¼Œé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡)ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚</p>
<p>å¦‚æœæ˜¯1ä¸ªæœ‰ synchronized ä¿®é¥°çš„é€’å½’è°ƒç”¨æ–¹æ³•ï¼Œç¨‹åºç¬¬2æ¬¡è¿›å…¥è¢«è‡ªå·±é˜»å¡äº†å²‚ä¸æ˜¯å¤©å¤§çš„ç¬‘è¯ï¼Œå‡ºç°äº†ä½œèŒ§è‡ªç¼šã€‚æ‰€ä»¥Javaä¸­ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚</p>
<h3 id="æ’æŸ¥æ­»é”">æ’æŸ¥æ­»é”</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jps -l
</span></span><span class="line"><span class="cl">jstack è¿›ç¨‹ç¼–å·
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jmm">JMM</h2>
<p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆjava Memory Modelï¼Œç®€ç§°JMM) æ¥å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚</p>
<p>Javaä¸­æ™®é€šçš„å…±äº«å˜é‡ä¸ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ•°æ®ä¿®æ”¹è¢«å†™å…¥å†…å­˜çš„æ—¶æœºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¤šçº¿ç¨‹å¹¶å‘ä¸‹å¾ˆå¯èƒ½å‡ºç°&quot;è„è¯»&quot;ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œï¼ˆè¯»å–ï¼Œèµ‹å€¼ç­‰ ï¼‰éƒ½å¿…éœ€åœ¨çº¿ç¨‹è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½å¤Ÿç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚ä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p>
<h3 id="jmmè§„èŒƒä¸‹å¤šçº¿ç¨‹å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹happens-before">JMMè§„èŒƒä¸‹ï¼Œå¤šçº¿ç¨‹å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹happens-before</h3>
<p>åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§æ€§æˆ–è€…ä»£ç é‡æ’åºï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»å­˜åœ¨happens-beforeå…³ç³»ã€‚</p>
<h2 id="å€’è®¡æ—¶é—¨æ “countdownlatch">å€’è®¡æ—¶é—¨æ “CountDownLatch</h2>
<p>ä½¿ç”¨joinæ–¹æ³•è®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œjoinå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†waitã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åªè¦çº¿ç¨‹æ˜¯æ´»ç€çš„ï¼ŒisAlive()è¿”å›true, joinå°±ä¸€ç›´ç­‰å¾…ã€‚è°æ¥é€šçŸ¥å®ƒå‘¢ï¼Ÿå½“çº¿ç¨‹è¿è¡Œç»“æŸçš„æ—¶å€™ï¼ŒJavaç³»ç»Ÿè°ƒç”¨notifyAllæ¥é€šçŸ¥ã€‚</p>
<p>ä½¿ç”¨joinæœ‰æ—¶æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ä¸»çº¿ç¨‹é€ä¸€ç­‰å¾…æ¯ä¸ªå­çº¿ç¨‹ã€‚</p>
<h3 id="mylatch">MyLatch</h3>
<p>ä¸»çº¿ç¨‹ä¸å„ä¸ªå­çº¿ç¨‹åä½œçš„å…±äº«å˜é‡æ˜¯ä¸€ä¸ªæ•°ï¼Œè¿™ä¸ªæ•°è¡¨ç¤ºæœªå®Œæˆçš„çº¿ç¨‹ä¸ªæ•°ï¼Œåˆå§‹å€¼ä¸ºå­çº¿ç¨‹ä¸ªæ•°ï¼Œä¸»çº¿ç¨‹ç­‰å¾…è¯¥å€¼å˜ä¸º0ï¼Œè€Œæ¯ä¸ªå­çº¿ç¨‹ç»“æŸåéƒ½å°†è¯¥å€¼å‡ä¸€ï¼Œå½“å‡ä¸º0æ—¶è°ƒç”¨notifyAllï¼Œä½¿ç”¨MyLatchæ¥è¡¨ç¤ºè¿™ä¸ªåä½œå¯¹è±¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLatch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">MyLatch</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MyLatchæ„é€ æ–¹æ³•çš„å‚æ•°countåº”åˆå§‹åŒ–ä¸ºå­çº¿ç¨‹çš„ä¸ªæ•°ï¼Œä¸»çº¿ç¨‹åº”è¯¥è°ƒç”¨await()ï¼Œè€Œå­çº¿ç¨‹åœ¨æ‰§è¡Œå®Œååº”è¯¥è°ƒç”¨countDown()ã€‚</p>
<p>ä½¿ç”¨MyLatchçš„å·¥ä½œå­çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyLatch</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">MyLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// simulate working on task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="n">1000</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">workerNum</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyLatch</span><span class="o">(</span><span class="n">workerNum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Worker</span><span class="o">[]</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">[</span><span class="n">workerNum</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">workerNum</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">workers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">latch</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">workers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;collect worker results&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MyLatchæ˜¯ä¸€ä¸ªç”¨äºåŒæ­¥åä½œçš„å·¥å…·ç±»ï¼Œä¸»è¦ç”¨äºæ¼”ç¤ºåŸºæœ¬åŸç†ï¼Œåœ¨Javaä¸­æœ‰ä¸€ä¸ªä¸“é—¨çš„åŒæ­¥ç±»CountDownLatchï¼Œåœ¨å®é™…å¼€å‘ä¸­åº”è¯¥ä½¿ç”¨å®ƒã€‚</p>
<p>MyLatchçš„åŠŸèƒ½æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œå®ƒä¹Ÿå¯ä»¥åº”ç”¨äºä¸Šé¢â€œåŒæ—¶å¼€å§‹â€çš„åœºæ™¯ï¼Œåˆå§‹å€¼è®¾ä¸º1, Racerç±»è°ƒç”¨await()ï¼Œä¸»çº¿ç¨‹è°ƒç”¨countDown()å³å¯ã€‚</p>
<p>ä½¿ç”¨MyLatchå®ç°åŒæ—¶å¼€å§‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RacerWithLatchDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Racer</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyLatch</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Racer</span><span class="o">(</span><span class="n">MyLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;start run &#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyLatch</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">[]</span> <span class="n">racers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">[</span><span class="n">num</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">racers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Racer</span><span class="o">(</span><span class="n">latch</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">racers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="countdownlatch">CountDownLatch</h3>
<p>CountDownLatchç›¸å½“äºæ˜¯ä¸€ä¸ªé—¨æ “ï¼Œä¸€å¼€å§‹æ˜¯å…³é—­çš„ï¼Œæ‰€æœ‰å¸Œæœ›é€šè¿‡è¯¥é—¨çš„çº¿ç¨‹éƒ½éœ€è¦ç­‰å¾…ï¼Œç„¶åå¼€å§‹å€’è®¡æ—¶ï¼Œå€’è®¡æ—¶å˜ä¸º0åï¼Œé—¨æ “æ‰“å¼€ï¼Œç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥é€šè¿‡ï¼Œå®ƒæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæ‰“å¼€åå°±ä¸èƒ½å†å…³ä¸Šäº†ã€‚</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Anjana</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-08-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a href="https://github.com/gohugoio/hugoBasicExample" rel="noopener" target="_blank">See origin</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://anjanavakil.github.io/tags/cs/">CSğŸ’»</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/sql/">
            <span class="next-text nav-default">SQL</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:anjana.cheng@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/AnjanaVakil" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/188748525/?_i=5959211pTN39WJ,5959254pTN39WJ" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://anjanavakil.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2021 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Anjana
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
